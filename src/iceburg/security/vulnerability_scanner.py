"""
Vulnerability Scanner
Scans for security vulnerabilities
"""

from typing import Any, Dict, Optional, List
import re
import subprocess


class VulnerabilityScanner:
    """Scans for security vulnerabilities"""
    
    def __init__(self):
        self.scan_results: List[Dict[str, Any]] = []
    
    def scan_code(
        self,
        code: str,
        language: str = "python"
    ) -> Dict[str, Any]:
        """Scan code for vulnerabilities"""
        vulnerabilities = []
        
        # SQL Injection
        sql_patterns = [
            r"SELECT.*\+.*request",
            r"INSERT.*\+.*request",
            r"DELETE.*\+.*request",
            r"UPDATE.*\+.*request"
        ]
        for pattern in sql_patterns:
            if re.search(pattern, code, re.IGNORECASE):
                vulnerabilities.append({
                    "type": "sql_injection",
                    "severity": "high",
                    "description": "Potential SQL injection vulnerability",
                    "pattern": pattern
                })
        
        # Command Injection
        cmd_patterns = [
            r"os\.system\(",
            r"subprocess\.call\(",
            r"subprocess\.Popen\(",
            r"eval\(",
            r"exec\("
        ]
        for pattern in cmd_patterns:
            if re.search(pattern, code):
                vulnerabilities.append({
                    "type": "command_injection",
                    "severity": "high",
                    "description": "Potential command injection vulnerability",
                    "pattern": pattern
                })
        
        # XSS
        xss_patterns = [
            r"innerHTML\s*=",
            r"document\.write\(",
            r"\.html\("
        ]
        for pattern in xss_patterns:
            if re.search(pattern, code):
                vulnerabilities.append({
                    "type": "xss",
                    "severity": "medium",
                    "description": "Potential XSS vulnerability",
                    "pattern": pattern
                })
        
        # Hardcoded Credentials
        credential_patterns = [
            r"password\s*=\s*['\"][^'\"]+['\"]",
            r"api_key\s*=\s*['\"][^'\"]+['\"]",
            r"secret\s*=\s*['\"][^'\"]+['\"]"
        ]
        for pattern in credential_patterns:
            if re.search(pattern, code, re.IGNORECASE):
                vulnerabilities.append({
                    "type": "hardcoded_credentials",
                    "severity": "high",
                    "description": "Potential hardcoded credentials",
                    "pattern": pattern
                })
        
        # Insecure Random
        if re.search(r"random\.randint|random\.choice", code):
            vulnerabilities.append({
                "type": "insecure_random",
                "severity": "medium",
                "description": "Use of insecure random number generator",
                "pattern": "random"
            })
        
        return {
            "code_length": len(code),
            "language": language,
            "vulnerabilities": vulnerabilities,
            "vulnerability_count": len(vulnerabilities),
            "high_severity_count": len([v for v in vulnerabilities if v["severity"] == "high"])
        }
    
    def scan_network(
        self,
        target: str,
        ports: Optional[List[int]] = None
    ) -> Dict[str, Any]:
        """Scan network for vulnerabilities"""
        if not ports:
            ports = [22, 80, 443, 8080, 3306, 5432]
        
        vulnerabilities = []
        
        # Check for open ports
        for port in ports:
            try:
                import socket
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(1)
                result = sock.connect_ex((target, port))
                sock.close()
                
                if result == 0:
                    # Check for known vulnerabilities
                    vuln = self._check_port_vulnerability(port)
                    if vuln:
                        vulnerabilities.append(vuln)
            except Exception:
                pass
        
        return {
            "target": target,
            "ports_scanned": ports,
            "vulnerabilities": vulnerabilities,
            "vulnerability_count": len(vulnerabilities)
        }
    
    def _check_port_vulnerability(self, port: int) -> Optional[Dict[str, Any]]:
        """Check for known vulnerabilities on port"""
        known_vulns = {
            22: {
                "type": "ssh_weak_config",
                "severity": "medium",
                "description": "SSH port open - check for weak configuration"
            },
            3306: {
                "type": "mysql_exposed",
                "severity": "high",
                "description": "MySQL port exposed - ensure proper authentication"
            },
            5432: {
                "type": "postgres_exposed",
                "severity": "high",
                "description": "PostgreSQL port exposed - ensure proper authentication"
            }
        }
        
        return known_vulns.get(port)
    
    def scan_dependencies(
        self,
        requirements_file: str
    ) -> Dict[str, Any]:
        """Scan dependencies for known vulnerabilities"""
        vulnerabilities = []
        
        try:
            with open(requirements_file, 'r') as f:
                dependencies = f.readlines()
            
            # Check for known vulnerable packages
            vulnerable_packages = {
                "django": ["<2.2.0"],
                "flask": ["<1.1.0"],
                "requests": ["<2.25.0"]
            }
            
            for dep in dependencies:
                for pkg, versions in vulnerable_packages.items():
                    if pkg in dep.lower():
                        for version in versions:
                            if version in dep:
                                vulnerabilities.append({
                                    "type": "vulnerable_dependency",
                                    "severity": "high",
                                    "package": pkg,
                                    "description": f"Vulnerable version of {pkg} detected"
                                })
        except Exception:
            pass
        
        return {
            "requirements_file": requirements_file,
            "vulnerabilities": vulnerabilities,
            "vulnerability_count": len(vulnerabilities)
        }
    
    def get_scan_summary(self) -> Dict[str, Any]:
        """Get summary of all scans"""
        total_vulns = sum(len(r.get("vulnerabilities", [])) for r in self.scan_results)
        high_severity = sum(
            len([v for v in r.get("vulnerabilities", []) if v.get("severity") == "high"])
            for r in self.scan_results
        )
        
        return {
            "total_scans": len(self.scan_results),
            "total_vulnerabilities": total_vulns,
            "high_severity_vulnerabilities": high_severity,
            "scans": self.scan_results
        }


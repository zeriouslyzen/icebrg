<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COLOSSUS | Intelligence Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-void: #000000;
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-elevated: #222222;
            --border-subtle: #2a2a2a;
            --border-medium: #333333;
            --border-strong: #444444;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #707070;
            --text-muted: #505050;
            --accent: #ffffff;
            --accent-dim: rgba(255, 255, 255, 0.1);
            --critical: #ff3b30;
            --warning: #ff9500;
            --success: #34c759;
            --info: #5ac8fa;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: var(--font-sans);
            background: var(--bg-void);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== LAYOUT ===== */
        .app-container {
            display: grid;
            grid-template-rows: 48px 1fr 32px;
            height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-mark {
            width: 24px;
            height: 24px;
            background: var(--text-primary);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }

        .logo-text {
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 3px;
            color: var(--text-primary);
        }

        .nav-tabs {
            display: flex;
            gap: 2px;
        }

        .nav-tab {
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
        }

        .nav-tab.active {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        /* Search */
        .search-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input {
            width: 320px;
            padding: 8px 12px;
            font-family: var(--font-mono);
            font-size: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            outline: none;
            transition: all 0.15s;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            border-color: var(--border-strong);
            background: var(--bg-tertiary);
        }

        .search-btn {
            padding: 8px 16px;
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--text-primary);
            color: var(--bg-void);
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .search-btn:hover {
            background: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 360px;
            overflow: hidden;
        }

        /* ===== LEFT PANEL ===== */
        .panel-left {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-tertiary);
        }

        .panel-content {
            padding: 12px 16px;
        }

        /* Entity Card */
        .entity-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            padding: 16px;
        }

        .entity-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .entity-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .entity-id {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .entity-type-badge {
            padding: 4px 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
        }

        .entity-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--border-subtle);
            border: 1px solid var(--border-subtle);
            margin-bottom: 16px;
        }

        .metric-item {
            background: var(--bg-primary);
            padding: 12px 8px;
            text-align: center;
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Risk Level */
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
        }

        .risk-level {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .risk-critical {
            color: var(--critical);
        }

        .risk-high {
            color: var(--warning);
        }

        .risk-medium {
            color: var(--text-secondary);
        }

        .risk-low {
            color: var(--success);
        }

        .risk-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-elevated);
            position: relative;
        }

        .risk-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .risk-score {
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Connection List */
        .connection-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.1s;
        }

        .connection-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-medium);
        }

        .connection-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
        }

        .connection-info {
            flex: 1;
            min-width: 0;
        }

        .connection-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .connection-type {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .connection-meta {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
        }

        /* ===== GRAPH CANVAS ===== */
        .graph-container {
            position: relative;
            background: var(--bg-secondary);
            overflow: hidden;
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
        }

        /* Graph overlays */
        .graph-controls {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 500;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.1s;
        }

        .control-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-medium);
        }

        .graph-info {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 16px;
            padding: 10px 14px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--border-subtle);
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .info-value {
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Legend */
        .graph-legend {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--border-subtle);
            padding: 12px 16px;
        }

        .legend-title {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* ===== RIGHT PANEL ===== */
        .panel-right {
            background: var(--bg-primary);
            border-left: 1px solid var(--border-subtle);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Path Finder */
        .pathfinder {
            padding: 16px;
        }

        .pathfinder-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .pathfinder-input {
            width: 100%;
            padding: 10px 12px;
            font-family: var(--font-mono);
            font-size: 11px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            outline: none;
        }

        .pathfinder-input:focus {
            border-color: var(--border-strong);
        }

        .pathfinder-btn {
            width: 100%;
            padding: 10px;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            background: var(--text-primary);
            color: var(--bg-void);
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .pathfinder-btn:hover {
            background: var(--text-secondary);
        }

        /* Path Result */
        .path-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
        }

        .path-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .path-hops {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
        }

        .path-nodes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .path-node {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .path-connector {
            width: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .path-line {
            width: 1px;
            height: 20px;
            background: var(--border-medium);
        }

        .path-arrow {
            font-size: 8px;
            color: var(--text-muted);
        }

        .path-entity {
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-left: 2px solid var(--border-medium);
        }

        .path-entity-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .path-relation {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Depth Control */
        .depth-control {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .depth-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .depth-value {
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .depth-slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-elevated);
            outline: none;
        }

        .depth-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            cursor: pointer;
        }

        .depth-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            cursor: pointer;
            border: none;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .data-table th {
            text-align: left;
            padding: 8px 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .data-table tr:hover td {
            background: var(--bg-secondary);
        }

        /* ===== FOOTER ===== */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-subtle);
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
        }

        .footer-left,
        .footer-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .footer-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== NODE STYLING ===== */
        .node {
            cursor: pointer;
        }

        .node circle {
            transition: all 0.15s;
        }

        .node:hover circle {
            stroke-width: 3px;
        }

        .node.selected circle {
            stroke: var(--text-primary);
            stroke-width: 3px;
        }

        .node text {
            font-family: var(--font-mono);
            font-size: 9px;
            fill: var(--text-secondary);
            text-anchor: middle;
            pointer-events: none;
        }

        .link {
            fill: none;
            stroke: var(--border-medium);
            stroke-opacity: 0.5;
        }

        .link.highlighted {
            stroke: var(--text-primary);
            stroke-opacity: 1;
            stroke-width: 2px;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 48px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-primary);
            opacity: 0;
            transition: all 0.2s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== LOADING ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-medium);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-medium);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-strong);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-mark"></div>
                    <span class="logo-text">COLOSSUS</span>
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active">GRAPH</button>
                    <button class="nav-tab" onclick="location.href='/matrix'">ENTITIES</button>
                    <button class="nav-tab" onclick="location.href='/entity'">SEARCH</button>
                    <button class="nav-tab">INVESTIGATIONS</button>
                </nav>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ENTITY SEARCH">
                <button class="search-btn" onclick="executeSearch()">QUERY</button>
            </div>
            <div class="header-right">
                <div class="system-status">
                    <div class="status-indicator"></div>
                    <span>SYSTEM OPERATIONAL</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel -->
            <aside class="panel-left">
                <div class="panel-section" id="entitySection" style="display: none;">
                    <div class="panel-header">
                        <span class="panel-title">SELECTED ENTITY</span>
                    </div>
                    <div class="panel-content">
                        <div class="entity-card" id="entityCard">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="panel-section" id="connectionsSection" style="display: none;">
                    <div class="panel-header">
                        <span class="panel-title">NETWORK CONNECTIONS</span>
                        <span class="panel-title" id="connectionCount">0</span>
                    </div>
                    <div class="panel-content">
                        <div class="connection-list" id="connectionsList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-header">
                        <span class="panel-title">HIGH CENTRALITY NODES</span>
                    </div>
                    <div class="panel-content">
                        <div class="connection-list" id="centralEntities">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>LOADING</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Graph Canvas -->
            <div class="graph-container">
                <svg class="graph-canvas" id="graph"></svg>

                <div class="graph-controls">
                    <button class="control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                    <button class="control-btn" onclick="zoomOut()" title="Zoom Out">-</button>
                    <button class="control-btn" onclick="resetView()" title="Reset">R</button>
                    <button class="control-btn" onclick="toggleLabels()" title="Labels">L</button>
                </div>

                <div class="graph-info" id="graphInfo">
                    <div class="info-item">
                        <span class="info-label">NODES</span>
                        <span class="info-value" id="nodeCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">EDGES</span>
                        <span class="info-value" id="edgeCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">DEPTH</span>
                        <span class="info-value" id="currentDepth">2</span>
                    </div>
                </div>

                <div class="graph-legend">
                    <div class="legend-title">NODE CLASSIFICATION</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #ffffff;"></div>
                            <span>PERSON</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #888888;"></div>
                            <span>COMPANY</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #555555;"></div>
                            <span>ORGANIZATION</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #ff3b30;"></div>
                            <span>SANCTIONED</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <aside class="panel-right">
                <div class="panel-section">
                    <div class="panel-header">
                        <span class="panel-title">PATH ANALYSIS</span>
                    </div>
                    <div class="pathfinder">
                        <div class="pathfinder-inputs">
                            <input type="text" class="pathfinder-input" id="pathSource" placeholder="SOURCE ENTITY">
                            <input type="text" class="pathfinder-input" id="pathTarget" placeholder="TARGET ENTITY">
                        </div>
                        <button class="pathfinder-btn" onclick="findPath()">CALCULATE PATH</button>
                        <div id="pathResult"></div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-header">
                        <span class="panel-title">NETWORK DEPTH</span>
                    </div>
                    <div class="depth-control">
                        <div class="depth-header">
                            <span class="panel-title">TRAVERSAL HOPS</span>
                            <span class="depth-value" id="depthValue">2</span>
                        </div>
                        <input type="range" class="depth-slider" id="depthSlider" min="1" max="4" value="2"
                            onchange="updateDepth(this.value)">
                    </div>
                </div>

                <div class="panel-section" id="riskSection" style="display: none;">
                    <div class="panel-header">
                        <span class="panel-title">RISK ASSESSMENT</span>
                    </div>
                    <div class="panel-content" id="riskContent">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-header">
                        <span class="panel-title">SANCTIONS LIST</span>
                    </div>
                    <div class="panel-content" id="sanctionsList">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>LIST</th>
                                    <th>DATE</th>
                                </tr>
                            </thead>
                            <tbody id="sanctionsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-left">
                <span class="footer-item">COLOSSUS INTELLIGENCE PLATFORM v2.0</span>
                <span class="footer-item">CLASSIFICATION: INTERNAL</span>
            </div>
            <div class="footer-right">
                <span class="footer-item" id="timestamp"></span>
                <span class="footer-item">SESSION: <span id="sessionId"></span></span>
            </div>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_BASE = '/api/colossus';
        let currentNetwork = null;
        let selectedEntity = null;
        let networkDepth = 2;
        let showLabels = true;

        // D3 elements
        let svg, g, simulation, link, node, zoom;

        // Color scheme (monochromatic)
        const typeColors = {
            'person': '#ffffff',
            'company': '#888888',
            'organization': '#555555',
            'legal_entity': '#666666',
            'unknown': '#444444'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initGraph();
            loadCentralEntities();
            updateTimestamp();
            generateSessionId();

            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') executeSearch();
            });

            const params = new URLSearchParams(window.location.search);
            if (params.get('id')) {
                loadEntityNetwork(params.get('id'));
            }

            setInterval(updateTimestamp, 1000);
        });

        function initGraph() {
            const container = document.querySelector('.graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select('#graph')
                .attr('width', width)
                .attr('height', height);

            // Define arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-5 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M-5,-3L0,0L-5,3')
                .attr('fill', '#444');

            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => g.attr('transform', event.transform));

            svg.call(zoom);
            g = svg.append('g');

            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(50));
        }

        async function executeSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            try {
                const response = await fetch(`${API_BASE}/entities/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 10 })
                });
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    loadEntityNetwork(data.results[0].id);
                } else {
                    showToast('NO RESULTS FOUND');
                }
            } catch (error) {
                console.error('Search failed:', error);
                showToast('QUERY FAILED');
            }
        }

        async function loadEntityNetwork(entityId) {
            try {
                const response = await fetch(`${API_BASE}/network`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_id: entityId,
                        depth: networkDepth,
                        limit: 150
                    })
                });
                const data = await response.json();

                currentNetwork = data;
                renderNetwork(data, entityId);
                loadEntityDetails(entityId);

                window.history.pushState({}, '', `?id=${entityId}`);
            } catch (error) {
                console.error('Network load failed:', error);
                showToast('NETWORK LOAD FAILED');
            }
        }

        function renderNetwork(network, centerId) {
            g.selectAll('*').remove();

            const nodes = network.nodes || [];
            const edges = network.edges || [];

            document.getElementById('nodeCount').textContent = nodes.length;
            document.getElementById('edgeCount').textContent = edges.length;

            // Links
            link = g.append('g')
                .selectAll('line')
                .data(edges)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', 1)
                .attr('marker-end', 'url(#arrowhead)');

            // Nodes
            node = g.append('g')
                .selectAll('.node')
                .data(nodes)
                .join('g')
                .attr('class', d => `node ${d.id === centerId ? 'selected' : ''}`)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('click', (event, d) => selectNode(d))
                .on('dblclick', (event, d) => loadEntityNetwork(d.id));

            // Node circles
            node.append('circle')
                .attr('r', d => d.id === centerId ? 16 : (d.sanctions_count > 0 ? 12 : 10))
                .attr('fill', d => d.sanctions_count > 0 ? '#ff3b30' : (typeColors[d.type] || typeColors.unknown))
                .attr('stroke', '#1a1a1a')
                .attr('stroke-width', 2);

            // Labels
            if (showLabels) {
                node.append('text')
                    .attr('dy', 24)
                    .text(d => truncate(d.name, 18))
                    .style('display', d => d.id === centerId || d.sanctions_count > 0 ? 'block' : 'none');
            }

            // Simulation
            simulation.nodes(nodes).on('tick', ticked);
            simulation.force('link').links(edges);
            simulation.alpha(1).restart();

            function ticked() {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            }
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        async function loadEntityDetails(entityId) {
            try {
                const response = await fetch(`${API_BASE}/entities/${entityId}`);
                const entity = await response.json();

                selectedEntity = entity;

                document.getElementById('entitySection').style.display = 'block';

                const sanctionsCount = entity.sanctions?.length || 0;
                const riskLevel = sanctionsCount > 5 ? 'CRITICAL' :
                    sanctionsCount > 2 ? 'HIGH' :
                        sanctionsCount > 0 ? 'MEDIUM' : 'LOW';
                const riskScore = Math.min(100, sanctionsCount * 12 + 15);
                const riskClass = riskLevel.toLowerCase();

                document.getElementById('entityCard').innerHTML = `
                    <div class="entity-header">
                        <div>
                            <div class="entity-name">${entity.name}</div>
                            <div class="entity-id">${entity.id}</div>
                        </div>
                        <span class="entity-type-badge">${entity.type}</span>
                    </div>
                    <div class="entity-metrics">
                        <div class="metric-item">
                            <div class="metric-value">${sanctionsCount}</div>
                            <div class="metric-label">SANCTIONS</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${entity.relationships?.length || 0}</div>
                            <div class="metric-label">RELATIONS</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${entity.countries?.length || 0}</div>
                            <div class="metric-label">COUNTRIES</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${entity.sources?.length || 0}</div>
                            <div class="metric-label">SOURCES</div>
                        </div>
                    </div>
                    <div class="risk-indicator">
                        <span class="risk-level risk-${riskClass}">${riskLevel}</span>
                        <div class="risk-bar">
                            <div class="risk-bar-fill" style="width: ${riskScore}%; background: ${riskScore > 70 ? '#ff3b30' : riskScore > 40 ? '#ff9500' : '#34c759'};"></div>
                        </div>
                        <span class="risk-score">${riskScore}</span>
                    </div>
                `;

                // Connections
                if (entity.relationships && entity.relationships.length > 0) {
                    document.getElementById('connectionsSection').style.display = 'block';
                    document.getElementById('connectionCount').textContent = entity.relationships.length;

                    document.getElementById('connectionsList').innerHTML = entity.relationships
                        .slice(0, 15)
                        .map(rel => `
                            <div class="connection-item" onclick="loadEntityNetwork('${rel.target}')">
                                <div class="connection-icon">${rel.type.charAt(0)}</div>
                                <div class="connection-info">
                                    <div class="connection-name">${rel.target}</div>
                                    <div class="connection-type">${rel.type}</div>
                                </div>
                                <div class="connection-meta">${(rel.confidence * 100).toFixed(0)}%</div>
                            </div>
                        `).join('');
                }

                // Sanctions table
                if (entity.sanctions && entity.sanctions.length > 0) {
                    document.getElementById('sanctionsTableBody').innerHTML = entity.sanctions
                        .map(s => `
                            <tr>
                                <td>${s.toUpperCase()}</td>
                                <td>--</td>
                            </tr>
                        `).join('');
                }

                document.getElementById('pathSource').value = entity.name;

            } catch (error) {
                console.error('Entity load failed:', error);
            }
        }

        function selectNode(d) {
            node.classed('selected', false);
            node.filter(n => n.id === d.id).classed('selected', true);
            loadEntityDetails(d.id);
        }

        async function loadCentralEntities() {
            try {
                const response = await fetch(`${API_BASE}/central?measure=degree&limit=12`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    document.getElementById('centralEntities').innerHTML = data.results
                        .map(entity => `
                            <div class="connection-item" onclick="loadEntityNetwork('${entity.id}')">
                                <div class="connection-icon">${entity.type.charAt(0).toUpperCase()}</div>
                                <div class="connection-info">
                                    <div class="connection-name">${truncate(entity.name, 24)}</div>
                                    <div class="connection-type">${entity.type.toUpperCase()}</div>
                                </div>
                                <div class="connection-meta">${entity.score.toFixed(0)}</div>
                            </div>
                        `).join('');
                } else {
                    document.getElementById('centralEntities').innerHTML = `
                        <div style="color: var(--text-muted); font-size: 11px; padding: 8px 0;">
                            NO DATA AVAILABLE
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('centralEntities').innerHTML = `
                    <div style="color: var(--text-muted); font-size: 11px; padding: 8px 0;">
                        CONNECTION FAILED
                    </div>
                `;
            }
        }

        async function findPath() {
            const source = document.getElementById('pathSource').value.trim();
            const target = document.getElementById('pathTarget').value.trim();

            if (!source || !target) {
                showToast('SPECIFY BOTH ENTITIES');
                return;
            }

            try {
                const [sourceRes, targetRes] = await Promise.all([
                    fetch(`${API_BASE}/entities/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: source, limit: 1 })
                    }),
                    fetch(`${API_BASE}/entities/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: target, limit: 1 })
                    })
                ]);

                const sourceData = await sourceRes.json();
                const targetData = await targetRes.json();

                if (!sourceData.results?.length || !targetData.results?.length) {
                    document.getElementById('pathResult').innerHTML = `
                        <div class="path-result" style="color: var(--text-muted);">
                            ENTITY NOT FOUND
                        </div>
                    `;
                    return;
                }

                const pathRes = await fetch(`${API_BASE}/path`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: sourceData.results[0].id,
                        target_id: targetData.results[0].id,
                        max_hops: 6
                    })
                });
                const pathData = await pathRes.json();

                if (pathData.found) {
                    let pathHtml = `
                        <div class="path-result">
                            <div class="path-header">
                                <span class="panel-title">PATH FOUND</span>
                                <span class="path-hops">${pathData.hops} HOPS</span>
                            </div>
                            <div class="path-nodes">
                    `;

                    pathData.path.forEach((step, i) => {
                        pathHtml += `
                            <div class="path-node">
                                <div class="path-connector">
                                    ${i > 0 ? '<div class="path-line"></div><div class="path-arrow">V</div>' : ''}
                                </div>
                                <div class="path-entity">
                                    <div class="path-entity-name">${step.entity.name}</div>
                                    ${step.relationship ? `<div class="path-relation">${step.relationship.type || 'CONNECTED'}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });

                    pathHtml += '</div></div>';
                    document.getElementById('pathResult').innerHTML = pathHtml;

                    highlightPath(pathData.path);
                } else {
                    document.getElementById('pathResult').innerHTML = `
                        <div class="path-result" style="color: var(--text-muted);">
                            NO CONNECTION WITHIN 6 HOPS
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Path calculation failed:', error);
                showToast('PATH CALCULATION FAILED');
            }
        }

        function highlightPath(path) {
            node.select('circle').attr('stroke', '#1a1a1a').attr('stroke-width', 2);
            link.classed('highlighted', false);

            const pathIds = path.map(p => p.entity.id);
            node.filter(d => pathIds.includes(d.id))
                .select('circle')
                .attr('stroke', '#ffffff')
                .attr('stroke-width', 3);
        }

        function updateDepth(value) {
            networkDepth = parseInt(value);
            document.getElementById('depthValue').textContent = value;
            document.getElementById('currentDepth').textContent = value;

            if (selectedEntity) {
                loadEntityNetwork(selectedEntity.id);
            }
        }

        function zoomIn() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.4);
        }

        function zoomOut() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.7);
        }

        function resetView() {
            svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
        }

        function toggleLabels() {
            showLabels = !showLabels;
            node.selectAll('text').style('display', showLabels ? 'block' : 'none');
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function updateTimestamp() {
            const now = new Date();
            const timestamp = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
            document.getElementById('timestamp').textContent = timestamp;
        }

        function generateSessionId() {
            const id = Math.random().toString(36).substring(2, 10).toUpperCase();
            document.getElementById('sessionId').textContent = id;
        }
    </script>
</body>

</html>
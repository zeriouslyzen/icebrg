<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICEBURG Dossier - Deep Research Protocol</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        /* Dossier-specific styles */
        .dossier-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dossier-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(30, 30, 50, 0.9));
            border-radius: 16px;
            border: 1px solid rgba(100, 150, 255, 0.3);
        }

        .dossier-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #4a9eff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .dossier-header .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }

        .query-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .query-input {
            flex: 1;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }

        .query-input:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }

        .depth-select {
            padding: 1rem;
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 8px;
            color: white;
            min-width: 150px;
        }

        .generate-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #4a9eff, #00ff88);
            border: none;
            border-radius: 8px;
            color: black;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(74, 158, 255, 0.5);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            margin-bottom: 2rem;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .progress-step.active {
            color: #4a9eff;
        }

        .progress-step.complete {
            color: #00ff88;
        }

        .progress-icon {
            font-size: 1.5rem;
        }

        .dossier-content {
            display: none;
        }

        .dossier-content.active {
            display: block;
        }

        .dossier-section {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dossier-section h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #4a9eff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .dossier-section h2 .icon {
            font-size: 1.5rem;
        }

        .dossier-section p {
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.9);
        }

        .players-table {
            width: 100%;
            border-collapse: collapse;
        }

        .players-table th,
        .players-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .players-table th {
            color: #4a9eff;
            font-weight: 600;
        }

        .players-table tr:hover {
            background: rgba(74, 158, 255, 0.1);
        }

        .network-graph {
            width: 100%;
            height: 500px;
            background: rgba(10, 10, 20, 0.8);
            border-radius: 8px;
            overflow: hidden;
        }

        .network-graph svg {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.3s ease;
        }

        .node:hover circle {
            stroke-width: 4px;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .node text {
            font-size: 10px;
            fill: white;
            pointer-events: none;
        }

        .link {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 1.5px;
        }

        .contradiction-card {
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .contradiction-card .topic {
            color: #ff6464;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .contradiction-card .mainstream {
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .contradiction-card .mainstream::before {
            content: "üì∞ Mainstream: ";
            color: rgba(255, 255, 255, 0.5);
        }

        .contradiction-card .alternative {
            padding: 0.5rem;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 4px;
        }

        .contradiction-card .alternative::before {
            content: "üîç Alternative: ";
            color: #00ff88;
        }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .symbol-card {
            background: rgba(100, 50, 150, 0.2);
            border: 1px solid rgba(150, 100, 200, 0.3);
            border-radius: 8px;
            padding: 1rem;
        }

        .symbol-card .symbol-name {
            color: #c084fc;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .symbol-card .meaning {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .hidden-connection {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .hidden-connection .entities {
            color: #ffa500;
            font-weight: bold;
        }

        .hidden-connection .via {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .confidence-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .confidence-badge.high {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .confidence-badge.medium {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
        }

        .confidence-badge.low {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .source-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .source-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .source-item a {
            color: #4a9eff;
            text-decoration: none;
        }

        .source-item a:hover {
            text-decoration: underline;
        }

        .source-type {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-left: 0.5rem;
        }

        .metadata-bar {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metadata-value {
            color: #4a9eff;
            font-weight: bold;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>

<body class="dark-mode">
    <nav class="main-nav">
        <div class="nav-brand">
            <a href="index.html">üßä ICEBURG</a>
        </div>
        <div class="nav-links">
            <a href="index.html">Chat</a>
            <a href="encyclopedia.html">Encyclopedia</a>
            <a href="dossier.html" class="active">Dossier</a>
            <a href="protocols.html">Protocols</a>
            <a href="admin.html">Admin</a>
        </div>
    </nav>

    <main class="dossier-container">
        <div class="dossier-header">
            <h1>üîç ICEBURG DOSSIER</h1>
            <p class="subtitle">Deep Research Protocol ‚Äî Multi-source intelligence gathering, network mapping, and
                esoteric analysis</p>
        </div>

        <div class="query-section">
            <input type="text" class="query-input" id="dossierQuery"
                placeholder="Enter your research topic (e.g., 'Why does Trump want Greenland?')">
            <select class="depth-select" id="depthSelect">
                <option value="quick">Quick (1-2 min)</option>
                <option value="standard" selected>Standard (3-5 min)</option>
                <option value="deep">Deep (5-10 min)</option>
            </select>
            <button class="generate-btn" id="generateBtn" onclick="generateDossier()">
                Generate Dossier
            </button>
        </div>

        <div class="progress-section" id="progressSection">
            <h3 style="margin-bottom: 1rem; color: white;">Generating Dossier...</h3>
            <div class="progress-step" id="step1">
                <span class="progress-icon">üì°</span>
                <span>Phase 1: Gathering multi-source intelligence...</span>
            </div>
            <div class="progress-step" id="step2">
                <span class="progress-icon">üîÆ</span>
                <span>Phase 2: Decoding symbols and patterns...</span>
            </div>
            <div class="progress-step" id="step3">
                <span class="progress-icon">üó∫Ô∏è</span>
                <span>Phase 3: Mapping network relationships...</span>
            </div>
            <div class="progress-step" id="step4">
                <span class="progress-icon">üìù</span>
                <span>Phase 4: Synthesizing final dossier...</span>
            </div>
        </div>

        <div class="dossier-content" id="dossierContent">
            <!-- Dossier content will be rendered here -->
        </div>
    </main>

    <script>
        // API base URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : '';

        async function generateDossier() {
            const query = document.getElementById('dossierQuery').value.trim();
            const depth = document.getElementById('depthSelect').value;

            if (!query) {
                alert('Please enter a research topic');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const progress = document.getElementById('progressSection');
            const content = document.getElementById('dossierContent');

            // Reset UI
            btn.disabled = true;
            btn.textContent = 'Generating...';
            progress.classList.add('active');
            content.classList.remove('active');

            // Reset progress steps
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                document.getElementById(id).className = 'progress-step';
            });

            // Simulate progress (actual progress would come from SSE/WebSocket)
            simulateProgress();

            try {
                const response = await fetch(`${API_BASE}/api/dossier`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        depth: depth,
                        format: 'full'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    renderDossier(data);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Dossier generation failed:', error);
                alert('Failed to generate dossier: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Dossier';
                progress.classList.remove('active');
            }
        }

        function simulateProgress() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            let currentStep = 0;

            const interval = setInterval(() => {
                if (currentStep > 0) {
                    document.getElementById(steps[currentStep - 1]).classList.remove('active');
                    document.getElementById(steps[currentStep - 1]).classList.add('complete');
                }

                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, 2000);
        }

        function renderDossier(data) {
            const content = document.getElementById('dossierContent');
            const dossier = data.dossier;

            let html = '';

            // Executive Summary
            html += `
                <div class="dossier-section">
                    <h2><span class="icon">üìã</span> Executive Summary</h2>
                    <p>${dossier.executive_summary || 'No summary available.'}</p>
                </div>
            `;

            // Official Narrative
            html += `
                <div class="dossier-section">
                    <h2><span class="icon">üì∞</span> Official Narrative</h2>
                    <p>${dossier.official_narrative || 'No official narrative found.'}</p>
                </div>
            `;

            // Alternative Narratives
            if (dossier.alternative_narratives && dossier.alternative_narratives.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üîç</span> Alternative Narratives</h2>
                        <ul>
                            ${dossier.alternative_narratives.map(n => `<li>${n}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Key Players
            if (dossier.key_players && dossier.key_players.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üë•</span> Key Players</h2>
                        <table class="players-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Connections</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dossier.key_players.map(p => `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.type}</td>
                                        <td>${p.connections || 0}</td>
                                        <td>${p.description || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Network Map
            if (dossier.network_map && dossier.network_map.nodes && dossier.network_map.nodes.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üï∏Ô∏è</span> Network Map</h2>
                        <div class="network-graph" id="networkGraph"></div>
                    </div>
                `;
            }

            // Contradictions
            if (dossier.contradictions && dossier.contradictions.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">‚öîÔ∏è</span> Narrative Contradictions</h2>
                        ${dossier.contradictions.map(c => `
                            <div class="contradiction-card">
                                <div class="topic">${c.topic || 'Unknown Topic'}</div>
                                <div class="mainstream">${c.mainstream}</div>
                                <div class="alternative">${c.alternative}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Symbol Analysis
            if (dossier.symbol_analysis) {
                const symbols = dossier.symbol_analysis;
                let symbolHtml = '';

                if (symbols.symbols_detected && symbols.symbols_detected.length > 0) {
                    symbolHtml += `
                        <h3>Symbols Detected</h3>
                        <div class="symbol-grid">
                            ${symbols.symbols_detected.map(s => `
                                <div class="symbol-card">
                                    <div class="symbol-name">${s.symbol_name}</div>
                                    <div class="meaning">${s.meaning}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                if (symbols.society_connections && symbols.society_connections.length > 0) {
                    symbolHtml += `
                        <h3 style="margin-top: 1rem;">Society Connections</h3>
                        <ul>
                            ${symbols.society_connections.map(s => `
                                <li><strong>${s.society}</strong>: ${s.match_type}</li>
                            `).join('')}
                        </ul>
                    `;
                }

                if (symbolHtml) {
                    html += `
                        <div class="dossier-section">
                            <h2><span class="icon">üîÆ</span> Symbol & Pattern Analysis</h2>
                            ${symbolHtml}
                        </div>
                    `;
                }
            }

            // Hidden Connections
            if (dossier.hidden_connections && dossier.hidden_connections.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üîó</span> Hidden Connections</h2>
                        ${dossier.hidden_connections.map(c => `
                            <div class="hidden-connection">
                                <span class="entities">${c.entity_1}</span>
                                ‚Üî
                                <span class="entities">${c.entity_2}</span>
                                <span class="via">via ${c.connected_via}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Historical Parallels
            if (dossier.historical_parallels && dossier.historical_parallels.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üìú</span> Historical Parallels</h2>
                        <ul>
                            ${dossier.historical_parallels.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Follow-up Research
            if (dossier.follow_up_research && dossier.follow_up_research.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üî¨</span> Recommended Follow-up Research</h2>
                        <ol>
                            ${dossier.follow_up_research.map(r => `<li>${r}</li>`).join('')}
                        </ol>
                    </div>
                `;
            }

            // Confidence Ratings
            if (dossier.confidence_ratings && Object.keys(dossier.confidence_ratings).length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üìä</span> Confidence Ratings</h2>
                        <table class="players-table">
                            <thead>
                                <tr>
                                    <th>Finding</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(dossier.confidence_ratings).map(([finding, conf]) => `
                                    <tr>
                                        <td>${finding}</td>
                                        <td>
                                            <span class="confidence-badge ${conf.toLowerCase()}">${conf}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Sources
            if (dossier.sources && dossier.sources.length > 0) {
                html += `
                    <div class="dossier-section">
                        <h2><span class="icon">üìö</span> Sources (${dossier.sources.length})</h2>
                        <div class="source-list">
                            ${dossier.sources.slice(0, 20).map((s, i) => `
                                <div class="source-item">
                                    ${i + 1}. <a href="${s.url}" target="_blank">${s.title}</a>
                                    <span class="source-type">[${s.type}]</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Metadata
            if (dossier.metadata) {
                html += `
                    <div class="metadata-bar">
                        <div class="metadata-item">
                            ‚è±Ô∏è Generation Time: <span class="metadata-value">${dossier.metadata.generation_time_seconds?.toFixed(1) || '?'}s</span>
                        </div>
                        <div class="metadata-item">
                            üì° Sources: <span class="metadata-value">${dossier.metadata.total_sources || 0}</span>
                        </div>
                        <div class="metadata-item">
                            üë• Entities: <span class="metadata-value">${dossier.metadata.entities_found || 0}</span>
                        </div>
                        <div class="metadata-item">
                            üîó Relationships: <span class="metadata-value">${dossier.metadata.relationships_mapped || 0}</span>
                        </div>
                        <div class="metadata-item">
                            üîÆ Symbols: <span class="metadata-value">${dossier.metadata.symbols_detected || 0}</span>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            content.classList.add('active');

            // Render network graph if data exists
            if (dossier.network_map && dossier.network_map.nodes && dossier.network_map.nodes.length > 0) {
                renderNetworkGraph(dossier.network_map);
            }
        }

        function renderNetworkGraph(graphData) {
            const container = document.getElementById('networkGraph');
            if (!container) return;

            const width = container.clientWidth;
            const height = container.clientHeight || 500;

            // Clear previous
            container.innerHTML = '';

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Color scale for entity types
            const color = d3.scaleOrdinal()
                .domain([1, 2, 3, 4, 5])
                .range(['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#c084fc']);

            // Create simulation
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(graphData.links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.sqrt(d.value) * 2);

            // Create nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .join('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', 15)
                .attr('fill', d => color(d.group));

            node.append('text')
                .attr('dx', 18)
                .attr('dy', 4)
                .text(d => d.name);

            // Tooltip
            node.append('title')
                .text(d => `${d.name} (${d.type})`);

            // Simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        // Enter key to generate
        document.getElementById('dossierQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateDossier();
            }
        });
    </script>
</body>

</html>
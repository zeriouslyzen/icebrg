<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Encyclopedia - ICEBURG</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .encyclopedia-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Celestial Background Animation */
        .celestial-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        #starfieldCanvas {
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }

        .celestial-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse-glow 8s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* Enhanced Hero Section */
        .encyclopedia-hero {
            margin-bottom: 4rem;
            padding: 3rem 0;
            position: relative;
        }

        .hero-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .hero-title-wrapper {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .encyclopedia-title {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: baseline;
            line-height: 1.1;
        }

        .title-main {
            background: linear-gradient(135deg, #ffffff 0%, #cccccc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fade-in-up 0.8s ease-out;
        }

        .title-accent {
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 300;
            letter-spacing: 0.1em;
            animation: fade-in-up 0.8s ease-out 0.2s both;
        }

        .title-underline {
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            margin-top: 1rem;
            animation: expand-width 1s ease-out 0.5s both;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes expand-width {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 120px;
                opacity: 1;
            }
        }

        .encyclopedia-subtitle {
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
            max-width: 700px;
            animation: fade-in-up 0.8s ease-out 0.4s both;
        }

        /* Hero Stats */
        .hero-stats {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            animation: fade-in-up 0.8s ease-out 0.6s both;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-divider {
            width: 1px;
            height: 40px;
            background: var(--border-primary);
        }

        @media (max-width: 768px) {
            .hero-stats {
                gap: 1rem;
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-divider {
                height: 30px;
            }
        }

        /* Enhanced Search */
        .encyclopedia-search-wrapper {
            animation: fade-in-up 0.8s ease-out 0.8s both;
        }

        .encyclopedia-search {
            position: relative;
            max-width: 700px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
        }

        .encyclopedia-search input {
            flex: 1;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        .encyclopedia-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            background: var(--bg-tertiary);
        }

        .search-filter-btn {
            position: absolute;
            right: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-filter-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .filter-chip {
            padding: 0.5rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
        }

        .filter-chip:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .encyclopedia-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            pointer-events: none;
        }

        /* Introduction Section */
        .encyclopedia-intro {
            max-width: 1200px;
            margin: 0 auto 4rem;
            padding: 3rem;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.5) 0%, rgba(10, 10, 10, 0.7) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            animation: fade-in-up 0.8s ease-out 0.2s both;
            position: relative;
            overflow: hidden;
        }

        .encyclopedia-intro::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .intro-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            position: relative;
        }


        .intro-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .intro-content {
            color: var(--text-secondary);
            line-height: 1.9;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .intro-content p {
            margin-bottom: 1.25rem;
        }

        .intro-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .intro-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2.5rem;
        }

        .intro-section {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all var(--transition-base);
            position: relative;
        }

        .intro-section:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .intro-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }


        .intro-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .intro-section-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Sidebar Navigation */
        .encyclopedia-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .encyclopedia-sidebar {
            position: sticky;
            top: 2rem;
            height: fit-content;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            padding-right: 1rem;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .sidebar-category-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-category-item {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-category-item:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .sidebar-category-item.active {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .sidebar-category-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .sidebar-category-count {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .encyclopedia-main {
            min-width: 0;
        }

        @media (max-width: 1024px) {
            .encyclopedia-layout {
                grid-template-columns: 1fr;
            }

            .encyclopedia-sidebar {
                position: relative;
                top: 0;
                max-height: none;
                margin-bottom: 2rem;
            }
        }

        .encyclopedia-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 768px) {
            .encyclopedia-categories {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 1rem;
            }

            .encyclopedia-intro {
                padding: 1.5rem;
            }

            .intro-features {
                grid-template-columns: 1fr;
            }
        }

        .category-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 140px;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .category-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
        }

        .category-card:hover::before {
            opacity: 1;
        }

        .category-card.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
        }

        .category-card.active::before {
            opacity: 1;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }


        .category-name {
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1;
        }

        .category-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
            flex: 1;
        }

        .category-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .category-count {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .encyclopedia-content {
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .encyclopedia-content.active {
            display: block;
            opacity: 1;
        }

        .encyclopedia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .encyclopedia-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .encyclopedia-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 2rem;
            transition: all var(--transition-base);
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .encyclopedia-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .item-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .item-id {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .item-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .item-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .item-content {
            color: var(--text-secondary);
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        .item-section {
            margin-bottom: 1.5rem;
        }

        .item-section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }

        .item-section-content {
            font-size: 0.95rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .item-list {
            list-style: none;
            padding: 0;
        }

        .item-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-secondary);
        }

        .item-list li:last-child {
            border-bottom: none;
        }

        .item-key-value {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .item-key-value:last-child {
            border-bottom: none;
        }

        .item-key {
            font-weight: 600;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .item-value {
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .search-results {
            margin-top: 2rem;
        }

        .search-results-header {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .search-results-count {
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-tertiary);
        }

        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #ff6b6b;
            margin: 2rem 0;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all var(--transition-base);
            margin-bottom: 2rem;
        }

        .back-button:hover {
            border-color: var(--accent-primary);
            transform: translateX(-4px);
        }

        /* Encyclopedia Navbar */
        .encyclopedia-navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 2rem;
            margin: -2rem -2rem 0 -2rem;
        }

        .encyclopedia-back-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: 0.75rem;
            margin-left: 2rem;
            background: transparent;
            border: none;
            padding: 0;
        }

        .encyclopedia-back-button:hover {
            color: var(--text-primary);
            transform: translateX(-3px);
        }

        .encyclopedia-back-button svg {
            width: 20px;
            height: 20px;
        }

        /* News Ticker */
        .news-ticker {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
            position: relative;
            height: 36px;
            display: flex;
            align-items: center;
        }

        .ticker-content {
            display: inline-flex;
            align-items: center;
            height: 100%;
            white-space: nowrap;
            animation: ticker-scroll 60s linear infinite;
            will-change: transform;
        }

        .ticker-label {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.8rem;
            margin-right: 1.5rem;
            padding: 0 1rem;
            flex-shrink: 0;
        }

        .ticker-item {
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding-right: 4rem;
            display: inline-block;
        }

        .ticker-item::after {
            content: ' • ';
            color: var(--text-tertiary);
            margin: 0 1.5rem;
        }

        @keyframes ticker-scroll {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-50%);
            }
        }

        .ticker-content:hover {
            animation-play-state: paused;
        }


        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all var(--transition-base);
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
        }

        .nav-link:hover {
            color: var(--text-primary);
            border-bottom-color: var(--accent-primary);
        }

        .news-toggle {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .news-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .news-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-primary);
            color: #000;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* News & Updates Section */
        .encyclopedia-news-section {
            margin-top: 4rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(10, 10, 10, 0.6) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .news-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .news-refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.9rem;
        }

        .news-refresh-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .news-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .news-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .news-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all var(--transition-base);
            position: relative;
        }

        .news-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .news-card.suppressed {
            border-left: 3px solid var(--accent-primary);
        }

        .news-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .news-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.4;
        }

        .news-card-source {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .news-card-summary {
            margin: 1rem 0;
        }

        .news-card-summary ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .news-card-summary li {
            padding: 0.5rem 0;
            padding-left: 1.25rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            position: relative;
        }

        .news-card-summary li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: bold;
        }

        .news-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .news-card-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all var(--transition-base);
        }

        .news-card-link:hover {
            text-decoration: underline;
        }

        .news-card-badge {
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        .news-card-badge.suppressed {
            background: rgba(255, 200, 0, 0.2);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        @media (max-width: 768px) {
            .encyclopedia-navbar {
                padding: 1rem;
                margin: -2rem -1rem 2rem -1rem;
            }


            .news-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .encyclopedia-container {
                padding: 1rem;
            }

            .encyclopedia-navbar {
                padding: 0.5rem 1rem;
                margin: -1rem -1rem 0 -1rem;
            }

            .encyclopedia-back-button {
                margin-left: 1rem;
                margin-top: 0.5rem;
            }

            .encyclopedia-title {
                font-size: 2rem;
            }

            .encyclopedia-categories {
                grid-template-columns: 1fr;
            }

            .encyclopedia-grid {
                grid-template-columns: 1fr;
            }

            .item-key-value {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .encyclopedia-item {
                padding: 1.5rem;
            }

            .item-section {
                margin-bottom: 1.5rem;
            }
        }

        /* Prevent text overlap and ensure proper spacing */
        .source-item, .study-item {
            margin-bottom: 1rem !important;
            padding: 0.75rem !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .source-item a, .study-item a {
            white-space: nowrap;
            display: inline-block;
        }

        .item-section-title {
            margin-bottom: 0.75rem !important;
        }

        /* Entry Card Styles */
        .encyclopedia-item-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 180px;
        }

        .encyclopedia-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .encyclopedia-item-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .encyclopedia-item-card:hover::before {
            opacity: 1;
        }

        .item-card-header {
            margin-bottom: 1rem;
        }

        .item-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .item-card-category {
            display: inline-block;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .item-card-preview {
            flex: 1;
            margin-bottom: 1rem;
        }

        .item-card-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .item-card-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .item-card-view-btn {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--border-primary);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .item-card-view-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.06);
        }

        .item-card-iceburg-btn {
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: 1px solid var(--border-primary);
            background: radial-gradient(circle at 30% 0%, rgba(0, 212, 255, 0.35), transparent 55%), rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .item-card-iceburg-btn:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 18px rgba(0, 212, 255, 0.5);
            transform: translateY(-1px);
        }

        .item-card-iceburg-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Right-side ICEBURG explain panel */
        .entry-explain-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            max-width: 85vw;
            height: 100vh;
            background: rgba(6, 10, 20, 0.96);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-left: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: -16px 0 40px rgba(0, 0, 0, 0.6);
            z-index: 11000;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .entry-explain-panel.active {
            right: 0;
        }

        .entry-explain-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .entry-explain-title {
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .entry-explain-close {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            border: 1px solid var(--border-primary);
            background: transparent;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entry-explain-close:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.04);
        }

        .entry-explain-body {
            padding: 1rem 1.25rem 1.5rem;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .explain-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-tertiary);
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .explain-section-body {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .explain-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-top: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .explain-chip {
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        @media (max-width: 768px) {
            .entry-explain-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* Modal Styles */
        .entry-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            overflow-y: auto;
            padding: 1rem;
        }

        .entry-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .entry-modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 95vh;
            margin: auto;
            position: relative;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .entry-modal-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-primary);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .entry-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .entry-modal-close {
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .entry-modal-close:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .entry-modal-body {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .entry-modal {
                padding: 0;
            }

            .entry-modal-content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .entry-modal-header {
                padding: 1rem 1.5rem;
            }

            .entry-modal-title {
                font-size: 1.25rem;
            }

            .entry-modal-body {
                padding: 1.5rem;
            }

            .encyclopedia-item-card {
                min-height: 160px;
                padding: 1.25rem;
            }
        }

        /* Celestial Dashboard Features */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Connection Visualization */
        .connection-graph {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
        }

        .connection-node {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .connection-node:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- Celestial Background Animation -->
    <div class="celestial-background">
        <canvas id="starfieldCanvas"></canvas>
        <div class="celestial-glow"></div>
    </div>

        <!-- Encyclopedia Navbar -->
    <nav class="encyclopedia-navbar">
        <!-- News Ticker -->
        <div class="news-ticker" id="newsTicker">
            <div class="ticker-content" id="tickerContent">
                <span class="ticker-label">Updates:</span>
                <span class="ticker-item">Loading latest research updates...</span>
            </div>
        </div>
    </nav>

    <button class="encyclopedia-back-button" onclick="window.location.href='/'" aria-label="Back to ICEBURG">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>

    <div class="encyclopedia-container">

        <!-- Enhanced Hero Section -->
        <div class="encyclopedia-hero">
            <div class="hero-content">
                <div class="hero-title-wrapper">
                    <h1 class="encyclopedia-title">
                        <span class="title-main">Celestial</span>
                        <span class="title-accent">Encyclopedia</span>
                    </h1>
                    <div class="title-underline"></div>
                </div>
                <!-- Quick Stats -->
                <div class="hero-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalEntries">0</div>
                        <div class="stat-label">Entries</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalSources">0</div>
                        <div class="stat-label">Sources</div>
                    </div>
                </div>

                <!-- Enhanced Search -->
                <div class="encyclopedia-search-wrapper">
                    <div class="encyclopedia-search">
                        <svg class="encyclopedia-search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19 19L14.65 14.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search entries, categories, or concepts...">
                        <button class="search-filter-btn" id="filterToggle" title="Advanced Filters">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                                <path d="M2 4H16M5 9H13M7 14H11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Quick Filters -->
                    <div class="quick-filters" id="quickFilters">
                        <button class="filter-chip active" data-filter="all">All</button>
                        <button class="filter-chip" data-filter="celestial_bodies">Celestial</button>
                        <button class="filter-chip" data-filter="neurotransmitters">Neurotransmitters</button>
                        <button class="filter-chip" data-filter="hormones">Hormones</button>
                        <button class="filter-chip" data-filter="tcm_correlations">TCM</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Introduction Section -->
        <div class="encyclopedia-intro">
            <div class="intro-header">
                <h2 class="intro-title">Understanding Celestial-Biological Correlations</h2>
            </div>
            <div class="intro-content">
                <p>The Celestial Encyclopedia represents a systematic investigation into the fundamental patterns connecting celestial phenomena and biological systems. This knowledge base synthesizes rigorous scientific research, empirical observations, and evidence-based correlations to map the intricate relationships between electromagnetic fields, planetary dynamics, cosmic events, and biological processes.</p>
                
                <p><strong>Pattern Recognition and Holistic Understanding:</strong> The encyclopedia employs advanced pattern recognition methodologies to identify recurring correlations across multiple domains. Rather than isolated observations, entries are organized to reveal holistic applications—showing how celestial influences manifest across biological systems, from molecular processes to organ function, from cellular rhythms to systemic responses.</p>
                
                <p><strong>Evidence-Based Framework:</strong> Every entry is grounded in scientific evidence, with clear distinctions between established findings, theoretical models, and speculative hypotheses. Evidence levels are explicitly marked, allowing users to understand the strength and reliability of each correlation. Research sources, study methodologies, and peer-reviewed publications are documented to enable verification and deeper investigation.</p>
                
                <p><strong>Logical Structure and Accessibility:</strong> The knowledge base is organized into 18 distinct domains, each representing a coherent area of investigation. Categories range from fundamental biological systems (neurotransmitters, hormones, cellular processes) to celestial phenomena (electromagnetic environment, Schumann resonance, geomagnetic activity) to advanced research domains (quantum biology, coherence systems, institutional research). This structure enables both targeted exploration and cross-domain pattern discovery.</p>
                
                <p><strong>Practical Applications:</strong> Beyond theoretical understanding, the encyclopedia provides insights into practical applications. Entries include information on how celestial-biological correlations can inform health optimization, circadian rhythm alignment, stress management, and environmental adaptation. The holistic approach recognizes that biological systems operate as integrated networks, responding to multiple environmental factors simultaneously.</p>
            </div>
            <div class="intro-sections">
                <div class="intro-section">
                    <div class="intro-section-header">
                        <div class="intro-section-title">Pattern Recognition</div>
                    </div>
                    <div class="intro-section-content">
                        Advanced pattern recognition identifies recurring correlations across biological and celestial domains, revealing systemic relationships rather than isolated phenomena.
                    </div>
                </div>
                <div class="intro-section">
                    <div class="intro-section-header">
                        <div class="intro-section-title">Evidence-Based</div>
                    </div>
                    <div class="intro-section-content">
                        All entries include explicit evidence levels, research sources, and study methodologies, enabling users to assess the reliability and scientific foundation of each correlation.
                    </div>
                </div>
                <div class="intro-section">
                    <div class="intro-section-header">
                        <div class="intro-section-title">Holistic Applications</div>
                    </div>
                    <div class="intro-section-content">
                        Entries reveal how celestial influences manifest across multiple biological systems simultaneously, providing insights for health optimization and environmental adaptation.
                    </div>
                </div>
                <div class="intro-section">
                    <div class="intro-section-header">
                        <div class="intro-section-title">Logical Structure</div>
                    </div>
                    <div class="intro-section-content">
                        Organized into 18 coherent knowledge domains with clear categorization, enabling both targeted exploration and cross-domain pattern discovery.
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout with Sidebar -->
        <div class="encyclopedia-layout">
            <!-- Sidebar Navigation -->
            <div class="encyclopedia-sidebar" id="encyclopediaSidebar">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Browse Categories</div>
                    <div class="sidebar-category-list" id="sidebarCategoryList">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="encyclopedia-main">
                <div id="categoriesContainer" class="encyclopedia-categories"></div>
                <div id="contentContainer" class="encyclopedia-content"></div>
            </div>
        </div>
        <div id="searchResults" class="search-results" style="display: none;"></div>

        <!-- News & Updates Section -->
        <section class="encyclopedia-news-section" id="newsSection" style="display: none;">
            <div class="news-header">
                <h2 class="news-title">Research News & Updates</h2>
                <button class="news-refresh-btn" id="newsRefreshBtn">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M9 1V5M9 13V17M1 9H5M13 9H17M3.64 3.64L6.17 6.17M11.83 11.83L14.36 14.36M3.64 14.36L6.17 11.83M11.83 6.17L14.36 3.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Refresh
                </button>
            </div>
            <div class="news-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="suppressed">Suppressed Research</button>
                <button class="filter-btn" data-filter="recent">Recent Studies</button>
                <button class="filter-btn" data-filter="breaking">Breaking News</button>
            </div>
            <div class="news-loading" id="newsLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Fetching latest research...</p>
            </div>
            <div class="news-grid" id="newsGrid">
                <!-- News articles will be populated here -->
            </div>
        </section>

        <div id="loadingIndicator" class="loading" style="display: none;">Loading encyclopedia...</div>
        <div id="errorIndicator" class="error" style="display: none;"></div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="entry-modal">
        <div class="entry-modal-content">
            <div class="entry-modal-header">
                <h2 class="entry-modal-title" id="modalTitle">Entry Details</h2>
                <button class="entry-modal-close" onclick="closeEntryModal()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="entry-modal-body" id="modalBody">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Right-side ICEBURG explain panel -->
    <div id="entryExplainPanel" class="entry-explain-panel">
        <div class="entry-explain-header">
            <div class="entry-explain-title" id="explainTitle">ICEBURG Explanation</div>
            <button class="entry-explain-close" onclick="closeExplainPanel()" aria-label="Close explanation">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        <div class="entry-explain-body" id="explainBody">
            <!-- Explanation content will be inserted dynamically -->
        </div>
    </div>

    <script>
        // Use backend API URL (port 8000 for localhost, or detect from environment)
        // On localhost: uses http://localhost:8000 (backend API)
        // On production: uses same origin or configured API URL
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocalhost ? 'http://localhost:8000' : window.location.origin;
        
        console.log('Encyclopedia API URL:', API_URL, 'Hostname:', window.location.hostname);

        let encyclopediaData = null;
        let currentCategory = null;
        let searchTimeout = null;

        const categories = [
            { id: 'celestial_bodies', name: 'Celestial Bodies', description: 'Planets, stars, and their biological correlations' },
            { id: 'voltage_gates', name: 'Voltage Gates', description: 'Ion channels and neural excitability' },
            { id: 'neurotransmitters', name: 'Neurotransmitters', description: 'Chemical messengers and neural communication' },
            { id: 'hormones', name: 'Hormones', description: 'Endocrine system and hormonal regulation' },
            { id: 'biophysical_parameters', name: 'Biophysical Parameters', description: 'Measurable physiological metrics' },
            { id: 'molecular_chemistry', name: 'Molecular Chemistry', description: 'Molecular structures and configurations' },
            { id: 'electromagnetic_environment', name: 'EM Environment', description: 'Electromagnetic fields and frequencies' },
            { id: 'organ_systems', name: 'Organ Systems', description: 'Cardiovascular, nervous, endocrine, and other major organ systems' },
            { id: 'cellular_processes', name: 'Cellular Processes', description: 'Cell cycle, apoptosis, DNA replication, and cellular mechanisms' },
            { id: 'circadian_biology', name: 'Circadian Biology', description: 'Circadian rhythms, clock genes, and temporal biology' },
            { id: 'quantum_biology', name: 'Quantum Biology', description: 'Quantum effects in biological systems, coherence, and entanglement' },
            { id: 'research_methodologies', name: 'Research Methodologies', description: 'Study designs, biomarkers, statistical methods, and research approaches' },
            { id: 'tcm_correlations', name: 'TCM Correlations', description: 'Traditional Chinese Medicine mappings' },
            { id: 'coherence_systems', name: 'Coherence Systems', description: 'Heart coherence, quantum coherence, biological synchronization' },
            { id: 'morphic_fields', name: 'Morphic Fields', description: 'Morphic resonance theory and field effects' },
            { id: 'vedic_knowledge', name: 'Vedic Knowledge', description: 'Ayurveda, Jyotish, Nakshatras, Doshas' },
            { id: 'schumann_resonance', name: 'Schumann Resonance', description: 'Earth frequency and biological correlations' },
            { id: 'government_research', name: 'Government Research', description: 'Declassified government programs and consciousness research' },
        { id: 'patents', name: 'Patents', description: 'Patents related to EM fields, consciousness technologies, and biological effects' },
        { id: 'cern_research', name: 'CERN Research', description: 'CERN particle physics research related to biological systems' }
      ];

        async function loadEncyclopedia() {
            const loadingEl = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorIndicator');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';

            try {
                console.log('Fetching encyclopedia from:', `${API_URL}/api/encyclopedia`);
                const response = await fetch(`${API_URL}/api/encyclopedia`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }
                
                encyclopediaData = await response.json();
                console.log('Encyclopedia data loaded:', Object.keys(encyclopediaData || {}));
                
                if (!encyclopediaData || Object.keys(encyclopediaData).length === 0) {
                    throw new Error('Encyclopedia data is empty');
                }
                
                renderCategories();
                // Auto-select first category if available
                if (categories.length > 0 && encyclopediaData[categories[0].id]) {
                    selectCategory(categories[0].id);
                }
                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading encyclopedia:', error);
                errorEl.innerHTML = `
                    <div style="padding: 1rem; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 8px; color: #ff6b6b;">
                        <strong>Error loading encyclopedia:</strong><br>
                        ${error.message}<br>
                        <small>API URL: ${API_URL}/api/encyclopedia</small><br>
                        <small>Hostname: ${window.location.hostname}</small><br>
                        <small>If on mobile, ensure backend is accessible at ${API_URL}</small>
                    </div>
                `;
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }

        // Category icons mapping - SVG icons
        function getCategoryIcon(categoryId) {
            const icons = {
                'celestial_bodies': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'voltage_gates': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>',
                'neurotransmitters': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23M4.22 19.78L7.76 16.24M16.24 7.76L19.78 4.22"/></svg>',
                'hormones': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>',
                'biophysical_parameters': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3H21V21H3V3Z"/><path d="M3 12H21M12 3V21"/><circle cx="8" cy="8" r="1.5"/><circle cx="16" cy="8" r="1.5"/><circle cx="8" cy="16" r="1.5"/><circle cx="16" cy="16" r="1.5"/></svg>',
                'molecular_chemistry': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'electromagnetic_environment': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z"/><path d="M12 6V18M6 12H18"/></svg>',
                'organ_systems': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'cellular_processes': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23M4.22 19.78L7.76 16.24M16.24 7.76L19.78 4.22"/></svg>',
                'circadian_biology': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6V12L16 14"/></svg>',
                'quantum_biology': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/><circle cx="12" cy="12" r="2"/></svg>',
                'research_methodologies': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8C21 7.46957 20.7893 6.96086 20.4142 6.58579C20.0391 6.21071 19.5304 6 19 6H5C4.46957 6 3.96086 6.21071 3.58579 6.58579C3.21071 6.96086 3 7.46957 3 8V16C3 16.5304 3.21071 17.0391 3.58579 17.4142C3.96086 17.7893 4.46957 18 5 18H19C19.5304 18 20.0391 17.7893 20.4142 17.4142C20.7893 17.0391 21 16.5304 21 16Z"/><path d="M7 10H17M7 14H12"/></svg>',
                'tcm_correlations': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23"/></svg>',
                'coherence_systems': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'morphic_fields': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z"/><path d="M12 6V18M6 12H18"/><circle cx="12" cy="12" r="2"/></svg>',
                'vedic_knowledge': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'schumann_resonance': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
                'government_research': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>',
                'patents': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8C21 7.46957 20.7893 6.96086 20.4142 6.58579C20.0391 6.21071 19.5304 6 19 6H5C4.46957 6 3.96086 6.21071 3.58579 6.58579C3.21071 6.96086 3 7.46957 3 8V16C3 16.5304 3.21071 17.0391 3.58579 17.4142C3.96086 17.7893 4.46957 18 5 18H19C19.5304 18 20.0391 17.7893 20.4142 17.4142C20.7893 17.0391 21 16.5304 21 16Z"/></svg>',
                'cern_research': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/><circle cx="12" cy="12" r="2"/></svg>'
            };
            return icons[categoryId] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>';
        }

        // Category groups for organization
        const categoryGroups = {
            'Biological Systems': ['voltage_gates', 'neurotransmitters', 'hormones', 'biophysical_parameters', 'organ_systems', 'cellular_processes'],
            'Celestial & EM': ['celestial_bodies', 'electromagnetic_environment', 'schumann_resonance'],
            'Research & Methods': ['research_methodologies', 'quantum_biology', 'circadian_biology', 'molecular_chemistry'],
            'Traditional Knowledge': ['tcm_correlations', 'vedic_knowledge'],
            'Advanced Concepts': ['coherence_systems', 'morphic_fields'],
            'Institutional Research': ['government_research', 'patents', 'cern_research']
        };

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            const sidebarList = document.getElementById('sidebarCategoryList');
            
            // Render category cards
            container.innerHTML = categories.map(cat => {
                const count = encyclopediaData[cat.id] ? Object.keys(encyclopediaData[cat.id]).length : 0;
                const description = cat.description || 'Explore entries in this category';
                
                return `
                    <div class="category-card" data-category="${cat.id}">
                        <div class="category-header">
                            <div class="category-name">${cat.name}</div>
                        </div>
                        <div class="category-description">${description}</div>
                        <div class="category-footer">
                            <span class="category-count">${count} entries</span>
                            <span class="category-badge">Browse</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Render sidebar navigation
            sidebarList.innerHTML = categories.map(cat => {
                const count = encyclopediaData[cat.id] ? Object.keys(encyclopediaData[cat.id]).length : 0;
                return `
                    <div class="sidebar-category-item" data-category="${cat.id}">
                        <span class="sidebar-category-name">${cat.name}</span>
                        <span class="sidebar-category-count">${count}</span>
                    </div>
                `;
            }).join('');

            // Add click handlers for cards
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.dataset.category;
                    selectCategory(category);
                    // Scroll to content
                    document.getElementById('contentContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            // Add click handlers for sidebar
            document.querySelectorAll('.sidebar-category-item').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.dataset.category;
                    selectCategory(category);
                    // Scroll to content
                    document.getElementById('contentContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        }

        function selectCategory(categoryId) {
            currentCategory = categoryId;
            
            // Update active state for cards
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.toggle('active', card.dataset.category === categoryId);
            });

            // Update active state for sidebar
            document.querySelectorAll('.sidebar-category-item').forEach(item => {
                item.classList.toggle('active', item.dataset.category === categoryId);
            });

            // Show content
            const contentContainer = document.getElementById('contentContainer');
            const searchResults = document.getElementById('searchResults');
            contentContainer.style.display = 'block';
            contentContainer.classList.add('active');
            searchResults.style.display = 'none';

            if (!encyclopediaData || !encyclopediaData[categoryId]) {
                contentContainer.innerHTML = '<div class="error">Category data not found</div>';
                return;
            }

            const categoryData = encyclopediaData[categoryId];
            const items = Object.entries(categoryData).map(([id, data]) => ({ id, ...data }));

            contentContainer.innerHTML = `
                <h2 style="margin-bottom: 2rem; font-size: 1.5rem;">${categories.find(c => c.id === categoryId)?.name || categoryId}</h2>
                <div class="encyclopedia-grid">
                    ${items.map(item => renderItem(item, true)).join('')}
                </div>
            `;
        }

        function renderItem(item, isCompact = false) {
            if (isCompact) {
                // Derive a preview text so every entry has a visible summary on the card
                const previewSource =
                    item.description ||
                    item.research_notes ||
                    item.origin_story ||
                    (Array.isArray(item.biological_correlations) && item.biological_correlations.length
                        ? `Biological correlations: ${item.biological_correlations.join(', ')}`
                        : '') ||
                    (item.evidence_level ? `Evidence level: ${item.evidence_level}` : '');

                const previewText = previewSource
                    ? previewSource.toString().substring(0, 220) + (previewSource.length > 220 ? '...' : '')
                    : '';

                // Compact card view for grid
                return `
                    <div class="encyclopedia-item-card" data-item-id="${item.id}" data-category="${item.category || ''}">
                        <div class="item-card-header">
                            <div class="item-card-name">${item.name || item.id}</div>
                            ${item.category ? `<span class="item-card-category">${item.category.replace(/_/g, ' ')}</span>` : ''}
                        </div>
                        <div class="item-card-preview">
                            ${previewText ? `<div class="item-card-description">${previewText}</div>` : ''}
                        </div>
                        <div class="item-card-footer">
                            <button class="item-card-view-btn" onclick="openEntryModal('${item.id}', '${item.category || ''}')">View Details</button>
                            <button class="item-card-iceburg-btn" onclick="openExplainPanel('${item.id}', '${item.category || ''}')"
                                title="Explain with ICEBURG">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 19L10 4.5C10.6 3.3 11.1 3 12 3C12.9 3 13.4 3.3 14 4.5L21 19H3Z"/>
                                    <path d="M5 19L9 12L12 17L15 11L19 19H5Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
            // Full view (legacy, for search results)
            return `
                <div class="encyclopedia-item">
                    <div class="item-header">
                        <div class="item-id">${item.id || 'N/A'}</div>
                        <div class="item-name">${item.name || item.id}</div>
                        ${item.category ? `<span class="item-category">${item.category}</span>` : ''}
                    </div>
                    <div class="item-content">
                        ${renderItemSections(item)}
                    </div>
                </div>
            `;
        }

        function renderItemSections(item) {
            const sections = [];
            
            // Description (always show, even if placeholder)
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Description</div>
                    <div class="item-section-content">
                        ${item.description || 'Not yet documented for this entry in the current encyclopedia version.'}
                    </div>
                </div>
            `);

            // Render key-value pairs (structured details)
            const excludeKeys = ['id', 'name', 'category', 'description', 'sources', 'studies', 'research_notes', 'origin_story'];
            const keyValuePairs = Object.entries(item)
                .filter(([key]) => !excludeKeys.includes(key))
                .filter(([_, value]) => value !== null && value !== undefined && value !== '');

            if (keyValuePairs.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Details</div>
                        <div class="item-section-content">
                            ${keyValuePairs.map(([key, value]) => {
                                if (Array.isArray(value)) {
                                    const formattedArray = value.map(v => formatValue(v)).join(', ');
                                    return `
                                        <div class="item-key-value">
                                            <div class="item-key">${formatKey(key)}</div>
                                            <div class="item-value">${formattedArray}</div>
                                        </div>
                                    `;
                                } else if (typeof value === 'object' && value !== null) {
                                    // Format objects nicely - check if it's a simple object with arrays of numbers (like TCM data)
                                    const entries = Object.entries(value);
                                    const isSimpleNumberArrays = entries.every(([k, v]) => Array.isArray(v) && v.every(item => typeof item === 'number'));
                                    
                                    if (isSimpleNumberArrays && entries.length > 0) {
                                        // Display as a clean list of key-value pairs
                                        return `
                                            <div class="item-key-value" style="margin-bottom: 8px;">
                                                <div class="item-key" style="font-weight: 600; margin-bottom: 4px; color: var(--accent-primary);">${formatKey(key)}</div>
                                                <div class="item-value" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 6px; font-size: 0.9em;">
                                                    ${entries.map(([subKey, subValue]) => `
                                                        <div style="padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                                            <strong style="color: #ccc;">${formatKey(subKey)}:</strong>
                                                            <span style="color: #999; margin-left: 4px;">${Array.isArray(subValue) ? subValue.join(', ') : formatValue(subValue)}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        // Complex object - format as nested structure
                                        let formattedValue = '';
                                        if (Array.isArray(value)) {
                                            formattedValue = value.map((item, idx) => {
                                                if (typeof item === 'object' && item !== null) {
                                                    const objStr = Object.entries(item)
                                                        .map(([k, v]) => {
                                                            let val = v;
                                                            if (typeof v === 'object' && v !== null) {
                                                                if (Array.isArray(v)) {
                                                                    val = v.map(item => formatValue(item)).join(', ');
                                                                } else {
                                                                    val = Object.entries(v).map(([sk, sv]) => `${formatKey(sk)}: ${formatValue(sv)}`).join(', ');
                                                                }
                                                            } else {
                                                                val = formatValue(v);
                                                            }
                                                            return `${formatKey(k)}: ${val}`;
                                                        })
                                                        .join(', ');
                                                    return `${idx + 1}. ${objStr}`;
                                                }
                                                return formatValue(String(item));
                                            }).join('; ');
                                        } else {
                                            // Format object as key-value pairs
                                            formattedValue = Object.entries(value)
                                                .map(([k, v]) => {
                                                    const formattedKey = formatKey(k);
                                                    let val = v;
                                                    if (typeof v === 'object' && v !== null) {
                                                        if (Array.isArray(v)) {
                                                            val = v.map(item => formatValue(item)).join(', ');
                                                        } else {
                                                            val = Object.entries(v).map(([sk, sv]) => `${formatKey(sk)}: ${formatValue(sv)}`).join(', ');
                                                        }
                                                    } else {
                                                        val = formatValue(v);
                                                    }
                                                    return `${formattedKey}: ${val}`;
                                                })
                                                .join('; ');
                                        }
                                        return `
                                            <div class="item-key-value">
                                                <div class="item-key">${formatKey(key)}</div>
                                                <div class="item-value">${formattedValue || 'N/A'}</div>
                                            </div>
                                        `;
                                    }
                                } else {
                                    return `
                                        <div class="item-key-value">
                                            <div class="item-key">${formatKey(key)}</div>
                                            <div class="item-value">${formatValue(value)}</div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `);
            }

            // Evidence Level Badge (always show, defaulting when missing)
            const evidenceColors = {
                    'measured': { bg: 'rgba(76, 175, 80, 0.2)', color: '#4caf50', border: '#4caf50' },
                    'theoretical': { bg: 'rgba(33, 150, 243, 0.2)', color: '#2196f3', border: '#2196f3' },
                    'speculative': { bg: 'rgba(255, 152, 0, 0.2)', color: '#ff9800', border: '#ff9800' },
                    'documented': { bg: 'rgba(156, 39, 176, 0.2)', color: '#9c27b0', border: '#9c27b0' }
            };
            const evidenceKey = item.evidence_level || 'theoretical';
            const colors = evidenceColors[evidenceKey] || evidenceColors.theoretical;
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Evidence Level</div>
                    <div class="item-section-content">
                        <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background: ${colors.bg}; color: ${colors.color}; border: 1px solid ${colors.border};">
                            ${evidenceKey}
                        </span>
                    </div>
                </div>
            `);

            // Related Entries
            if (item.related_entries && item.related_entries.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Related Entries</div>
                        <div class="item-section-content">
                            ${item.related_entries.map(relId => {
                                const relName = relId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                return `<a href="#" class="related-entry-link" data-entry-id="${relId}" style="display: inline-block; margin: 0.25rem 0.5rem 0.25rem 0; padding: 0.25rem 0.5rem; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 4px; color: var(--accent-primary); text-decoration: none; font-size: 0.85rem; transition: all 0.2s;">${relName}</a>`;
                            }).join('')}
                        </div>
                    </div>
                `);
            }

            // Research notes (always show, with clear placeholder)
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Research Notes</div>
                    <div class="item-section-content">
                        ${item.research_notes || 'Research notes for this entry have not yet been written. This indicates an area for future evidence review and synthesis.'}
                    </div>
                </div>
            `);

            // Sources
            if (item.sources && item.sources.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Sources</div>
                        <div class="item-section-content">
                            ${item.sources.map(source => `
                                <div class="source-item" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.02); border-left: 3px solid var(--accent-primary);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                        ${source.title || 'Research Paper'}
                                        ${source.url ? `<a href="${source.url}" target="_blank" style="color: var(--accent-primary); text-decoration: none; margin-left: 0.5rem; font-size: 0.85rem; white-space: nowrap;">[Link]</a>` : ''}
                                    </div>
                                    ${source.authors ? `<div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">${Array.isArray(source.authors) ? source.authors.join(', ') : source.authors}</div>` : ''}
                                    ${source.journal ? `<div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">${source.journal}${source.year ? ` (${source.year})` : ''}</div>` : ''}
                                    ${source.doi ? `<div style="font-size: 0.8rem; color: var(--text-tertiary); word-break: break-all;">DOI: <a href="https://doi.org/${source.doi}" target="_blank" style="color: var(--accent-primary);">${source.doi}</a></div>` : ''}
                                    ${source.patent_number ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">Patent: ${source.patent_number}${source.url ? ` <a href="${source.url}" target="_blank" style="color: var(--accent-primary);">[View Patent]</a>` : ''}</div>` : ''}
                                    ${source.cern_document_number ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">CERN Doc: ${source.cern_document_number}${source.url ? ` <a href="${source.url}" target="_blank" style="color: var(--accent-primary);">[View Document]</a>` : ''}</div>` : ''}
                                    ${source.key_findings ? `<div style="margin-top: 0.5rem; font-size: 0.9rem; font-style: italic;">${source.key_findings}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `);
            }

            // Studies
            if (item.studies && item.studies.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Studies</div>
                        <div class="item-section-content">
                            ${item.studies.map(study => `
                                <div class="study-item" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.02); border-left: 3px solid var(--accent-secondary);">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                        ${study.study_type ? study.study_type.replace('_', ' ').toUpperCase() : 'Study'}
                                        ${study.sample_size ? ` (n=${study.sample_size})` : ''}
                                        ${study.duration ? ` - ${study.duration}` : ''}
                                    </div>
                                    ${study.findings ? `<div style="margin-bottom: 0.5rem;">${study.findings}</div>` : ''}
                                    ${study.methodology ? `<div style="font-size: 0.85rem; color: var(--text-tertiary);">Methodology: ${study.methodology}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `);
            }

            // Origin Story (always show, with placeholder when missing)
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Origin Story</div>
                    <div class="item-section-content" style="font-style: italic; line-height: 1.8;">
                        ${item.origin_story || 'Origin story and historical context for this entry are not yet documented. They will be added as the encyclopedia is expanded.'}
                    </div>
                </div>
            `);

            return sections.join('');
        }

        function formatKey(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatValue(value) {
            if (typeof value === 'string') {
                // Replace underscores with spaces and capitalize
                return value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            return value;
        }

        async function searchEncyclopedia(query) {
            if (!query || query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                if (currentCategory) {
                    selectCategory(currentCategory);
                }
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/encyclopedia/search/${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                displaySearchResults(data);
            } catch (error) {
                console.error('Error searching:', error);
            }
        }

        function displaySearchResults(data) {
            const searchResults = document.getElementById('searchResults');
            const contentContainer = document.getElementById('contentContainer');
            
            contentContainer.style.display = 'none';
            searchResults.style.display = 'block';

            searchResults.innerHTML = `
                <div class="search-results-header">
                    Search Results for "${data.query}"
                    <span class="search-results-count">(${data.count} found)</span>
                </div>
                <div class="encyclopedia-grid">
                    ${data.results.map(result => renderItem(result.data)).join('')}
                </div>
            `;
        }

        // Search input handler
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchEncyclopedia(query);
            }, 300);
        });

        // Modal Functions
        function openEntryModal(itemId, categoryId) {
            if (!encyclopediaData || !encyclopediaData[categoryId] || !encyclopediaData[categoryId][itemId]) {
                console.error('Entry not found:', itemId, categoryId);
                return;
            }

            const item = { id: itemId, ...encyclopediaData[categoryId][itemId] };
            const modal = document.getElementById('entryModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = item.name || item.id;
            modalBody.innerHTML = renderItemSections(item);

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Scroll to top
            modal.scrollTop = 0;
        }

        // ICEBURG Explain side panel
        function openExplainPanel(itemId, categoryId) {
            if (!encyclopediaData || !encyclopediaData[categoryId] || !encyclopediaData[categoryId][itemId]) {
                console.error('Explain entry not found:', itemId, categoryId);
                return;
            }

            const item = { id: itemId, ...encyclopediaData[categoryId][itemId] };
            const panel = document.getElementById('entryExplainPanel');
            const titleEl = document.getElementById('explainTitle');
            const bodyEl = document.getElementById('explainBody');

            if (!panel || !titleEl || !bodyEl) return;

            titleEl.textContent = item.name || item.id || 'ICEBURG Explanation';
            bodyEl.innerHTML = buildExplainContent(item);

            // Kick off LLM-based summary from ICEBURG physiology agent
            try {
                loadExplainFromLLM(item);
            } catch (e) {
                console.error('Error starting LLM explain:', e);
            }

            panel.classList.add('active');
        }

        function closeExplainPanel() {
            const panel = document.getElementById('entryExplainPanel');
            if (panel) panel.classList.remove('active');
        }

        function buildExplainContent(item) {
            const parts = [];

            // 0. ICEBURG physiology LLM summary placeholder (will be filled asynchronously)
            parts.push(`
                <div id="explainLLMSection">
                    <div class="explain-section-title">ICEBURG Physiology Summary</div>
                    <div class="explain-section-body">
                        Connecting to ICEBURG physiology agent for a 3‑point summary...
                    </div>
                </div>
            `);

            // 1. Core idea – local, deterministic explanation as a fallback/context
            const baseText =
                item.description ||
                item.research_notes ||
                item.origin_story ||
                'This entry has not yet been fully explained in student-friendly language. It is part of the encyclopedia schema and will be expanded.';

            parts.push(`
                <div>
                    <div class="explain-section-title">Core Idea (Local)</div>
                    <div class="explain-section-body">
                        ${baseText}
                    </div>
                </div>
            `);

            // 2. How this fits ICEBURG / field model
            let fieldLines = [];
            if (Array.isArray(item.field_model_mapping) && item.field_model_mapping.length) {
                fieldLines = item.field_model_mapping;
            } else {
                // Derive a basic mapping from category when explicit mapping is missing
                if (item.category === 'celestial_bodies') {
                    fieldLines.push('Connects large-scale celestial cycles to changes in biological fields such as autonomic, cardiovascular, and circadian regulation.');
                } else if (item.category === 'voltage_gates') {
                    fieldLines.push('Describes how ion channels shape local electrical fields in cells and tissues, which then participate in larger bioelectric patterns.');
                } else if (item.category === 'organ_systems') {
                    fieldLines.push('Represents a macroscopic field network (organ system) that integrates many local cellular and electrical processes.');
                }
            }

            if (fieldLines.length) {
                parts.push(`
                    <div>
                        <div class="explain-section-title">Field-Based Interpretation</div>
                        <div class="explain-section-body">
                            <ul style="padding-left: 1.1rem; margin: 0;">
                                ${fieldLines.map(l => `<li style="margin-bottom: 0.25rem;">${l}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `);
            }

            // 3. Connections and combinations
            const chips = [];

            if (Array.isArray(item.biological_correlations) && item.biological_correlations.length) {
                item.biological_correlations.forEach(c => chips.push(c));
            }
            if (Array.isArray(item.related_entries) && item.related_entries.length) {
                item.related_entries.forEach(r => chips.push(r));
            }

            if (chips.length) {
                parts.push(`
                    <div>
                        <div class="explain-section-title">Connections and Combinations</div>
                        <div class="explain-section-body">
                            <div class="explain-chip-row">
                                ${chips.map(c => `<span class="explain-chip">${c.toString().replace(/_/g, ' ')}</span>`).join('')}
                            </div>
                            <div>Use these to trace how this entry might interact with other systems, molecules, or fields in the encyclopedia.</div>
                        </div>
                    </div>
                `);
            }

            return parts.join('');
        }

        function getOrCreateConversationId() {
            let conv = localStorage.getItem('iceburg_conversation_id');
            if (!conv) {
                conv = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                try {
                    localStorage.setItem('iceburg_conversation_id', conv);
                } catch (e) {
                    console.warn('Unable to persist conversation id:', e);
                }
            }
            return conv;
        }

        async function loadExplainFromLLM(item) {
            const section = document.getElementById('explainLLMSection');
            if (!section) return;

            const bodyEl = section.querySelector('.explain-section-body');
            if (!bodyEl) return;

            bodyEl.textContent = 'Thinking with ICEBURG physiology agent...';

            // Build compact context from entry fields – physiology-focused
            const contextParts = [];
            contextParts.push(`Name: ${item.name || item.id}`);
            contextParts.push(`Category: ${item.category || 'unknown'}`);
            if (item.description) {
                contextParts.push(`Description: ${item.description}`);
            }
            if (item.biological_functions && Array.isArray(item.biological_functions)) {
                contextParts.push(`Biological functions: ${item.biological_functions.join(', ')}`);
            }
            if (item.biological_correlations && Array.isArray(item.biological_correlations)) {
                contextParts.push(`Biological correlations: ${item.biological_correlations.join(', ')}`);
            }
            if (item.research_notes) {
                contextParts.push(`Research notes: ${item.research_notes}`);
            }

            const entryContext = contextParts.join('\\n');

            const userPrompt = `
You are explaining an encyclopedia entry to a student who is learning physiology and field-based biology.

ENTRY CONTEXT:
${entryContext}

TASK:
1) Give a precise 3-point summary of what this entry is about, focusing on physiology, fields/bioelectric aspects, and what is actually known vs theoretical.
2) After the 3 points, add one short paragraph (3–5 sentences) explaining how this fits into the broader astro-physiology / field-based model and any key caveats.

Write in clear, professional language with no emojis and no headings. Use numbered or dashed bullets for the three points, then the paragraph.
`;

            const conversationId = getOrCreateConversationId();

            const requestBody = {
                query: userPrompt.trim(),
                mode: 'chat',
                agent: 'physiology',
                degradation_mode: false,
                settings: {
                    // Use Ollama model for testing (llama3:8b is available)
                    // Change back to 'gemini-2.0-flash-exp' when using Gemini provider
                    primaryModel: 'llama3:8b',
                    temperature: 0.4,
                    maxTokens: 700
                },
                files: [],
                data: null,
                conversation_id: conversationId,
                metadata: {
                    source: 'encyclopedia',
                    entry_id: item.id || null,
                    category: item.category || null
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const content = data.result || data.content || data.results?.content;

                if (content && content.trim()) {
                    bodyEl.textContent = content.trim();
                } else {
                    bodyEl.textContent = 'ICEBURG physiology agent did not return a summary. You can still use the core idea and connections below.';
                }
            } catch (error) {
                console.error('Error calling ICEBURG physiology agent:', error);
                bodyEl.textContent = 'Unable to reach ICEBURG physiology agent right now. This is usually due to LLM API limits. Local explanation and connections are still available below.';
            }
        }

        function closeEntryModal() {
            const modal = document.getElementById('entryModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on background click
        document.getElementById('entryModal').addEventListener('click', (e) => {
            if (e.target.id === 'entryModal') {
                closeEntryModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEntryModal();
            }
        });

        // Starfield Animation
        function initStarfield() {
            const canvas = document.getElementById('starfieldCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const stars = [];
            const starCount = 150;
            
            for (let i = 0; i < starCount; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    speed: Math.random() * 0.5 + 0.1,
                    opacity: Math.random() * 0.5 + 0.3
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                stars.forEach(star => {
                    star.y += star.speed;
                    if (star.y > canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * canvas.width;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.fill();
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // Calculate and display statistics
        function updateStats() {
            if (!encyclopediaData) return;
            
            let totalEntries = 0;
            let totalSources = 0;
            const categories = new Set();
            
            Object.keys(encyclopediaData).forEach(category => {
                if (category === 'metadata') return;
                const entries = encyclopediaData[category];
                if (entries && typeof entries === 'object') {
                    totalEntries += Object.keys(entries).length;
                    categories.add(category);
                    
                    Object.values(entries).forEach(entry => {
                        if (entry.sources && Array.isArray(entry.sources)) {
                            totalSources += entry.sources.length;
                        }
                    });
                }
            });
            
            // Animate numbers
            function animateNumber(element, target) {
                const duration = 1500;
                const start = 0;
                const increment = target / (duration / 16);
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        element.textContent = target.toLocaleString();
                        clearInterval(timer);
                    } else {
                        element.textContent = Math.floor(current).toLocaleString();
                    }
                }, 16);
            }
            
            animateNumber(document.getElementById('totalEntries'), totalEntries);
            animateNumber(document.getElementById('totalCategories'), categories.size);
            animateNumber(document.getElementById('totalSources'), totalSources);
        }

        // Filter functionality
        let activeFilter = 'all';
        
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                activeFilter = chip.dataset.filter;
                
                if (activeFilter === 'all') {
                    renderCategories();
                } else {
                    selectCategory(activeFilter);
                }
            });
        });

        // Enhanced load function
        async function loadEncyclopedia() {
            const loadingEl = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorIndicator');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';

            try {
                console.log('Fetching encyclopedia from:', `${API_URL}/api/encyclopedia`);
                const response = await fetch(`${API_URL}/api/encyclopedia`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }
                
                encyclopediaData = await response.json();
                console.log('Encyclopedia data loaded:', Object.keys(encyclopediaData || {}));
                
                if (!encyclopediaData || Object.keys(encyclopediaData).length === 0) {
                    throw new Error('Encyclopedia data is empty');
                }
                
                renderCategories();
                // Auto-select first category if available
                if (categories.length > 0 && encyclopediaData[categories[0].id]) {
                    selectCategory(categories[0].id);
                }
                updateStats();
                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading encyclopedia:', error);
                errorEl.innerHTML = `
                    <div style="padding: 1rem; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 8px; color: #ff6b6b;">
                        <strong>Error loading encyclopedia:</strong><br>
                        ${error.message}<br>
                        <small>API URL: ${API_URL}/api/encyclopedia</small><br>
                        <small>Hostname: ${window.location.hostname}</small><br>
                        <small>If on mobile, ensure backend is accessible at ${API_URL}</small>
                    </div>
                `;
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }

        // News Ticker Functions
        let tickerUpdates = [];
        
        async function loadTickerUpdates() {
            try {
                const response = await fetch(`${API_URL}/api/encyclopedia/news`);
                if (!response.ok) return;
                
                const data = await response.json();
                const articles = data.articles || [];
                
                // Create ticker items from article titles
                tickerUpdates = articles.slice(0, 10).map(article => {
                    const suppressed = article.is_suppressed ? '[SUPPRESSED] ' : '';
                    return `${suppressed}${article.title}`;
                });
                
                if (tickerUpdates.length === 0) {
                    tickerUpdates = ['No new updates available'];
                }
                
                updateTicker();
            } catch (error) {
                console.error('Error loading ticker updates:', error);
                tickerUpdates = ['Unable to load updates'];
                updateTicker();
            }
        }
        
        function updateTicker() {
            const tickerContent = document.getElementById('tickerContent');
            if (!tickerContent) return;
            
            const items = tickerUpdates.map(item => `<span class="ticker-item">${item}</span>`).join('');
            tickerContent.innerHTML = `<span class="ticker-label">Updates:</span>${items}${items}`; // Duplicate for seamless loop
        }

        // News & Updates Functions
        let currentNewsFilter = 'all';
        let newsArticles = [];

        async function loadNews() {
            const newsSection = document.getElementById('newsSection');
            const newsLoading = document.getElementById('newsLoading');
            const newsGrid = document.getElementById('newsGrid');
            const newsBadge = document.getElementById('newsBadge');

            try {
                newsLoading.style.display = 'block';
                newsGrid.innerHTML = '';

                const response = await fetch(`${API_URL}/api/encyclopedia/news`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                newsArticles = data.articles || [];

                // Update badge
                if (newsArticles.length > 0) {
                    newsBadge.textContent = newsArticles.length;
                    newsBadge.style.display = 'block';
                } else {
                    newsBadge.style.display = 'none';
                }

                renderNews(newsArticles);
                newsLoading.style.display = 'none';
            } catch (error) {
                console.error('Error loading news:', error);
                newsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <p>Unable to load news. Please try again later.</p>
                        <small>${error.message}</small>
                    </div>
                `;
                newsLoading.style.display = 'none';
            }
        }

        function renderNews(articles) {
            const newsGrid = document.getElementById('newsGrid');
            
            if (articles.length === 0) {
                newsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <p>No relevant articles found. Check back later for updates.</p>
                    </div>
                `;
                return;
            }

            newsGrid.innerHTML = articles.map(article => {
                const isSuppressed = article.is_suppressed || false;
                const summaryPoints = article.summary_points || [];
                const source = article.source || 'Unknown';
                const type = article.type || 'article';

                return `
                    <div class="news-card ${isSuppressed ? 'suppressed' : ''}" data-filter="${isSuppressed ? 'suppressed' : 'all'}">
                        <div class="news-card-header">
                            <h3 class="news-card-title">${article.title || 'Untitled'}</h3>
                            <span class="news-card-source">${source}</span>
                        </div>
                        ${summaryPoints.length > 0 ? `
                            <div class="news-card-summary">
                                <ul>
                                    ${summaryPoints.map(point => `<li>${point}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="news-card-footer">
                            ${article.url ? `
                                <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="news-card-link">
                                    Read More
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                        <path d="M7 1V13M1 7H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </a>
                            ` : '<span class="news-card-link" style="opacity: 0.5;">No link available</span>'}
                            ${isSuppressed ? '<span class="news-card-badge suppressed">Suppressed Research</span>' : ''}
                            ${type === 'research_paper' ? '<span class="news-card-badge">Research</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterNews(filter) {
            currentNewsFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            let filtered = newsArticles;
            if (filter === 'suppressed') {
                filtered = newsArticles.filter(a => a.is_suppressed);
            } else if (filter === 'recent') {
                // Sort by date if available
                filtered = [...newsArticles].sort((a, b) => {
                    const dateA = new Date(a.published || a.fetched_at || 0);
                    const dateB = new Date(b.published || b.fetched_at || 0);
                    return dateB - dateA;
                }).slice(0, 10);
            } else if (filter === 'breaking') {
                // Filter for recent news (last 7 days)
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                filtered = newsArticles.filter(a => {
                    if (!a.published) return false;
                    const pubDate = new Date(a.published);
                    return pubDate >= weekAgo;
                });
            }

            renderNews(filtered);
        }

        // News event listeners
        document.getElementById('newsToggle')?.addEventListener('click', () => {
            const newsSection = document.getElementById('newsSection');
            const isVisible = newsSection.style.display !== 'none';
            newsSection.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible && newsArticles.length === 0) {
                loadNews();
            }
        });

        document.getElementById('newsRefreshBtn')?.addEventListener('click', () => {
            loadNews();
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                filterNews(btn.dataset.filter);
            });
        });

        // Initialize
        initStarfield();
        loadEncyclopedia();
        loadTickerUpdates();
        
        // Refresh ticker every 5 minutes
        setInterval(loadTickerUpdates, 5 * 60 * 1000);
    
        // Related entry click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('related-entry-link')) {
                e.preventDefault();
                const entryId = e.target.getAttribute('data-entry-id');
                if (entryId && encyclopediaData) {
                    // Find the entry across all categories
                    for (const category in encyclopediaData) {
                        if (category === 'metadata') continue;
                        if (encyclopediaData[category] && encyclopediaData[category][entryId]) {
                            displayEntry(encyclopediaData[category][entryId], category);
                            document.getElementById('entryModal').style.display = 'flex';
                            // Scroll to top of modal
                            document.querySelector('.modal-content').scrollTop = 0;
                            break;
                        }
                    }
                }
            }
        });
    
    </script>
</body>
</html>


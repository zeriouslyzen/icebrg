<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Encyclopedia - ICEBURG</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .encyclopedia-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Celestial Background Animation */
        .celestial-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        #starfieldCanvas {
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }

        .celestial-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse-glow 8s ease-in-out infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 0.3;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* ===== SCIENCE THEME ENHANCEMENTS ===== */

        /* DNA Helix Animation Overlay */
        .science-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }

        .dna-helix {
            position: absolute;
            width: 60px;
            height: 100%;
            left: 2%;
            opacity: 0.08;
        }

        .dna-helix::before,
        .dna-helix::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg,
                    transparent 0px,
                    transparent 20px,
                    rgba(0, 212, 255, 0.4) 20px,
                    rgba(0, 212, 255, 0.4) 22px,
                    transparent 22px,
                    transparent 40px);
            animation: dna-twist 8s linear infinite;
        }

        .dna-helix::after {
            animation-delay: -4s;
            opacity: 0.6;
        }

        @keyframes dna-twist {
            0% {
                transform: translateY(0) rotateY(0deg);
            }

            100% {
                transform: translateY(-40px) rotateY(360deg);
            }
        }

        /* Neural Network Mesh */
        .neural-mesh {
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            opacity: 0.04;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(0, 212, 255, 0.3) 1px, transparent 1px),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 150, 0.3) 1px, transparent 1px),
                radial-gradient(circle at 50% 50%, rgba(0, 255, 136, 0.3) 1px, transparent 1px);
            background-size: 60px 60px, 80px 80px, 100px 100px;
            animation: neural-pulse 6s ease-in-out infinite;
        }

        @keyframes neural-pulse {

            0%,
            100% {
                opacity: 0.04;
            }

            50% {
                opacity: 0.08;
            }
        }

        /* Frequency Waveform */
        .frequency-wave {
            position: absolute;
            bottom: 10%;
            left: 0;
            width: 100%;
            height: 60px;
            opacity: 0.06;
            overflow: hidden;
        }

        .wave-line {
            position: absolute;
            width: 200%;
            height: 2px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(0, 212, 255, 0.8) 25%,
                    rgba(255, 0, 150, 0.8) 50%,
                    rgba(0, 212, 255, 0.8) 75%,
                    transparent 100%);
            animation: wave-scroll 12s linear infinite;
        }

        .wave-line:nth-child(2) {
            top: 20px;
            animation-delay: -4s;
            opacity: 0.7;
        }

        .wave-line:nth-child(3) {
            top: 40px;
            animation-delay: -8s;
            opacity: 0.5;
        }

        @keyframes wave-scroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        /* ===== ICEBURG CHAT ASSISTANT ===== */

        .iceburg-chat-bubble {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(135, 206, 250, 0.3);
            cursor: pointer;
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5), 0 0 20px rgba(135, 206, 250, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .iceburg-chat-bubble:hover {
            transform: scale(1.08);
            border-color: rgba(135, 206, 250, 0.6);
            box-shadow: 0 6px 32px rgba(0, 0, 0, 0.6), 0 0 30px rgba(135, 206, 250, 0.2);
        }

        .iceburg-chat-bubble.hidden {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        .iceburg-chat-bubble svg {
            width: 24px;
            height: 24px;
            color: rgba(135, 206, 250, 0.9);
        }

        @keyframes chat-pulse {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2), inset 0 0 20px rgba(0, 212, 255, 0.05);
            }

            50% {
                box-shadow: 0 4px 30px rgba(0, 212, 255, 0.4), inset 0 0 30px rgba(0, 212, 255, 0.1);
            }
        }

        .iceburg-chat-panel {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 400px;
            height: 520px;
            background: rgba(0, 0, 0, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(135, 206, 250, 0.08);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .iceburg-chat-panel.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .iceburg-chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .iceburg-chat-title {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .iceburg-chat-title::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(135, 206, 250, 0.8);
            box-shadow: 0 0 8px rgba(135, 206, 250, 0.6), 0 0 16px rgba(135, 206, 250, 0.3);
            animation: chatPulse 2s ease-in-out infinite;
        }

        @keyframes chatPulse {

            0%,
            100% {
                opacity: 0.8;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .iceburg-chat-title svg {
            width: 18px;
            height: 18px;
            color: rgba(135, 206, 250, 0.9);
        }

        .iceburg-chat-context {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            padding: 0.5rem 1.25rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .iceburg-chat-close {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .iceburg-chat-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .iceburg-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            animation: message-fade-in 0.3s ease-out;
        }

        @keyframes message-fade-in {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 150, 255, 0.15) 100%);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--text-primary);
        }

        .chat-message.assistant {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .chat-message.typing {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: rgba(0, 212, 255, 0.6);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing-bounce {

            0%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-6px);
            }
        }

        .iceburg-chat-input-container {
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .iceburg-chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 44px;
            max-height: 100px;
            transition: border-color 0.2s;
        }

        .iceburg-chat-input:focus {
            outline: none;
            border-color: rgba(0, 212, 255, 0.5);
        }

        .iceburg-chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .iceburg-chat-send {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(0, 150, 255, 0.2) 100%);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 10px;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(0, 212, 255, 0.9);
            transition: all 0.2s;
        }

        .iceburg-chat-send:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.5) 0%, rgba(0, 150, 255, 0.4) 100%);
            transform: scale(1.05);
        }

        .iceburg-chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== ENHANCED KNOWLEDGE GRAPH ===== */

        .knowledge-graph-overlay {
            background: linear-gradient(135deg, rgba(5, 5, 15, 0.98) 0%, rgba(10, 10, 25, 0.98) 100%) !important;
        }

        .graph-category-legend {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            max-height: 300px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .graph-category-legend h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .legend-item:hover {
            color: var(--text-primary);
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        .graph-stats {
            position: absolute;
            top: 1rem;
            right: 80px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            backdrop-filter: blur(10px);
        }

        .graph-stats span {
            color: rgba(0, 212, 255, 0.9);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .iceburg-chat-panel {
                width: calc(100vw - 32px);
                right: 16px;
                bottom: 80px;
                height: 60vh;
            }

            .graph-category-legend {
                display: none;
            }
        }

        /* ===== RESEARCH TOOLS ===== */

        /* Research Toolbar */
        .research-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            align-items: center;
        }

        .research-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .research-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: rgba(0, 212, 255, 0.4);
        }

        .research-btn.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.5);
            color: rgba(0, 212, 255, 0.9);
        }

        .research-btn svg {
            width: 16px;
            height: 16px;
        }

        .research-btn .count {
            background: rgba(0, 212, 255, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 4px;
        }

        /* Citation Modal */
        .citation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .citation-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .citation-content {
            width: 90%;
            max-width: 600px;
            background: rgba(15, 15, 25, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .citation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .citation-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .citation-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .citation-close:hover {
            color: var(--text-primary);
        }

        .citation-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .citation-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .citation-tab:hover {
            color: var(--text-secondary);
        }

        .citation-tab.active {
            color: rgba(0, 212, 255, 0.9);
            border-bottom-color: rgba(0, 212, 255, 0.9);
        }

        .citation-body {
            padding: 20px;
        }

        .citation-text {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .citation-copy {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: rgba(0, 212, 255, 0.9);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .citation-copy:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .citation-copy.copied {
            background: rgba(0, 255, 136, 0.2);
            border-color: rgba(0, 255, 136, 0.5);
            color: rgba(0, 255, 136, 0.9);
        }

        /* Comparison View */
        .comparison-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .comparison-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(15, 15, 25, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-body {
            flex: 1;
            display: grid;
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            overflow: auto;
            padding: 20px;
        }

        .comparison-column {
            background: rgba(15, 15, 25, 0.98);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-column-header {
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-column-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .comparison-column-header .category {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .comparison-row {
            display: contents;
        }

        .comparison-field {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comparison-field-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }

        .comparison-field-value {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .comparison-highlight {
            background: rgba(0, 212, 255, 0.1);
        }

        /* Entry Selection Checkbox */
        .entry-select {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            background: rgba(0, 0, 0, 0.5);
        }

        .entry-select:hover {
            border-color: rgba(0, 212, 255, 0.5);
        }

        .entry-select.selected {
            background: rgba(0, 212, 255, 0.8);
            border-color: rgba(0, 212, 255, 0.8);
        }

        .entry-select svg {
            display: none;
            width: 12px;
            height: 12px;
            color: white;
        }

        .entry-select.selected svg {
            display: block;
        }

        /* Session Timer */
        .session-timer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 15, 25, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 16px;
            min-width: 200px;
            backdrop-filter: blur(20px);
            z-index: 1500;
            transition: all 0.3s;
            transform: translateY(150%);
        }

        .session-timer.active {
            transform: translateY(0);
        }

        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timer-header h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }

        .timer-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 2px;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            font-family: 'SF Mono', Monaco, monospace;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .timer-display.break {
            color: rgba(0, 255, 136, 0.9);
        }

        .timer-controls {
            display: flex;
            gap: 8px;
        }

        .timer-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .timer-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .timer-btn.primary {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.4);
            color: rgba(0, 212, 255, 0.9);
        }

        .timer-presets {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .timer-preset {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .timer-preset:hover,
        .timer-preset.active {
            border-color: rgba(0, 212, 255, 0.3);
            color: var(--text-secondary);
        }

        /* Progress Dashboard */
        .progress-dashboard {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            background: rgba(15, 15, 25, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(20px);
            z-index: 1500;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            transform: translateX(150%);
            transition: transform 0.3s;
        }

        .progress-dashboard.active {
            transform: translateX(0);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .dashboard-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dashboard-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .dashboard-stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(0, 212, 255, 0.9);
        }

        .progress-ring {
            width: 60px;
            height: 60px;
        }

        .progress-ring-circle {
            stroke: rgba(0, 212, 255, 0.8);
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.3s;
        }

        .progress-ring-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .category-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .category-progress-info {
            flex: 1;
        }

        .category-progress-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .category-progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .category-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.8), rgba(0, 150, 255, 0.8));
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Knowledge Gap Suggestions */
        .knowledge-gap-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .knowledge-gap-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gap-suggestion {
            padding: 10px;
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid rgba(255, 170, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gap-suggestion:hover {
            background: rgba(255, 170, 0, 0.15);
            border-color: rgba(255, 170, 0, 0.4);
        }

        .gap-suggestion-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .gap-suggestion-reason {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Enhanced Hero Section */
        .encyclopedia-hero {
            margin-bottom: 4rem;
            padding: 3rem 0;
            position: relative;
        }

        .hero-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .hero-title-wrapper {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .encyclopedia-title {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: baseline;
            line-height: 1.1;
        }

        .title-main {
            background: linear-gradient(135deg, #ffffff 0%, #cccccc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fade-in-up 0.8s ease-out;
        }

        .title-accent {
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 300;
            letter-spacing: 0.1em;
            animation: fade-in-up 0.8s ease-out 0.2s both;
        }

        .title-underline {
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            margin-top: 1rem;
            animation: expand-width 1s ease-out 0.5s both;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes expand-width {
            from {
                width: 0;
                opacity: 0;
            }

            to {
                width: 120px;
                opacity: 1;
            }
        }

        .encyclopedia-subtitle {
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
            max-width: 700px;
            animation: fade-in-up 0.8s ease-out 0.4s both;
        }

        /* Hero Stats */
        .hero-stats {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            animation: fade-in-up 0.8s ease-out 0.6s both;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-divider {
            width: 1px;
            height: 40px;
            background: var(--border-primary);
        }

        @media (max-width: 768px) {
            .hero-stats {
                gap: 1rem;
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-divider {
                height: 30px;
            }
        }

        /* Enhanced Search */
        .encyclopedia-search-wrapper {
            animation: fade-in-up 0.8s ease-out 0.8s both;
        }

        .encyclopedia-search {
            position: relative;
            max-width: 700px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
        }

        .encyclopedia-search input {
            flex: 1;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        .encyclopedia-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            background: var(--bg-tertiary);
        }

        .search-filter-btn {
            position: absolute;
            right: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-filter-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .filter-chip {
            padding: 0.5rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
        }

        .filter-chip:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .encyclopedia-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            pointer-events: none;
        }

        /* Introduction Section - Academic Style */
        .encyclopedia-intro {
            max-width: 900px;
            margin: 0 auto 3rem;
            animation: fade-in-up 0.8s ease-out 0.2s both;
        }

        .intro-article {
            padding: 2.5rem 3rem;
            background: rgba(8, 8, 12, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 4px;
        }

        .intro-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .intro-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            line-height: 1.35;
            margin-bottom: 0.75rem;
            font-family: 'Times New Roman', Georgia, serif;
        }

        .intro-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
            font-style: italic;
            margin: 0;
        }

        .intro-body {
            margin-bottom: 2rem;
        }

        .intro-section {
            margin-bottom: 1.5rem;
        }

        .intro-section:last-child {
            margin-bottom: 0;
        }

        .intro-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .intro-section p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.75;
            margin: 0;
            text-align: justify;
        }

        .intro-navigation {
            display: flex;
            gap: 0.75rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            justify-content: flex-start;
        }

        .intro-nav-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            color: var(--text-tertiary);
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.02em;
        }

        .intro-nav-link:hover {
            border-color: rgba(255, 255, 255, 0.35);
            color: var(--text-primary);
        }

        .intro-nav-link.secondary {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .intro-nav-link svg {
            opacity: 0.7;
        }

        /* Sidebar Navigation */
        .encyclopedia-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .encyclopedia-sidebar {
            position: sticky;
            top: 2rem;
            height: fit-content;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            padding-right: 1rem;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .sidebar-category-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-category-item {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-category-item:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .sidebar-category-item.active {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .sidebar-category-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .sidebar-category-count {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .encyclopedia-main {
            min-width: 0;
        }

        @media (max-width: 1024px) {
            .encyclopedia-layout {
                grid-template-columns: 1fr;
            }

            .encyclopedia-sidebar {
                position: relative;
                top: 0;
                max-height: none;
                margin-bottom: 2rem;
            }
        }

        .encyclopedia-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 768px) {
            .encyclopedia-categories {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 1rem;
            }

            .encyclopedia-intro {
                padding: 1.5rem;
            }

            .intro-features {
                grid-template-columns: 1fr;
            }
        }

        .category-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 140px;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .category-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
        }

        .category-card:hover::before {
            opacity: 1;
        }

        .category-card.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
        }

        .category-card.active::before {
            opacity: 1;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }


        .category-name {
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1;
        }

        .category-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
            flex: 1;
        }

        .category-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .category-count {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .encyclopedia-content {
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .encyclopedia-content.active {
            display: block;
            opacity: 1;
        }

        .encyclopedia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .encyclopedia-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .encyclopedia-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 2rem;
            transition: all var(--transition-base);
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .encyclopedia-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .item-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .item-id {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .item-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .item-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .item-content {
            color: var(--text-secondary);
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        .item-section {
            margin-bottom: 1.5rem;
        }

        .item-section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }

        .item-section-content {
            font-size: 0.95rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .item-list {
            list-style: none;
            padding: 0;
        }

        .item-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-secondary);
        }

        .item-list li:last-child {
            border-bottom: none;
        }

        .item-key-value {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .item-key-value:last-child {
            border-bottom: none;
        }

        .item-key {
            font-weight: 600;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .item-value {
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .search-results {
            margin-top: 2rem;
        }

        .search-results-header {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .search-results-count {
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-tertiary);
        }

        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #ff6b6b;
            margin: 2rem 0;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all var(--transition-base);
            margin-bottom: 2rem;
        }

        .back-button:hover {
            border-color: var(--accent-primary);
            transform: translateX(-4px);
        }

        /* Encyclopedia Navbar */
        .encyclopedia-navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 2rem;
            margin: -2rem -2rem 0 -2rem;
        }

        .encyclopedia-back-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: 0.75rem;
            margin-left: 2rem;
            background: transparent;
            border: none;
            padding: 0;
        }

        .encyclopedia-back-button:hover {
            color: var(--text-primary);
            transform: translateX(-3px);
        }

        .encyclopedia-back-button svg {
            width: 20px;
            height: 20px;
        }

        /* News Ticker */
        .news-ticker {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
            position: relative;
            height: 36px;
            display: flex;
            align-items: center;
        }

        .ticker-content {
            display: inline-flex;
            align-items: center;
            height: 100%;
            white-space: nowrap;
            animation: ticker-scroll 60s linear infinite;
            will-change: transform;
        }

        .ticker-label {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.8rem;
            margin-right: 1.5rem;
            padding: 0 1rem;
            flex-shrink: 0;
        }

        .ticker-item {
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding-right: 4rem;
            display: inline-block;
        }

        .ticker-item::after {
            content: '  ';
            color: var(--text-tertiary);
            margin: 0 1.5rem;
        }

        @keyframes ticker-scroll {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-50%);
            }
        }

        .ticker-content:hover {
            animation-play-state: paused;
        }


        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all var(--transition-base);
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
        }

        .nav-link:hover {
            color: var(--text-primary);
            border-bottom-color: var(--accent-primary);
        }

        .news-toggle {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .news-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .news-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-primary);
            color: #000;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* News & Updates Section */
        .encyclopedia-news-section {
            margin-top: 4rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(10, 10, 10, 0.6) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .news-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .news-refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.9rem;
        }

        .news-refresh-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .news-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .news-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .news-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all var(--transition-base);
            position: relative;
        }

        .news-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .news-card.suppressed {
            border-left: 3px solid var(--accent-primary);
        }

        .news-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .news-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.4;
        }

        .news-card-source {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .news-card-summary {
            margin: 1rem 0;
        }

        .news-card-summary ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .news-card-summary li {
            padding: 0.5rem 0;
            padding-left: 1.25rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            position: relative;
        }

        .news-card-summary li::before {
            content: '';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: bold;
        }

        .news-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .news-card-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all var(--transition-base);
        }

        .news-card-link:hover {
            text-decoration: underline;
        }

        .news-card-badge {
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        .news-card-badge.suppressed {
            background: rgba(255, 200, 0, 0.2);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        @media (max-width: 768px) {
            .encyclopedia-navbar {
                padding: 1rem;
                margin: -2rem -1rem 2rem -1rem;
            }


            .news-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .encyclopedia-container {
                padding: 1rem;
            }

            .encyclopedia-navbar {
                padding: 0.5rem 1rem;
                margin: -1rem -1rem 0 -1rem;
            }

            .encyclopedia-back-button {
                margin-left: 1rem;
                margin-top: 0.5rem;
            }

            .encyclopedia-title {
                font-size: 2rem;
            }

            .encyclopedia-categories {
                grid-template-columns: 1fr;
            }

            .encyclopedia-grid {
                grid-template-columns: 1fr;
            }

            .item-key-value {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .encyclopedia-item {
                padding: 1.5rem;
            }

            .item-section {
                margin-bottom: 1.5rem;
            }
        }

        /* Prevent text overlap and ensure proper spacing */
        .source-item,
        .study-item {
            margin-bottom: 1rem !important;
            padding: 0.75rem !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .source-item a,
        .study-item a {
            white-space: nowrap;
            display: inline-block;
        }

        .item-section-title {
            margin-bottom: 0.75rem !important;
        }

        /* Entry Card Styles */
        .encyclopedia-item-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 180px;
        }

        .encyclopedia-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .encyclopedia-item-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .encyclopedia-item-card:hover::before {
            opacity: 1;
        }

        .item-card-header {
            margin-bottom: 1rem;
        }

        .item-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .item-card-category {
            display: inline-block;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .item-card-preview {
            flex: 1;
            margin-bottom: 1rem;
        }

        .item-card-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .item-card-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .item-card-view-btn {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--border-primary);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .item-card-view-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.06);
        }

        .item-card-iceburg-btn {
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: 1px solid var(--border-primary);
            background: radial-gradient(circle at 30% 0%, rgba(0, 212, 255, 0.35), transparent 55%), rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .item-card-iceburg-btn:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 18px rgba(0, 212, 255, 0.5);
            transform: translateY(-1px);
        }

        .item-card-iceburg-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Right-side ICEBURG explain panel */
        /* ICEBURG Explanation Panel - Matching Main App Design */
        .entry-explain-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            max-width: 85vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.7);
            z-index: 11000;
            display: flex;
            flex-direction: column;
            transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .entry-explain-panel.active {
            right: 0;
        }

        .entry-explain-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .entry-explain-title {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .entry-explain-title::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(135, 206, 250, 0.8);
            box-shadow: 0 0 8px rgba(135, 206, 250, 0.6), 0 0 16px rgba(135, 206, 250, 0.3);
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                opacity: 0.8;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .entry-explain-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entry-explain-close:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .entry-explain-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .entry-explain-body::-webkit-scrollbar {
            width: 4px;
        }

        .entry-explain-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .entry-explain-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .explain-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(135, 206, 250, 0.8);
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .explain-section-body {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 0.75rem;
        }

        .explain-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .explain-chip {
            padding: 0.25rem 0.65rem;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            font-size: 0.7rem;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
        }

        .explain-chip:hover {
            border-color: rgba(135, 206, 250, 0.3);
            background: rgba(135, 206, 250, 0.05);
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .entry-explain-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* Modal Styles */
        .entry-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            overflow-y: auto;
            padding: 1rem;
        }

        .entry-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .entry-modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 95vh;
            margin: auto;
            position: relative;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .entry-modal-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-primary);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .entry-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .entry-modal-close {
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .entry-modal-close:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .entry-modal-body {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .entry-modal {
                padding: 0;
            }

            .entry-modal-content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .entry-modal-header {
                padding: 1rem 1.5rem;
            }

            .entry-modal-title {
                font-size: 1.25rem;
            }

            .entry-modal-body {
                padding: 1.5rem;
            }

            .encyclopedia-item-card {
                min-height: 160px;
                padding: 1.25rem;
            }
        }

        /* Celestial Dashboard Features */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Connection Visualization */
        .connection-graph {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
        }

        .connection-node {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .connection-node:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        /* ========== FEATURE A: Collapsible Intro ========== */
        .encyclopedia-intro {
            transition: all 0.3s ease;
        }

        .encyclopedia-intro.collapsed {
            padding: 1rem 3rem;
        }

        .encyclopedia-intro.collapsed .intro-content,
        .encyclopedia-intro.collapsed .intro-sections {
            display: none;
        }

        .intro-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .intro-toggle-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .intro-toggle-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .skip-to-entries-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-top: 2rem;
        }

        .skip-to-entries-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* ========== FEATURE B: Reactive Search with Results Count ========== */
        .search-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: var(--text-tertiary);
            min-height: 24px;
        }

        .search-status.active {
            color: var(--text-secondary);
        }

        .search-result-count {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .search-highlight {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            padding: 0 2px;
        }

        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        /* ========== FEATURE C: Research Leads Section ========== */
        .research-leads-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
        }

        .research-leads-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .research-leads-title svg {
            width: 16px;
            height: 16px;
        }

        .research-leads-subsection {
            margin-bottom: 1.25rem;
        }

        .research-leads-subsection:last-child {
            margin-bottom: 0;
        }

        .research-leads-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .research-leads-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .research-lead-tag {
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .research-lead-tag:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .research-leads-questions {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .research-leads-questions li {
            padding: 0.5rem 0;
            padding-left: 1.25rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .research-leads-questions li::before {
            content: '?';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* ========== FEATURE D: Knowledge Graph ========== */
        .knowledge-graph-toggle {
            position: fixed;
            bottom: 32px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            width: 52px;
            height: 52px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
        }

        .knowledge-graph-toggle:hover {
            background: rgba(20, 20, 30, 0.95);
            border-color: rgba(255, 255, 255, 0.25);
            transform: scale(1.08);
        }

        .knowledge-graph-toggle svg {
            width: 22px;
            height: 22px;
            color: rgba(255, 255, 255, 0.85);
        }

        .knowledge-graph-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .knowledge-graph-overlay.active {
            display: flex;
        }

        .knowledge-graph-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .knowledge-graph-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .knowledge-graph-close {
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .knowledge-graph-close:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .knowledge-graph-canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #knowledgeGraphCanvas {
            width: 100%;
            height: 100%;
        }

        .graph-legend {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .graph-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .graph-control-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .graph-control-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Node Hover Popup */
        .graph-node-popup {
            position: absolute;
            pointer-events: none;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            padding: 12px 14px;
            max-width: 320px;
            min-width: 200px;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .graph-node-popup.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .popup-category {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .popup-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 6px 0;
            line-height: 1.3;
        }

        .popup-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0 0 8px 0;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .popup-meta {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: 6px;
        }

        @media (max-width: 768px) {
            .knowledge-graph-toggle {
                bottom: 1rem;
                right: 1rem;
                width: 48px;
                height: 48px;
            }

            .intro-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <!-- Celestial Background Animation -->
    <div class="celestial-background">
        <canvas id="starfieldCanvas"></canvas>
        <div class="celestial-glow"></div>
    </div>

    <!-- Science Theme Overlays -->
    <div class="science-overlay">
        <div class="dna-helix"></div>
        <div class="neural-mesh"></div>
        <div class="frequency-wave">
            <div class="wave-line"></div>
            <div class="wave-line"></div>
            <div class="wave-line"></div>
        </div>
    </div>

    <!-- ICEBURG Chat Assistant -->
    <button class="iceburg-chat-bubble" id="icebergChatBubble" title="Ask ICEBURG">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 19L10 4.5C10.6 3.3 11.1 3 12 3C12.9 3 13.4 3.3 14 4.5L21 19H3Z" />
            <path d="M5 19L9 12L12 17L15 11L19 19H5Z" />
        </svg>
    </button>

    <div class="iceburg-chat-panel" id="icebergChatPanel">
        <div class="iceburg-chat-header">
            <div class="iceburg-chat-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 19L10 4.5C10.6 3.3 11.1 3 12 3C12.9 3 13.4 3.3 14 4.5L21 19H3Z" />
                    <path d="M5 19L9 12L12 17L15 11L19 19H5Z" />
                </svg>
                ICEBURG Assistant
            </div>
            <button class="iceburg-chat-close" id="icebergChatClose">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </div>
        <div class="iceburg-chat-context" id="icebergChatContext">
             Exploring the Celestial Encyclopedia
        </div>
        <div class="iceburg-chat-messages" id="icebergChatMessages">
            <div class="chat-message assistant">
                Welcome! I'm ICEBURG, your physiology and field-theory research assistant. Ask me anything about the
                encyclopedia entries, celestial-biological correlations, or how different systems connect.
            </div>
        </div>
        <div class="iceburg-chat-input-container">
            <textarea class="iceburg-chat-input" id="icebergChatInput" placeholder="Ask about an entry..."
                rows="1"></textarea>
            <button class="iceburg-chat-send" id="icebergChatSend">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Citation Modal -->
    <div class="citation-modal" id="citationModal">
        <div class="citation-content">
            <div class="citation-header">
                <h3> Cite Entry</h3>
                <button class="citation-close" id="citationClose">
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
            </div>
            <div class="citation-tabs">
                <button class="citation-tab active" data-format="bibtex">BibTeX</button>
                <button class="citation-tab" data-format="apa">APA</button>
                <button class="citation-tab" data-format="mla">MLA</button>
            </div>
            <div class="citation-body">
                <div class="citation-text" id="citationText"></div>
                <button class="citation-copy" id="citationCopy">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" />
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                    </svg>
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="comparison-modal" id="comparisonModal">
        <div class="comparison-header">
            <h2> Side-by-Side Comparison</h2>
            <button class="citation-close" id="comparisonClose">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </div>
        <div class="comparison-body" id="comparisonBody">
            <!-- Comparison columns will be generated by JavaScript -->
        </div>
    </div>

    <!-- Session Timer Widget -->
    <div class="session-timer" id="sessionTimer">
        <div class="timer-header">
            <h4> Study Timer</h4>
            <button class="timer-close" id="timerClose">
                <svg width="16" height="16" viewBox="0 0 20 20">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </div>
        <div class="timer-display" id="timerDisplay">25:00</div>
        <div class="timer-controls">
            <button class="timer-btn primary" id="timerStart">Start</button>
            <button class="timer-btn" id="timerReset">Reset</button>
        </div>
        <div class="timer-presets">
            <button class="timer-preset active" data-work="25" data-break="5">25/5</button>
            <button class="timer-preset" data-work="45" data-break="15">45/15</button>
            <button class="timer-preset" data-work="60" data-break="10">60/10</button>
        </div>
        <div class="dashboard-stat"
            style="margin-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
            <span class="dashboard-stat-label">Focus time today</span>
            <span class="dashboard-stat-value" id="totalFocusTime">0m</span>
        </div>
    </div>

    <!-- Progress Dashboard -->
    <div class="progress-dashboard" id="progressDashboard">
        <div class="dashboard-header">
            <h3> Learning Progress</h3>
            <button class="citation-close" id="dashboardClose">
                <svg width="16" height="16" viewBox="0 0 20 20">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-label">Entries Viewed</span>
            <span class="dashboard-stat-value" id="entriesViewed">0</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-label">Categories Explored</span>
            <span class="dashboard-stat-value" id="categoriesExplored">0</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-label">Time Spent</span>
            <span class="dashboard-stat-value" id="timeSpent">0m</span>
        </div>
        <div id="categoryProgressList" style="margin-top: 16px;">
            <!-- Category progress bars will be generated -->
        </div>
        <div class="knowledge-gap-section">
            <div class="knowledge-gap-title">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                    <circle cx="12" cy="17" r="0.5" fill="currentColor" />
                </svg>
                Suggested Next
            </div>
            <div id="knowledgeGapList">
                <!-- AI suggestions will be populated -->
            </div>
        </div>
    </div>

    <!-- Encyclopedia Navbar -->
    <nav class="encyclopedia-navbar">
        <!-- News Ticker -->
        <div class="news-ticker" id="newsTicker">
            <div class="ticker-content" id="tickerContent">
                <span class="ticker-label">Updates:</span>
                <span class="ticker-item">Loading latest research updates...</span>
            </div>
        </div>
    </nav>

    <button class="encyclopedia-back-button" onclick="window.location.href='/'" aria-label="Back to ICEBURG">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>

    <div class="encyclopedia-container">

        <!-- Enhanced Hero Section -->
        <div class="encyclopedia-hero">
            <div class="hero-content">
                <div class="hero-title-wrapper">
                    <h1 class="encyclopedia-title">
                        <span class="title-main">Celestial</span>
                        <span class="title-accent">Encyclopedia</span>
                    </h1>
                    <div class="title-underline"></div>
                </div>
                <!-- Quick Stats -->
                <div class="hero-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalEntries">0</div>
                        <div class="stat-label">Entries</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalSources">0</div>
                        <div class="stat-label">Sources</div>
                    </div>
                </div>

                <!-- Enhanced Search -->
                <div class="encyclopedia-search-wrapper">
                    <div class="encyclopedia-search">
                        <svg class="encyclopedia-search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path
                                d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M19 19L14.65 14.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search entries, categories, or concepts...">
                        <button class="search-filter-btn" id="filterToggle" title="Advanced Filters">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                                <path d="M2 4H16M5 9H13M7 14H11" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                        </button>
                    </div>
                    <!-- Quick Filters -->
                    <div class="quick-filters" id="quickFilters">
                        <button class="filter-chip active" data-filter="all">All</button>
                        <button class="filter-chip" data-filter="celestial_bodies">Celestial</button>
                        <button class="filter-chip" data-filter="neurotransmitters">Neurotransmitters</button>
                        <button class="filter-chip" data-filter="hormones">Hormones</button>
                        <button class="filter-chip" data-filter="tcm_correlations">TCM</button>
                    </div>
                    <!-- Search Status -->
                    <div class="search-status" id="searchStatus"></div>
                </div>
            </div>
        </div>

        <!-- Introduction Section -->
        <div class="encyclopedia-intro" id="encyclopediaIntro">
            <article class="intro-article">
                <header class="intro-header">
                    <h2 class="intro-title">A Systematic Framework for Celestial-Biological Research</h2>
                    <p class="intro-subtitle">Investigating the correlations between electromagnetic phenomena,
                        planetary dynamics, and biological systems through rigorous methodology</p>
                </header>

                <div class="intro-body">
                    <section class="intro-section">
                        <h3>Research Foundation</h3>
                        <p>This encyclopedia synthesizes peer-reviewed research, empirical observations, and
                            evidence-based correlations to map relationships between celestial phenomena and biological
                            processes. Each entry distinguishes between established findings, theoretical models, and
                            speculative hypotheseswith explicit documentation of evidence levels, methodologies, and
                            source publications.</p>
                    </section>

                    <section class="intro-section">
                        <h3>Scope of Investigation</h3>
                        <p>The knowledge base spans multiple domains: from fundamental biological systems
                            (neurotransmitter pathways, hormonal regulation, cellular processes) to environmental
                            phenomena (electromagnetic fields, Schumann resonance, geomagnetic activity) to emerging
                            research areas (quantum biology, coherence systems). This structure enables both targeted
                            inquiry and cross-domain pattern discovery.</p>
                    </section>

                    <section class="intro-section">
                        <h3>Methodological Approach</h3>
                        <p>Advanced pattern recognition methodologies identify recurring correlations across biological
                            and celestial domains. Rather than isolated observations, entries reveal systemic
                            relationshipsdemonstrating how environmental influences manifest across multiple biological
                            scales, from molecular processes to organ function to systemic responses.</p>
                    </section>
                </div>

                <nav class="intro-navigation">
                    <a href="#categoriesContainer" class="intro-nav-link" id="skipToEntriesBtn"
                        title="Jump to 32 research categories including neurotransmitters, hormones, celestial bodies, and quantum biology">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1" />
                            <rect x="14" y="3" width="7" height="7" rx="1" />
                            <rect x="3" y="14" width="7" height="7" rx="1" />
                            <rect x="14" y="14" width="7" height="7" rx="1" />
                        </svg>
                        <span>Browse Categories</span>
                    </a>
                    <button class="intro-nav-link secondary"
                        onclick="document.getElementById('knowledgeGraphToggle').click();"
                        title="Interactive force-directed graph showing 325 entries and 189 connections between research topics">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="18" cy="5" r="3" />
                            <circle cx="6" cy="12" r="3" />
                            <circle cx="18" cy="19" r="3" />
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                        </svg>
                        <span>Connection Map</span>
                    </button>
                </nav>
            </article>
        </div>

        <!-- Research Tools Toolbar -->
        <div class="research-toolbar" id="researchToolbar">
            <button class="research-btn" id="compareBtn" disabled title="Select 2-3 entries to compare">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="18" rx="1" />
                    <rect x="14" y="3" width="7" height="18" rx="1" />
                </svg>
                Compare <span class="count" id="compareCount">0</span>
            </button>
            <button class="research-btn" id="exportBtn" title="Export data to CSV or JSON">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Export
            </button>
            <div class="toolbar-divider"></div>
            <button class="research-btn" id="dashboardBtn" title="View learning progress">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 20V10" />
                    <path d="M12 20V4" />
                    <path d="M6 20v-6" />
                </svg>
                Dashboard
            </button>
            <button class="research-btn" id="timerBtn" title="Study session timer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                Timer
            </button>
        </div>

        <!-- Main Layout with Sidebar -->
        <div class="encyclopedia-layout">
            <!-- Sidebar Navigation -->
            <div class="encyclopedia-sidebar" id="encyclopediaSidebar">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Browse Categories</div>
                    <div class="sidebar-category-list" id="sidebarCategoryList">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="encyclopedia-main">
                <div id="categoriesContainer" class="encyclopedia-categories"></div>
                <div id="contentContainer" class="encyclopedia-content"></div>
            </div>
        </div>
        <div id="searchResults" class="search-results" style="display: none;"></div>

        <!-- News & Updates Section -->
        <section class="encyclopedia-news-section" id="newsSection" style="display: none;">
            <div class="news-header">
                <h2 class="news-title">Research News & Updates</h2>
                <button class="news-refresh-btn" id="newsRefreshBtn">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path
                            d="M9 1V5M9 13V17M1 9H5M13 9H17M3.64 3.64L6.17 6.17M11.83 11.83L14.36 14.36M3.64 14.36L6.17 11.83M11.83 6.17L14.36 3.64"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Refresh
                </button>
            </div>
            <div class="news-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="suppressed">Suppressed Research</button>
                <button class="filter-btn" data-filter="recent">Recent Studies</button>
                <button class="filter-btn" data-filter="breaking">Breaking News</button>
            </div>
            <div class="news-loading" id="newsLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Fetching latest research...</p>
            </div>
            <div class="news-grid" id="newsGrid">
                <!-- News articles will be populated here -->
            </div>
        </section>

        <div id="loadingIndicator" class="loading" style="display: none;">Loading encyclopedia...</div>
        <div id="errorIndicator" class="error" style="display: none;"></div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="entry-modal">
        <div class="entry-modal-content">
            <div class="entry-modal-header">
                <h2 class="entry-modal-title" id="modalTitle">Entry Details</h2>
                <button class="entry-modal-close" onclick="closeEntryModal()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
            </div>
            <div class="entry-modal-body" id="modalBody">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Right-side ICEBURG explain panel -->
    <div id="entryExplainPanel" class="entry-explain-panel">
        <div class="entry-explain-header">
            <div class="entry-explain-title" id="explainTitle">ICEBURG Explanation</div>
            <button class="entry-explain-close" onclick="closeExplainPanel()" aria-label="Close explanation">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
                    <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        </div>
        <div class="entry-explain-body" id="explainBody">
            <!-- Explanation content will be inserted dynamically -->
        </div>
    </div>

    <!-- Knowledge Graph Toggle Button -->
    <button class="knowledge-graph-toggle" id="knowledgeGraphToggle" title="View Connections">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <!-- Hub node in center -->
            <circle cx="12" cy="12" r="2.5" fill="currentColor" stroke="none" />
            <!-- Satellite nodes -->
            <circle cx="5" cy="5" r="2" />
            <circle cx="19" cy="5" r="2" />
            <circle cx="5" cy="19" r="2" />
            <circle cx="19" cy="19" r="2" />
            <!-- Connection lines -->
            <line x1="9.5" y1="9.5" x2="6.8" y2="6.8" />
            <line x1="14.5" y1="9.5" x2="17.2" y2="6.8" />
            <line x1="9.5" y1="14.5" x2="6.8" y2="17.2" />
            <line x1="14.5" y1="14.5" x2="17.2" y2="17.2" />
        </svg>
    </button>

    <!-- Knowledge Graph Overlay -->
    <div class="knowledge-graph-overlay" id="knowledgeGraphOverlay">
        <div class="knowledge-graph-header">
            <h2 class="knowledge-graph-title">Entry Connections</h2>
            <button class="knowledge-graph-close" id="knowledgeGraphClose">Close</button>
        </div>
        <div class="knowledge-graph-canvas-container">
            <canvas id="knowledgeGraphCanvas"></canvas>
            <div class="graph-legend">Drag to pan  Scroll to zoom  Hover for preview  Click to view full entry</div>
            <div class="graph-stats"><span>0</span> nodes  <span>0</span> connections</div>
            <div class="graph-controls">
                <button class="graph-control-btn" id="graphZoomIn" title="Zoom In">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 4V16M4 10H16" />
                    </svg>
                </button>
                <button class="graph-control-btn" id="graphZoomOut" title="Zoom Out">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 10H16" />
                    </svg>
                </button>
                <button class="graph-control-btn" id="graphReset" title="Reset View">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4L16 16M16 4L4 16" />
                    </svg>
                </button>
            </div>
            <!-- Node Hover Popup -->
            <div class="graph-node-popup" id="graphNodePopup">
                <div class="popup-category" id="popupCategory"></div>
                <h4 class="popup-title" id="popupTitle"></h4>
                <p class="popup-description" id="popupDescription"></p>
                <div class="popup-meta" id="popupMeta"></div>
            </div>
        </div>
    </div>

    <script>
        // Use backend API URL (port 8000 for localhost, or detect from environment)
        // On localhost: uses http://localhost:8000 (backend API)
        // On production: uses same origin or configured API URL
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocalhost ? 'http://localhost:8000' : window.location.origin;

        console.log('Encyclopedia API URL:', API_URL, 'Hostname:', window.location.hostname);

        // Make encyclopediaData globally accessible for all scripts (including knowledge graph)
        window.encyclopediaData = null;
        let encyclopediaData = null;
        let currentCategory = null;
        let searchTimeout = null;

        const categories = [
            { id: 'celestial_bodies', name: 'Celestial Bodies', description: 'Planets, stars, and their biological correlations' },
            { id: 'voltage_gates', name: 'Voltage Gates', description: 'Ion channels and neural excitability' },
            { id: 'neurotransmitters', name: 'Neurotransmitters', description: 'Chemical messengers and neural communication' },
            { id: 'hormones', name: 'Hormones', description: 'Endocrine system and hormonal regulation' },
            { id: 'biophysical_parameters', name: 'Biophysical Parameters', description: 'Measurable physiological metrics' },
            { id: 'molecular_chemistry', name: 'Molecular Chemistry', description: 'Molecular structures and configurations' },
            { id: 'electromagnetic_environment', name: 'EM Environment', description: 'Electromagnetic fields and frequencies' },
            { id: 'organ_systems', name: 'Organ Systems', description: 'Cardiovascular, nervous, endocrine, and other major organ systems' },
            { id: 'cellular_processes', name: 'Cellular Processes', description: 'Cell cycle, apoptosis, DNA replication, and cellular mechanisms' },
            { id: 'circadian_biology', name: 'Circadian Biology', description: 'Circadian rhythms, clock genes, and temporal biology' },
            { id: 'quantum_biology', name: 'Quantum Biology', description: 'Quantum effects in biological systems, coherence, and entanglement' },
            { id: 'research_methodologies', name: 'Research Methodologies', description: 'Study designs, biomarkers, statistical methods, and research approaches' },
            { id: 'tcm_correlations', name: 'TCM Correlations', description: 'Traditional Chinese Medicine mappings' },
            { id: 'coherence_systems', name: 'Coherence Systems', description: 'Heart coherence, quantum coherence, biological synchronization' },
            { id: 'morphic_fields', name: 'Morphic Fields', description: 'Morphic resonance theory and field effects' },
            { id: 'vedic_knowledge', name: 'Vedic Knowledge', description: 'Ayurveda, Jyotish, Nakshatras, Doshas' },
            { id: 'schumann_resonance', name: 'Schumann Resonance', description: 'Earth frequency and biological correlations' },
            { id: 'government_research', name: 'Government Research', description: 'Declassified CIA, DIA, Army programs - MK-Ultra, Stargate, Gateway Process, and more' },
            { id: 'suppressed_research', name: 'Suppressed Research', description: 'Marginalized science - Reich, Rife, Tesla, Priore, Becker, and forbidden discoveries' },
            { id: 'occult_psychology', name: 'Occult Psychology', description: 'Jung, synchronicity, collective unconscious, egregores, and consciousness research' },
            { id: 'documented_anomalies', name: 'Documented Anomalies', description: 'Terminal lucidity, placebo surgery, NDEs, acquired savants - measured edge science' },
            { id: 'astro_archaeology', name: 'Astro-Archaeology', description: 'Gbekli Tepe, Stonehenge, Great Pyramid - ancient astronomical alignments' },
            { id: 'ancient_technology', name: 'Ancient Technology', description: 'Antikythera mechanism, Baghdad batteries, Roman concrete - lost capabilities' },
            { id: 'pyramid_studies', name: 'Pyramid Studies', description: 'Electromagnetic focusing (ITMO 2018), acoustic resonance, and materials engineering' },
            { id: 'entheogens', name: 'Entheogens & Sacred Plants', description: 'Eleusinian kykeon, Soma, Ayahuasca, and the pharmacology of ancient rituals' },
            { id: 'mystery_traditions', name: 'Secret Societies', description: 'Pythagoreans, Templars, Rosicrucians, and the lineage of hidden knowledge' },
            { id: 'field_topologies', name: 'Field Topologies', description: 'Cardiac torus fields, cortical standing waves, and other biofield geometries' },
            { id: 'collective_states', name: 'Collective States', description: 'Group coherence, mass attention events, and planetary-scale human states' },
            { id: 'information_dynamics', name: 'Information Dynamics', description: 'HRV coherence, EEG global coherence, and information-theoretic descriptors' },
            { id: 'patents', name: 'Patents', description: 'Patents related to EM fields, consciousness technologies, and biological effects' },
            { id: 'cern_research', name: 'CERN Research', description: 'CERN particle physics research related to biological systems' },
            { id: 'suppressed_physics', name: 'Suppressed Energy Physics', description: 'Zero Point Energy, Scalar Waves, Electrogravitics - physics beyond the standard model' },
            { id: 'forbidden_archaeology', name: 'Forbidden Archaeology', description: 'Giant skeletons, OOPARTS, pre-ice age civilizations, and anomalies ignored by academia' },
            { id: 'resonant_technologies', name: 'Resonant Technologies', description: 'Rife frequencies, Cymatics, MWO, and technologies utilizing harmonic resonance' },
            { id: 'visionary_science', name: 'Visionary Science', description: 'Russell, Schauberger, Reich, Tesla - holistic scientific frameworks' }
        ];

        async function loadEncyclopedia() {
            const loadingEl = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorIndicator');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';

            try {
                console.log('Fetching encyclopedia from:', `${API_URL}/api/encyclopedia`);
                const response = await fetch(`${API_URL}/api/encyclopedia`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }

                encyclopediaData = await response.json();
                window.encyclopediaData = encyclopediaData; // Sync to global for other scripts
                console.log('Encyclopedia data loaded:', Object.keys(encyclopediaData || {}));

                if (!encyclopediaData || Object.keys(encyclopediaData).length === 0) {
                    throw new Error('Encyclopedia data is empty');
                }

                renderCategories();
                // Auto-select first category if available
                if (categories.length > 0 && encyclopediaData[categories[0].id]) {
                    selectCategory(categories[0].id);
                }
                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading encyclopedia:', error);
                errorEl.innerHTML = `
                    <div style="padding: 1rem; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 8px; color: #ff6b6b;">
                        <strong>Error loading encyclopedia:</strong><br>
                        ${error.message}<br>
                        <small>API URL: ${API_URL}/api/encyclopedia</small><br>
                        <small>Hostname: ${window.location.hostname}</small><br>
                        <small>If on mobile, ensure backend is accessible at ${API_URL}</small>
                    </div>
                `;
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }

        // Category icons mapping - SVG icons
        function getCategoryIcon(categoryId) {
            const icons = {
                'celestial_bodies': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'voltage_gates': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>',
                'neurotransmitters': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23M4.22 19.78L7.76 16.24M16.24 7.76L19.78 4.22"/></svg>',
                'hormones': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>',
                'biophysical_parameters': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3H21V21H3V3Z"/><path d="M3 12H21M12 3V21"/><circle cx="8" cy="8" r="1.5"/><circle cx="16" cy="8" r="1.5"/><circle cx="8" cy="16" r="1.5"/><circle cx="16" cy="16" r="1.5"/></svg>',
                'molecular_chemistry': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'electromagnetic_environment': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z"/><path d="M12 6V18M6 12H18"/></svg>',
                'organ_systems': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'cellular_processes': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23M4.22 19.78L7.76 16.24M16.24 7.76L19.78 4.22"/></svg>',
                'circadian_biology': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6V12L16 14"/></svg>',
                'quantum_biology': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/><circle cx="12" cy="12" r="2"/></svg>',
                'research_methodologies': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8C21 7.46957 20.7893 6.96086 20.4142 6.58579C20.0391 6.21071 19.5304 6 19 6H5C4.46957 6 3.96086 6.21071 3.58579 6.58579C3.21071 6.96086 3 7.46957 3 8V16C3 16.5304 3.21071 17.0391 3.58579 17.4142C3.96086 17.7893 4.46957 18 5 18H19C19.5304 18 20.0391 17.7893 20.4142 17.4142C20.7893 17.0391 21 16.5304 21 16Z"/><path d="M7 10H17M7 14H12"/></svg>',
                'tcm_correlations': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23"/></svg>',
                'coherence_systems': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'morphic_fields': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z"/><path d="M12 6V18M6 12H18"/><circle cx="12" cy="12" r="2"/></svg>',
                'vedic_knowledge': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/></svg>',
                'schumann_resonance': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
                'government_research': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>',
                'field_topologies': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M3 12C6 9 9 9 12 12C15 15 18 15 21 12"/><path d="M12 3C9 6 9 9 12 12C15 15 15 18 12 21"/></svg>',
                'collective_states': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="12" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="16" cy="16" r="3"/><path d="M10.5 10.5L13.5 9.5M10.5 13.5L13.5 14.5"/></svg>',
                'information_dynamics': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 15C9 13 11 13 13 15C15 17 17 17 19 15"/><path d="M7 9H9M11 9H17"/></svg>',
                'anomalous_phenomena': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6V12L16 14"/><circle cx="12" cy="18" r="1"/></svg>',
                'patents': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8C21 7.46957 20.7893 6.96086 20.4142 6.58579C20.0391 6.21071 19.5304 6 19 6H5C4.46957 6 3.96086 6.21071 3.58579 6.58579C3.21071 6.96086 3 7.46957 3 8V16C3 16.5304 3.21071 17.0391 3.58579 17.4142C3.96086 17.7893 4.46957 18 5 18H19C19.5304 18 20.0391 17.7893 20.4142 17.4142C20.7893 17.0391 21 16.5304 21 16Z"/></svg>',
                'cern_research': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"/><circle cx="12" cy="12" r="2"/></svg>'
            };
            return icons[categoryId] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg>';
        }

        // Category groups for organization
        const categoryGroups = {
            'Biological Systems': ['voltage_gates', 'neurotransmitters', 'hormones', 'biophysical_parameters', 'organ_systems', 'cellular_processes'],
            'Celestial & EM': ['celestial_bodies', 'electromagnetic_environment', 'schumann_resonance'],
            'Field & Information Geometry': ['field_topologies', 'information_dynamics', 'coherence_systems'],
            'Collective & Anomalous States': ['collective_states', 'anomalous_phenomena', 'morphic_fields'],
            'Research & Methods': ['research_methodologies', 'quantum_biology', 'circadian_biology', 'molecular_chemistry'],
            'Traditional Knowledge': ['tcm_correlations', 'vedic_knowledge'],
            'Institutional Research': ['government_research', 'patents', 'cern_research']
        };

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            const sidebarList = document.getElementById('sidebarCategoryList');

            // Render category cards
            container.innerHTML = categories.map(cat => {
                const count = encyclopediaData[cat.id] ? Object.keys(encyclopediaData[cat.id]).length : 0;
                const description = cat.description || 'Explore entries in this category';

                return `
                    <div class="category-card" data-category="${cat.id}">
                        <div class="category-header">
                            <div class="category-name">${cat.name}</div>
                        </div>
                        <div class="category-description">${description}</div>
                        <div class="category-footer">
                            <span class="category-count">${count} entries</span>
                            <span class="category-badge">Browse</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Render sidebar navigation
            sidebarList.innerHTML = categories.map(cat => {
                const count = encyclopediaData[cat.id] ? Object.keys(encyclopediaData[cat.id]).length : 0;
                return `
                    <div class="sidebar-category-item" data-category="${cat.id}">
                        <span class="sidebar-category-name">${cat.name}</span>
                        <span class="sidebar-category-count">${count}</span>
                    </div>
                `;
            }).join('');

            // Add click handlers for cards
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.dataset.category;
                    selectCategory(category);
                    // Scroll to content
                    document.getElementById('contentContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            // Add click handlers for sidebar
            document.querySelectorAll('.sidebar-category-item').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.dataset.category;
                    selectCategory(category);
                    // Scroll to content
                    document.getElementById('contentContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        }

        function selectCategory(categoryId) {
            currentCategory = categoryId;

            // Update active state for cards
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.toggle('active', card.dataset.category === categoryId);
            });

            // Update active state for sidebar
            document.querySelectorAll('.sidebar-category-item').forEach(item => {
                item.classList.toggle('active', item.dataset.category === categoryId);
            });

            // Show content
            const contentContainer = document.getElementById('contentContainer');
            const searchResults = document.getElementById('searchResults');
            contentContainer.style.display = 'block';
            contentContainer.classList.add('active');
            searchResults.style.display = 'none';

            if (!encyclopediaData || !encyclopediaData[categoryId]) {
                contentContainer.innerHTML = '<div class="error">Category data not found</div>';
                return;
            }

            const categoryData = encyclopediaData[categoryId];
            const items = Object.entries(categoryData).map(([id, data]) => ({ id, ...data }));

            contentContainer.innerHTML = `
                <h2 style="margin-bottom: 2rem; font-size: 1.5rem;">${categories.find(c => c.id === categoryId)?.name || categoryId}</h2>
                <div class="encyclopedia-grid">
                    ${items.map(item => renderItem(item, true)).join('')}
                </div>
            `;
        }

        function renderItem(item, isCompact = false) {
            if (isCompact) {
                // Derive a preview text so every entry has a visible summary on the card
                const previewSource =
                    item.description ||
                    item.research_notes ||
                    item.origin_story ||
                    (Array.isArray(item.biological_correlations) && item.biological_correlations.length
                        ? `Biological correlations: ${item.biological_correlations.join(', ')}`
                        : '') ||
                    (item.evidence_level ? `Evidence level: ${item.evidence_level}` : '');

                const previewText = previewSource
                    ? previewSource.toString().substring(0, 220) + (previewSource.length > 220 ? '...' : '')
                    : '';

                // Compact card view for grid
                return `
                    <div class="encyclopedia-item-card" data-item-id="${item.id}" data-category="${item.category || ''}">
                        <div class="item-card-header">
                            <div class="item-card-name">${item.name || item.id}</div>
                            ${item.category ? `<span class="item-card-category">${item.category.replace(/_/g, ' ')}</span>` : ''}
                        </div>
                        <div class="item-card-preview">
                            ${previewText ? `<div class="item-card-description">${previewText}</div>` : ''}
                        </div>
                        <div class="item-card-footer">
                            <button class="item-card-view-btn" onclick="openEntryModal('${item.id}', '${item.category || ''}')">View Details</button>
                            <button class="item-card-iceburg-btn" onclick="openExplainPanel('${item.id}', '${item.category || ''}')"
                                title="Explain with ICEBURG">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 19L10 4.5C10.6 3.3 11.1 3 12 3C12.9 3 13.4 3.3 14 4.5L21 19H3Z"/>
                                    <path d="M5 19L9 12L12 17L15 11L19 19H5Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
            // Full view (legacy, for search results)
            return `
                <div class="encyclopedia-item">
                    <div class="item-header">
                        <div class="item-id">${item.id || 'N/A'}</div>
                        <div class="item-name">${item.name || item.id}</div>
                        ${item.category ? `<span class="item-category">${item.category}</span>` : ''}
                    </div>
                    <div class="item-content">
                        ${renderItemSections(item)}
                    </div>
                </div>
            `;
        }

        function renderItemSections(item) {
            const sections = [];

            // Description (always show, even if placeholder)
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Description</div>
                    <div class="item-section-content">
                        ${item.description || 'Not yet documented for this entry in the current encyclopedia version.'}
                    </div>
                </div>
            `);

            // Render key-value pairs (structured details)
            const excludeKeys = ['id', 'name', 'category', 'description', 'sources', 'studies', 'research_notes', 'origin_story'];
            const keyValuePairs = Object.entries(item)
                .filter(([key]) => !excludeKeys.includes(key))
                .filter(([_, value]) => value !== null && value !== undefined && value !== '');

            if (keyValuePairs.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Details</div>
                        <div class="item-section-content">
                            ${keyValuePairs.map(([key, value]) => {
                    if (Array.isArray(value)) {
                        const formattedArray = value.map(v => formatValue(v)).join(', ');
                        return `
                                        <div class="item-key-value">
                                            <div class="item-key">${formatKey(key)}</div>
                                            <div class="item-value">${formattedArray}</div>
                                        </div>
                                    `;
                    } else if (typeof value === 'object' && value !== null) {
                        // Format objects nicely - check if it's a simple object with arrays of numbers (like TCM data)
                        const entries = Object.entries(value);
                        const isSimpleNumberArrays = entries.every(([k, v]) => Array.isArray(v) && v.every(item => typeof item === 'number'));

                        if (isSimpleNumberArrays && entries.length > 0) {
                            // Display as a clean list of key-value pairs
                            return `
                                            <div class="item-key-value" style="margin-bottom: 8px;">
                                                <div class="item-key" style="font-weight: 600; margin-bottom: 4px; color: var(--accent-primary);">${formatKey(key)}</div>
                                                <div class="item-value" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 6px; font-size: 0.9em;">
                                                    ${entries.map(([subKey, subValue]) => `
                                                        <div style="padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                                            <strong style="color: #ccc;">${formatKey(subKey)}:</strong>
                                                            <span style="color: #999; margin-left: 4px;">${Array.isArray(subValue) ? subValue.join(', ') : formatValue(subValue)}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `;
                        } else {
                            // Complex object - format as nested structure
                            let formattedValue = '';
                            if (Array.isArray(value)) {
                                formattedValue = value.map((item, idx) => {
                                    if (typeof item === 'object' && item !== null) {
                                        const objStr = Object.entries(item)
                                            .map(([k, v]) => {
                                                let val = v;
                                                if (typeof v === 'object' && v !== null) {
                                                    if (Array.isArray(v)) {
                                                        val = v.map(item => formatValue(item)).join(', ');
                                                    } else {
                                                        val = Object.entries(v).map(([sk, sv]) => `${formatKey(sk)}: ${formatValue(sv)}`).join(', ');
                                                    }
                                                } else {
                                                    val = formatValue(v);
                                                }
                                                return `${formatKey(k)}: ${val}`;
                                            })
                                            .join(', ');
                                        return `${idx + 1}. ${objStr}`;
                                    }
                                    return formatValue(String(item));
                                }).join('; ');
                            } else {
                                // Format object as key-value pairs
                                formattedValue = Object.entries(value)
                                    .map(([k, v]) => {
                                        const formattedKey = formatKey(k);
                                        let val = v;
                                        if (typeof v === 'object' && v !== null) {
                                            if (Array.isArray(v)) {
                                                val = v.map(item => formatValue(item)).join(', ');
                                            } else {
                                                val = Object.entries(v).map(([sk, sv]) => `${formatKey(sk)}: ${formatValue(sv)}`).join(', ');
                                            }
                                        } else {
                                            val = formatValue(v);
                                        }
                                        return `${formattedKey}: ${val}`;
                                    })
                                    .join('; ');
                            }
                            return `
                                            <div class="item-key-value">
                                                <div class="item-key">${formatKey(key)}</div>
                                                <div class="item-value">${formattedValue || 'N/A'}</div>
                                            </div>
                                        `;
                        }
                    } else {
                        return `
                                        <div class="item-key-value">
                                            <div class="item-key">${formatKey(key)}</div>
                                            <div class="item-value">${formatValue(value)}</div>
                                        </div>
                                    `;
                    }
                }).join('')}
                        </div>
                    </div>
                `);
            }

            // Evidence Level Badge (always show, defaulting when missing)
            const evidenceColors = {
                'measured': { bg: 'rgba(76, 175, 80, 0.2)', color: '#4caf50', border: '#4caf50' },
                'theoretical': { bg: 'rgba(33, 150, 243, 0.2)', color: '#2196f3', border: '#2196f3' },
                'speculative': { bg: 'rgba(255, 152, 0, 0.2)', color: '#ff9800', border: '#ff9800' },
                'documented': { bg: 'rgba(156, 39, 176, 0.2)', color: '#9c27b0', border: '#9c27b0' }
            };
            const evidenceKey = item.evidence_level || 'theoretical';
            const colors = evidenceColors[evidenceKey] || evidenceColors.theoretical;
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Evidence Level</div>
                    <div class="item-section-content">
                        <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background: ${colors.bg}; color: ${colors.color}; border: 1px solid ${colors.border};">
                            ${evidenceKey}
                        </span>
                    </div>
                </div>
            `);

            // Related Entries
            if (item.related_entries && item.related_entries.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Related Entries</div>
                        <div class="item-section-content">
                            ${item.related_entries.map(relId => {
                    const relName = relId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    return `<a href="#" class="related-entry-link" data-entry-id="${relId}" style="display: inline-block; margin: 0.25rem 0.5rem 0.25rem 0; padding: 0.25rem 0.5rem; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 4px; color: var(--accent-primary); text-decoration: none; font-size: 0.85rem; transition: all 0.2s;">${relName}</a>`;
                }).join('')}
                        </div>
                    </div>
                `);
            }

            // Research notes (always show, with clear placeholder)
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Research Notes</div>
                    <div class="item-section-content">
                        ${item.research_notes || 'Research notes for this entry have not yet been written. This indicates an area for future evidence review and synthesis.'}
                    </div>
                </div>
            `);

            // Sources
            if (item.sources && item.sources.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Sources</div>
                        <div class="item-section-content">
                            ${item.sources.map(source => `
                                <div class="source-item" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.02); border-left: 3px solid var(--accent-primary);">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                        ${source.title || 'Research Paper'}
                                        ${source.url ? `<a href="${source.url}" target="_blank" style="color: var(--accent-primary); text-decoration: none; margin-left: 0.5rem; font-size: 0.85rem; white-space: nowrap;">[Link]</a>` : ''}
                                    </div>
                                    ${source.authors ? `<div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">${Array.isArray(source.authors) ? source.authors.join(', ') : source.authors}</div>` : ''}
                                    ${source.journal ? `<div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">${source.journal}${source.year ? ` (${source.year})` : ''}</div>` : ''}
                                    ${source.doi ? `<div style="font-size: 0.8rem; color: var(--text-tertiary); word-break: break-all;">DOI: <a href="https://doi.org/${source.doi}" target="_blank" style="color: var(--accent-primary);">${source.doi}</a></div>` : ''}
                                    ${source.patent_number ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">Patent: ${source.patent_number}${source.url ? ` <a href="${source.url}" target="_blank" style="color: var(--accent-primary);">[View Patent]</a>` : ''}</div>` : ''}
                                    ${source.cern_document_number ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">CERN Doc: ${source.cern_document_number}${source.url ? ` <a href="${source.url}" target="_blank" style="color: var(--accent-primary);">[View Document]</a>` : ''}</div>` : ''}
                                    ${source.key_findings ? `<div style="margin-top: 0.5rem; font-size: 0.9rem; font-style: italic;">${source.key_findings}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `);
            }

            // Studies
            if (item.studies && item.studies.length > 0) {
                sections.push(`
                    <div class="item-section">
                        <div class="item-section-title">Studies</div>
                        <div class="item-section-content">
                            ${item.studies.map(study => `
                                <div class="study-item" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.02); border-left: 3px solid var(--accent-secondary);">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                        ${study.study_type ? study.study_type.replace('_', ' ').toUpperCase() : 'Study'}
                                        ${study.sample_size ? ` (n=${study.sample_size})` : ''}
                                        ${study.duration ? ` - ${study.duration}` : ''}
                                    </div>
                                    ${study.findings ? `<div style="margin-bottom: 0.5rem;">${study.findings}</div>` : ''}
                                    ${study.methodology ? `<div style="font-size: 0.85rem; color: var(--text-tertiary);">Methodology: ${study.methodology}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `);
            }

            // Origin Story (always show, with placeholder when missing)
            sections.push(`
                <div class="item-section">
                    <div class="item-section-title">Origin Story</div>
                    <div class="item-section-content" style="font-style: italic; line-height: 1.8;">
                        ${item.origin_story || 'Origin story and historical context for this entry are not yet documented. They will be added as the encyclopedia is expanded.'}
                    </div>
                </div>
            `);

            return sections.join('');
        }

        function formatKey(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatValue(value) {
            if (typeof value === 'string') {
                // Replace underscores with spaces and capitalize
                return value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            return value;
        }

        async function searchEncyclopedia(query) {
            if (!query || query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                if (currentCategory) {
                    selectCategory(currentCategory);
                }
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/encyclopedia/search/${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displaySearchResults(data);
            } catch (error) {
                console.error('Error searching:', error);
            }
        }

        function displaySearchResults(data) {
            const searchResults = document.getElementById('searchResults');
            const contentContainer = document.getElementById('contentContainer');

            contentContainer.style.display = 'none';
            searchResults.style.display = 'block';

            searchResults.innerHTML = `
                <div class="search-results-header">
                    Search Results for "${data.query}"
                    <span class="search-results-count">(${data.count} found)</span>
                </div>
                <div class="encyclopedia-grid">
                    ${data.results.map(result => renderItem(result.data)).join('')}
                </div>
            `;
        }

        // Search input handler
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchEncyclopedia(query);
            }, 300);
        });

        // Modal Functions
        function openEntryModal(itemId, categoryId) {
            if (!encyclopediaData || !encyclopediaData[categoryId] || !encyclopediaData[categoryId][itemId]) {
                console.error('Entry not found:', itemId, categoryId);
                return;
            }

            const item = { id: itemId, ...encyclopediaData[categoryId][itemId] };
            const modal = document.getElementById('entryModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = item.name || item.id;
            modalBody.innerHTML = renderItemSections(item);

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Scroll to top
            modal.scrollTop = 0;
        }

        // ICEBURG Explain side panel
        function openExplainPanel(itemId, categoryId) {
            if (!encyclopediaData || !encyclopediaData[categoryId] || !encyclopediaData[categoryId][itemId]) {
                console.error('Explain entry not found:', itemId, categoryId);
                return;
            }

            const item = { id: itemId, ...encyclopediaData[categoryId][itemId] };
            const panel = document.getElementById('entryExplainPanel');
            const titleEl = document.getElementById('explainTitle');
            const bodyEl = document.getElementById('explainBody');

            if (!panel || !titleEl || !bodyEl) return;

            titleEl.textContent = item.name || item.id || 'ICEBURG Explanation';
            bodyEl.innerHTML = buildExplainContent(item);

            // Kick off LLM-based summary from ICEBURG physiology agent
            try {
                loadExplainFromLLM(item);
            } catch (e) {
                console.error('Error starting LLM explain:', e);
            }

            panel.classList.add('active');
        }

        function closeExplainPanel() {
            const panel = document.getElementById('entryExplainPanel');
            if (panel) panel.classList.remove('active');
        }

        function buildExplainContent(item) {
            const parts = [];

            // 0. ICEBURG physiology LLM summary placeholder (will be filled asynchronously)
            parts.push(`
                <div id="explainLLMSection">
                    <div class="explain-section-title">ICEBURG Physiology Summary</div>
                    <div class="explain-section-body">
                        Connecting to ICEBURG physiology agent for a 3point summary...
                    </div>
                </div>
            `);

            // 1. Core idea  local, deterministic explanation as a fallback/context
            const baseText =
                item.description ||
                item.research_notes ||
                item.origin_story ||
                'This entry has not yet been fully explained in student-friendly language. It is part of the encyclopedia schema and will be expanded.';

            parts.push(`
                <div>
                    <div class="explain-section-title">Core Idea (Local)</div>
                    <div class="explain-section-body">
                        ${baseText}
                    </div>
                </div>
            `);

            // 2. How this fits ICEBURG / field model
            let fieldLines = [];
            if (Array.isArray(item.field_model_mapping) && item.field_model_mapping.length) {
                fieldLines = item.field_model_mapping;
            } else {
                // Derive a basic mapping from category when explicit mapping is missing
                if (item.category === 'celestial_bodies') {
                    fieldLines.push('Connects large-scale celestial cycles to changes in biological fields such as autonomic, cardiovascular, and circadian regulation.');
                } else if (item.category === 'voltage_gates') {
                    fieldLines.push('Describes how ion channels shape local electrical fields in cells and tissues, which then participate in larger bioelectric patterns.');
                } else if (item.category === 'organ_systems') {
                    fieldLines.push('Represents a macroscopic field network (organ system) that integrates many local cellular and electrical processes.');
                }
            }

            if (fieldLines.length) {
                parts.push(`
                    <div>
                        <div class="explain-section-title">Field-Based Interpretation</div>
                        <div class="explain-section-body">
                            <ul style="padding-left: 1.1rem; margin: 0;">
                                ${fieldLines.map(l => `<li style="margin-bottom: 0.25rem;">${l}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `);
            }

            // 3. Connections and combinations
            const chips = [];

            if (Array.isArray(item.biological_correlations) && item.biological_correlations.length) {
                item.biological_correlations.forEach(c => chips.push(c));
            }
            if (Array.isArray(item.related_entries) && item.related_entries.length) {
                item.related_entries.forEach(r => chips.push(r));
            }

            if (chips.length) {
                parts.push(`
                    <div>
                        <div class="explain-section-title">Connections and Combinations</div>
                        <div class="explain-section-body">
                            <div class="explain-chip-row">
                                ${chips.map(c => `<span class="explain-chip">${c.toString().replace(/_/g, ' ')}</span>`).join('')}
                            </div>
                            <div>Use these to trace how this entry might interact with other systems, molecules, or fields in the encyclopedia.</div>
                        </div>
                    </div>
                `);
            }

            return parts.join('');
        }

        function getOrCreateConversationId() {
            let conv = localStorage.getItem('iceburg_conversation_id');
            if (!conv) {
                conv = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                try {
                    localStorage.setItem('iceburg_conversation_id', conv);
                } catch (e) {
                    console.warn('Unable to persist conversation id:', e);
                }
            }
            return conv;
        }

        async function loadExplainFromLLM(item) {
            const section = document.getElementById('explainLLMSection');
            if (!section) return;

            const bodyEl = section.querySelector('.explain-section-body');
            if (!bodyEl) return;

            bodyEl.textContent = 'Thinking with ICEBURG physiology agent...';

            // Build compact context from entry fields  physiology-focused
            const contextParts = [];
            contextParts.push(`Name: ${item.name || item.id}`);
            contextParts.push(`Category: ${item.category || 'unknown'}`);
            if (item.description) {
                contextParts.push(`Description: ${item.description}`);
            }
            if (item.biological_functions && Array.isArray(item.biological_functions)) {
                contextParts.push(`Biological functions: ${item.biological_functions.join(', ')}`);
            }
            if (item.biological_correlations && Array.isArray(item.biological_correlations)) {
                contextParts.push(`Biological correlations: ${item.biological_correlations.join(', ')}`);
            }
            if (item.research_notes) {
                contextParts.push(`Research notes: ${item.research_notes}`);
            }

            const entryContext = contextParts.join('\\n');

            const userPrompt = `
You are explaining an encyclopedia entry to a student who is learning physiology and field-based biology.

ENTRY CONTEXT:
${entryContext}

TASK:
1) Give a precise 3-point summary of what this entry is about, focusing on physiology, fields/bioelectric aspects, and what is actually known vs theoretical.
2) After the 3 points, add one short paragraph (35 sentences) explaining how this fits into the broader astro-physiology / field-based model and any key caveats.

Write in clear, professional language with no emojis and no headings. Use numbered or dashed bullets for the three points, then the paragraph.
`;

            const conversationId = getOrCreateConversationId();

            const requestBody = {
                query: userPrompt.trim(),
                mode: 'chat',
                agent: 'physiology',
                degradation_mode: false,
                settings: {
                    // Use Ollama model for testing (llama3:8b is available)
                    // Change back to 'gemini-2.0-flash-exp' when using Gemini provider
                    primaryModel: 'llama3:8b',
                    temperature: 0.4,
                    maxTokens: 700
                },
                files: [],
                data: null,
                conversation_id: conversationId,
                metadata: {
                    source: 'encyclopedia',
                    entry_id: item.id || null,
                    category: item.category || null
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const content = data.result || data.content || data.results?.content;

                if (content && content.trim()) {
                    bodyEl.textContent = content.trim();
                } else {
                    bodyEl.textContent = 'ICEBURG physiology agent did not return a summary. You can still use the core idea and connections below.';
                }
            } catch (error) {
                console.error('Error calling ICEBURG physiology agent:', error);
                bodyEl.textContent = 'Unable to reach ICEBURG physiology agent right now. This is usually due to LLM API limits. Local explanation and connections are still available below.';
            }
        }

        function closeEntryModal() {
            const modal = document.getElementById('entryModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on background click
        document.getElementById('entryModal').addEventListener('click', (e) => {
            if (e.target.id === 'entryModal') {
                closeEntryModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEntryModal();
            }
        });

        // Starfield Animation
        function initStarfield() {
            const canvas = document.getElementById('starfieldCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const stars = [];
            const starCount = 150;

            for (let i = 0; i < starCount; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    speed: Math.random() * 0.5 + 0.1,
                    opacity: Math.random() * 0.5 + 0.3
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                stars.forEach(star => {
                    star.y += star.speed;
                    if (star.y > canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * canvas.width;
                    }

                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }

            animate();

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // Calculate and display statistics
        function updateStats() {
            if (!encyclopediaData) return;

            let totalEntries = 0;
            let totalSources = 0;
            const categories = new Set();

            Object.keys(encyclopediaData).forEach(category => {
                if (category === 'metadata') return;
                const entries = encyclopediaData[category];
                if (entries && typeof entries === 'object') {
                    totalEntries += Object.keys(entries).length;
                    categories.add(category);

                    Object.values(entries).forEach(entry => {
                        if (entry.sources && Array.isArray(entry.sources)) {
                            totalSources += entry.sources.length;
                        }
                    });
                }
            });

            // Animate numbers
            function animateNumber(element, target) {
                const duration = 1500;
                const start = 0;
                const increment = target / (duration / 16);
                let current = start;

                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        element.textContent = target.toLocaleString();
                        clearInterval(timer);
                    } else {
                        element.textContent = Math.floor(current).toLocaleString();
                    }
                }, 16);
            }

            animateNumber(document.getElementById('totalEntries'), totalEntries);
            animateNumber(document.getElementById('totalCategories'), categories.size);
            animateNumber(document.getElementById('totalSources'), totalSources);
        }

        // Filter functionality
        let activeFilter = 'all';

        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                activeFilter = chip.dataset.filter;

                if (activeFilter === 'all') {
                    renderCategories();
                } else {
                    selectCategory(activeFilter);
                }
            });
        });

        // Enhanced load function
        async function loadEncyclopedia() {
            const loadingEl = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorIndicator');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';

            try {
                console.log('Fetching encyclopedia from:', `${API_URL}/api/encyclopedia`);
                const response = await fetch(`${API_URL}/api/encyclopedia`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }

                encyclopediaData = await response.json();
                window.encyclopediaData = encyclopediaData; // Sync to global for other scripts
                console.log('Encyclopedia data loaded:', Object.keys(encyclopediaData || {}));

                if (!encyclopediaData || Object.keys(encyclopediaData).length === 0) {
                    throw new Error('Encyclopedia data is empty');
                }

                renderCategories();
                // Auto-select first category if available
                if (categories.length > 0 && encyclopediaData[categories[0].id]) {
                    selectCategory(categories[0].id);
                }
                updateStats();
                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading encyclopedia:', error);
                errorEl.innerHTML = `
                    <div style="padding: 1rem; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 8px; color: #ff6b6b;">
                        <strong>Error loading encyclopedia:</strong><br>
                        ${error.message}<br>
                        <small>API URL: ${API_URL}/api/encyclopedia</small><br>
                        <small>Hostname: ${window.location.hostname}</small><br>
                        <small>If on mobile, ensure backend is accessible at ${API_URL}</small>
                    </div>
                `;
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }

        // News Ticker Functions
        let tickerUpdates = [];

        async function loadTickerUpdates() {
            try {
                const response = await fetch(`${API_URL}/api/encyclopedia/news`);
                if (!response.ok) return;

                const data = await response.json();
                const articles = data.articles || [];

                // Create ticker items from article titles
                tickerUpdates = articles.slice(0, 10).map(article => {
                    const suppressed = article.is_suppressed ? '[SUPPRESSED] ' : '';
                    return `${suppressed}${article.title}`;
                });

                if (tickerUpdates.length === 0) {
                    tickerUpdates = ['No new updates available'];
                }

                updateTicker();
            } catch (error) {
                console.error('Error loading ticker updates:', error);
                tickerUpdates = ['Unable to load updates'];
                updateTicker();
            }
        }

        function updateTicker() {
            const tickerContent = document.getElementById('tickerContent');
            if (!tickerContent) return;

            const items = tickerUpdates.map(item => `<span class="ticker-item">${item}</span>`).join('');
            tickerContent.innerHTML = `<span class="ticker-label">Updates:</span>${items}${items}`; // Duplicate for seamless loop
        }

        // News & Updates Functions
        let currentNewsFilter = 'all';
        let newsArticles = [];

        async function loadNews() {
            const newsSection = document.getElementById('newsSection');
            const newsLoading = document.getElementById('newsLoading');
            const newsGrid = document.getElementById('newsGrid');
            const newsBadge = document.getElementById('newsBadge');

            try {
                newsLoading.style.display = 'block';
                newsGrid.innerHTML = '';

                const response = await fetch(`${API_URL}/api/encyclopedia/news`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                newsArticles = data.articles || [];

                // Update badge
                if (newsArticles.length > 0) {
                    newsBadge.textContent = newsArticles.length;
                    newsBadge.style.display = 'block';
                } else {
                    newsBadge.style.display = 'none';
                }

                renderNews(newsArticles);
                newsLoading.style.display = 'none';
            } catch (error) {
                console.error('Error loading news:', error);
                newsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <p>Unable to load news. Please try again later.</p>
                        <small>${error.message}</small>
                    </div>
                `;
                newsLoading.style.display = 'none';
            }
        }

        function renderNews(articles) {
            const newsGrid = document.getElementById('newsGrid');

            if (articles.length === 0) {
                newsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <p>No relevant articles found. Check back later for updates.</p>
                    </div>
                `;
                return;
            }

            newsGrid.innerHTML = articles.map(article => {
                const isSuppressed = article.is_suppressed || false;
                const summaryPoints = article.summary_points || [];
                const source = article.source || 'Unknown';
                const type = article.type || 'article';

                return `
                    <div class="news-card ${isSuppressed ? 'suppressed' : ''}" data-filter="${isSuppressed ? 'suppressed' : 'all'}">
                        <div class="news-card-header">
                            <h3 class="news-card-title">${article.title || 'Untitled'}</h3>
                            <span class="news-card-source">${source}</span>
                        </div>
                        ${summaryPoints.length > 0 ? `
                            <div class="news-card-summary">
                                <ul>
                                    ${summaryPoints.map(point => `<li>${point}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="news-card-footer">
                            ${article.url ? `
                                <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="news-card-link">
                                    Read More
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                        <path d="M7 1V13M1 7H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </a>
                            ` : '<span class="news-card-link" style="opacity: 0.5;">No link available</span>'}
                            ${isSuppressed ? '<span class="news-card-badge suppressed">Suppressed Research</span>' : ''}
                            ${type === 'research_paper' ? '<span class="news-card-badge">Research</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterNews(filter) {
            currentNewsFilter = filter;

            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            let filtered = newsArticles;
            if (filter === 'suppressed') {
                filtered = newsArticles.filter(a => a.is_suppressed);
            } else if (filter === 'recent') {
                // Sort by date if available
                filtered = [...newsArticles].sort((a, b) => {
                    const dateA = new Date(a.published || a.fetched_at || 0);
                    const dateB = new Date(b.published || b.fetched_at || 0);
                    return dateB - dateA;
                }).slice(0, 10);
            } else if (filter === 'breaking') {
                // Filter for recent news (last 7 days)
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                filtered = newsArticles.filter(a => {
                    if (!a.published) return false;
                    const pubDate = new Date(a.published);
                    return pubDate >= weekAgo;
                });
            }

            renderNews(filtered);
        }

        // News event listeners
        document.getElementById('newsToggle')?.addEventListener('click', () => {
            const newsSection = document.getElementById('newsSection');
            const isVisible = newsSection.style.display !== 'none';
            newsSection.style.display = isVisible ? 'none' : 'block';

            if (!isVisible && newsArticles.length === 0) {
                loadNews();
            }
        });

        document.getElementById('newsRefreshBtn')?.addEventListener('click', () => {
            loadNews();
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                filterNews(btn.dataset.filter);
            });
        });

        // Initialize
        initStarfield();
        loadEncyclopedia();
        loadTickerUpdates();

        // Refresh ticker every 5 minutes
        setInterval(loadTickerUpdates, 5 * 60 * 1000);

        // Related entry click handler
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('related-entry-link')) {
                e.preventDefault();
                const entryId = e.target.getAttribute('data-entry-id');
                if (entryId && encyclopediaData) {
                    // Find the entry across all categories
                    for (const category in encyclopediaData) {
                        if (category === 'metadata') continue;
                        if (encyclopediaData[category] && encyclopediaData[category][entryId]) {
                            displayEntry(encyclopediaData[category][entryId], category);
                            document.getElementById('entryModal').style.display = 'flex';
                            // Scroll to top of modal
                            document.querySelector('.modal-content').scrollTop = 0;
                            break;
                        }
                    }
                }
            }
        });

        // ========== FEATURE A: Collapsible Intro ==========
        const introSection = document.getElementById('encyclopediaIntro');
        const introToggleBtn = document.getElementById('introToggleBtn');
        const introToggleText = document.getElementById('introToggleText');
        const skipToEntriesBtn = document.getElementById('skipToEntriesBtn');

        // Check localStorage for preference
        const introCollapsed = localStorage.getItem('encyclopediaIntroCollapsed') === 'true';
        if (introCollapsed) {
            introSection?.classList.add('collapsed');
            if (introToggleText) introToggleText.textContent = 'Expand';
        }

        introToggleBtn?.addEventListener('click', () => {
            const isCollapsed = introSection.classList.toggle('collapsed');
            localStorage.setItem('encyclopediaIntroCollapsed', isCollapsed);
            introToggleText.textContent = isCollapsed ? 'Expand' : 'Collapse';
        });

        skipToEntriesBtn?.addEventListener('click', () => {
            document.getElementById('categoriesContainer')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Also collapse the intro
            introSection?.classList.add('collapsed');
            localStorage.setItem('encyclopediaIntroCollapsed', 'true');
            if (introToggleText) introToggleText.textContent = 'Expand';
        });

        // ========== FEATURE B: Reactive Instant Search ==========
        const searchInput = document.getElementById('searchInput');
        const searchStatus = document.getElementById('searchStatus');
        let searchDebounceTimer = null;

        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function searchAllEntries(query) {
            if (!encyclopediaData || !query) return [];

            const results = [];
            const lowerQuery = query.toLowerCase();

            for (const categoryId in encyclopediaData) {
                if (categoryId === 'metadata') continue;
                const categoryData = encyclopediaData[categoryId];
                if (!categoryData || typeof categoryData !== 'object') continue;

                for (const entryId in categoryData) {
                    const entry = categoryData[entryId];
                    const searchFields = [
                        entry.name || entryId,
                        entry.description || '',
                        entry.research_notes || '',
                        entry.origin_story || '',
                        Array.isArray(entry.biological_correlations) ? entry.biological_correlations.join(' ') : '',
                        Array.isArray(entry.related_entries) ? entry.related_entries.join(' ') : ''
                    ].join(' ').toLowerCase();

                    if (searchFields.includes(lowerQuery)) {
                        results.push({ ...entry, id: entryId, category: categoryId });
                    }
                }
            }

            return results;
        }

        function renderReactiveSearchResults(results, query) {
            const contentContainer = document.getElementById('contentContainer');
            const searchResults = document.getElementById('searchResults');
            const categoriesContainer = document.getElementById('categoriesContainer');

            if (results.length === 0) {
                searchResults.style.display = 'none';
                contentContainer.style.display = 'none';
                categoriesContainer.style.display = 'grid';
                searchStatus.innerHTML = `No results found for "<strong>${query}</strong>"`;
                searchStatus.classList.add('active');
                return;
            }

            // Hide normal views, show search results
            categoriesContainer.style.display = 'none';
            contentContainer.style.display = 'none';
            searchResults.style.display = 'block';

            searchStatus.innerHTML = `<span class="search-result-count">${results.length}</span> entries found for "<strong>${query}</strong>"`;
            searchStatus.classList.add('active');

            searchResults.innerHTML = `
                <div class="search-results-grid">
                    ${results.map(item => {
                const name = highlightText(item.name || item.id, query);
                const desc = item.description ? highlightText(item.description.substring(0, 150), query) + '...' : '';
                return `
                            <div class="encyclopedia-item-card" data-item-id="${item.id}" data-category="${item.category}">
                                <div class="item-card-header">
                                    <div class="item-card-name">${name}</div>
                                    <span class="item-card-category">${item.category.replace(/_/g, ' ')}</span>
                                </div>
                                <div class="item-card-preview">
                                    <div class="item-card-description">${desc}</div>
                                </div>
                                <div class="item-card-footer">
                                    <button class="item-card-view-btn" onclick="openEntryModal('${item.id}', '${item.category}')">View Details</button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function clearSearch() {
            const searchResults = document.getElementById('searchResults');
            const categoriesContainer = document.getElementById('categoriesContainer');
            searchResults.style.display = 'none';
            categoriesContainer.style.display = 'grid';
            searchStatus.innerHTML = '';
            searchStatus.classList.remove('active');
        }

        searchInput?.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            clearTimeout(searchDebounceTimer);

            if (!query) {
                clearSearch();
                return;
            }

            searchStatus.innerHTML = 'Searching...';
            searchStatus.classList.add('active');

            searchDebounceTimer = setTimeout(() => {
                const results = searchAllEntries(query);
                renderReactiveSearchResults(results, query);
            }, 150);
        });

        // ========== FEATURE C: Research Leads in Modal ==========
        function renderResearchLeads(item) {
            // Check if item has research_leads or generate from related_entries
            const leads = item.research_leads || {};
            const relatedEntries = item.related_entries || [];

            // Generate search terms from entry name and key fields
            const searchTerms = leads.search_terms || [];
            if (searchTerms.length === 0 && item.name) {
                searchTerms.push(item.name);
                if (item.category) searchTerms.push(item.category.replace(/_/g, ' '));
            }

            // Generate rabbit hole questions based on entry type
            const questions = leads.rabbit_holes || [];
            if (questions.length === 0) {
                if (item.evidence_level === 'Suppressed' || item.category === 'suppressed_research') {
                    questions.push('What led to the suppression of this research?');
                    questions.push('Are there modern replications or continuations?');
                }
                if (relatedEntries.length > 0) {
                    questions.push(`How does this connect to ${relatedEntries[0]}?`);
                }
            }

            // Only render if we have content
            if (searchTerms.length === 0 && questions.length === 0 && relatedEntries.length === 0) {
                return '';
            }

            return `
                <div class="research-leads-section">
                    <div class="research-leads-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21L16.65 16.65"/>
                        </svg>
                        Research Leads
                    </div>
                    ${searchTerms.length > 0 ? `
                        <div class="research-leads-subsection">
                            <div class="research-leads-label">Search Terms</div>
                            <div class="research-leads-tags">
                                ${searchTerms.map(term => `
                                    <span class="research-lead-tag" onclick="document.getElementById('searchInput').value='${term}';document.getElementById('searchInput').dispatchEvent(new Event('input'));">${term}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${relatedEntries.length > 0 ? `
                        <div class="research-leads-subsection">
                            <div class="research-leads-label">Connected Entries</div>
                            <div class="research-leads-tags">
                                ${relatedEntries.slice(0, 5).map(entry => `
                                    <span class="research-lead-tag related-entry-link" data-entry-id="${entry}">${entry.replace(/_/g, ' ')}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${questions.length > 0 ? `
                        <div class="research-leads-subsection">
                            <div class="research-leads-label">Questions to Explore</div>
                            <ul class="research-leads-questions">
                                ${questions.map(q => `<li>${q}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Patch the existing openEntryModal to include research leads
        const originalOpenEntryModal = window.openEntryModal;
        window.openEntryModal = function (entryId, categoryId) {
            if (originalOpenEntryModal) {
                originalOpenEntryModal(entryId, categoryId);
            }

            // After modal renders, append research leads
            setTimeout(() => {
                const modalBody = document.getElementById('modalBody');
                if (modalBody && encyclopediaData && encyclopediaData[categoryId] && encyclopediaData[categoryId][entryId]) {
                    const item = encyclopediaData[categoryId][entryId];
                    const researchLeadsHtml = renderResearchLeads({ ...item, id: entryId, category: categoryId });
                    if (researchLeadsHtml && !modalBody.querySelector('.research-leads-section')) {
                        modalBody.insertAdjacentHTML('beforeend', researchLeadsHtml);
                    }
                }
            }, 100);
        };

        // ========== FEATURE D: Knowledge Graph - ADVANCED FORCE-DIRECTED ==========
        const graphToggle = document.getElementById('knowledgeGraphToggle');
        const graphOverlay = document.getElementById('knowledgeGraphOverlay');
        const graphClose = document.getElementById('knowledgeGraphClose');
        const graphCanvas = document.getElementById('knowledgeGraphCanvas');
        let graphCtx = null;
        let graphNodes = [];
        let graphEdges = [];
        let graphTransform = { x: 0, y: 0, scale: 1, vx: 0, vy: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let animationId = null;
        let isSimulating = true;
        let selectedNode = null;
        let hoveredNode = null;
        let lastTime = 0;
        let pulsePhase = 0;

        // Category color palette - science-inspired
        const categoryColors = {
            'celestial_bodies': '#00d4ff',
            'voltage_gates': '#ff6b9d',
            'neurotransmitters': '#00ff88',
            'hormones': '#ffaa00',
            'biophysical_parameters': '#aa88ff',
            'molecular_chemistry': '#ff4466',
            'electromagnetic_environment': '#00ffff',
            'organ_systems': '#ff88aa',
            'cellular_processes': '#88ff88',
            'circadian_biology': '#ffdd44',
            'quantum_biology': '#dd88ff',
            'research_methodologies': '#88ddff',
            'tcm_correlations': '#ffbb88',
            'coherence_systems': '#88ffdd',
            'morphic_fields': '#ff88dd',
            'vedic_knowledge': '#ddaa88',
            'schumann_resonance': '#88aaff',
            'government_research': '#aaaaaa',
            'suppressed_research': '#ff4444',
            'occult_psychology': '#aa44aa',
            'documented_anomalies': '#44aaaa',
            'astro_archaeology': '#ddbb66',
            'ancient_technology': '#998866',
            'pyramid_studies': '#ddcc88',
            'entheogens': '#66aa66',
            'mystery_traditions': '#886688',
            'field_topologies': '#66dddd',
            'collective_states': '#dd6688',
            'information_dynamics': '#6688dd',
            'patents': '#888888',
            'cern_research': '#4488dd',
            'suppressed_physics': '#dd4488',
            'forbidden_archaeology': '#88aa44',
            'resonant_technologies': '#44ddaa',
            'visionary_science': '#aa44dd'
        };

        // Physics constants
        const PHYSICS = {
            repulsion: 3000,
            attraction: 0.008,
            damping: 0.92,
            centerGravity: 0.01,
            maxVelocity: 15,
            minDistance: 30,
            edgeLength: 120
        };

        function getNodeColor(category) {
            return categoryColors[category] || '#ffffff';
        }

        function buildGraphData() {
            // Use window.encyclopediaData for cross-script access
            const data = window.encyclopediaData || encyclopediaData;
            if (!data) return;

            graphNodes = [];
            graphEdges = [];
            const nodeMap = {};

            // Build nodes with physics properties
            let nodeIndex = 0;
            const totalNodes = Object.keys(data).reduce((sum, cat) => {
                if (cat === 'metadata') return sum;
                return sum + Object.keys(data[cat] || {}).length;
            }, 0);

            for (const categoryId in data) {
                if (categoryId === 'metadata') continue;
                const categoryData = data[categoryId];
                if (!categoryData || typeof categoryData !== 'object') continue;

                for (const entryId in categoryData) {
                    const entry = categoryData[entryId];
                    const angle = (nodeIndex / totalNodes) * Math.PI * 2 + Math.random() * 0.5;
                    const radius = 150 + Math.random() * 350;

                    nodeMap[entryId] = graphNodes.length;
                    graphNodes.push({
                        id: entryId,
                        name: entry.name || entryId,
                        category: categoryId,
                        x: Math.cos(angle) * radius,
                        y: Math.sin(angle) * radius,
                        vx: 0,
                        vy: 0,
                        radius: 5 + Math.min(5, (entry.related_entries?.length || 0) * 0.5),
                        color: getNodeColor(categoryId),
                        connections: entry.related_entries?.length || 0
                    });
                    nodeIndex++;
                }
            }

            // Build edges
            for (const categoryId in data) {
                if (categoryId === 'metadata') continue;
                const categoryData = data[categoryId];
                if (!categoryData || typeof categoryData !== 'object') continue;

                for (const entryId in categoryData) {
                    const entry = categoryData[entryId];
                    const relatedEntries = entry.related_entries || [];
                    const sourceIndex = nodeMap[entryId];

                    for (const relatedId of relatedEntries) {
                        const targetIndex = nodeMap[relatedId];
                        if (targetIndex !== undefined && sourceIndex !== targetIndex) {
                            // Avoid duplicate edges
                            const exists = graphEdges.some(e =>
                                (e.source === sourceIndex && e.target === targetIndex) ||
                                (e.source === targetIndex && e.target === sourceIndex)
                            );
                            if (!exists) {
                                graphEdges.push({
                                    source: sourceIndex,
                                    target: targetIndex,
                                    pulseOffset: Math.random() * Math.PI * 2
                                });
                            }
                        }
                    }
                }
            }
        }

        function applyPhysics(deltaTime) {
            if (!isSimulating || graphNodes.length === 0) return;

            const dt = Math.min(deltaTime, 50) / 1000;

            // Apply repulsion between all nodes
            for (let i = 0; i < graphNodes.length; i++) {
                for (let j = i + 1; j < graphNodes.length; j++) {
                    const nodeA = graphNodes[i];
                    const nodeB = graphNodes[j];

                    const dx = nodeB.x - nodeA.x;
                    const dy = nodeB.y - nodeA.y;
                    const distance = Math.sqrt(dx * dx + dy * dy) || 1;

                    if (distance < PHYSICS.minDistance * 10) {
                        const force = PHYSICS.repulsion / (distance * distance);
                        const fx = (dx / distance) * force * dt;
                        const fy = (dy / distance) * force * dt;

                        nodeA.vx -= fx;
                        nodeA.vy -= fy;
                        nodeB.vx += fx;
                        nodeB.vy += fy;
                    }
                }
            }

            // Apply attraction along edges
            for (const edge of graphEdges) {
                const source = graphNodes[edge.source];
                const target = graphNodes[edge.target];

                const dx = target.x - source.x;
                const dy = target.y - source.y;
                const distance = Math.sqrt(dx * dx + dy * dy) || 1;

                const force = (distance - PHYSICS.edgeLength) * PHYSICS.attraction * dt;
                const fx = (dx / distance) * force;
                const fy = (dy / distance) * force;

                source.vx += fx;
                source.vy += fy;
                target.vx -= fx;
                target.vy -= fy;
            }

            // Apply center gravity and update positions
            for (const node of graphNodes) {
                // Center gravity
                node.vx -= node.x * PHYSICS.centerGravity * dt;
                node.vy -= node.y * PHYSICS.centerGravity * dt;

                // Apply damping
                node.vx *= PHYSICS.damping;
                node.vy *= PHYSICS.damping;

                // Clamp velocity
                const speed = Math.sqrt(node.vx * node.vx + node.vy * node.vy);
                if (speed > PHYSICS.maxVelocity) {
                    node.vx = (node.vx / speed) * PHYSICS.maxVelocity;
                    node.vy = (node.vy / speed) * PHYSICS.maxVelocity;
                }

                // Update position (skip if being dragged)
                if (node !== selectedNode) {
                    node.x += node.vx;
                    node.y += node.vy;
                }
            }
        }

        function drawGraph(timestamp) {
            if (!graphCtx || !graphCanvas) return;

            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            pulsePhase += deltaTime * 0.002;

            // Apply momentum to pan
            if (!isDragging) {
                graphTransform.x += graphTransform.vx;
                graphTransform.y += graphTransform.vy;
                graphTransform.vx *= 0.95;
                graphTransform.vy *= 0.95;
            }

            applyPhysics(deltaTime);

            const width = graphCanvas.width;
            const height = graphCanvas.height;

            // Clear with gradient background
            const bgGradient = graphCtx.createRadialGradient(width / 2, height / 2, 0, width / 2, height / 2, width / 2);
            bgGradient.addColorStop(0, 'rgba(10, 10, 20, 1)');
            bgGradient.addColorStop(1, 'rgba(5, 5, 10, 1)');
            graphCtx.fillStyle = bgGradient;
            graphCtx.fillRect(0, 0, width, height);

            graphCtx.save();

            // Apply transform with smooth centering
            graphCtx.translate(width / 2 + graphTransform.x, height / 2 + graphTransform.y);
            graphCtx.scale(graphTransform.scale, graphTransform.scale);

            // Draw edges with animated pulses
            for (const edge of graphEdges) {
                const source = graphNodes[edge.source];
                const target = graphNodes[edge.target];
                if (!source || !target) continue;

                const isConnectedToHovered = hoveredNode &&
                    (source === hoveredNode || target === hoveredNode);

                // Base edge
                graphCtx.beginPath();
                graphCtx.moveTo(source.x, source.y);
                graphCtx.lineTo(target.x, target.y);

                if (isConnectedToHovered) {
                    graphCtx.strokeStyle = `rgba(0, 212, 255, 0.6)`;
                    graphCtx.lineWidth = 2 / graphTransform.scale;
                } else {
                    graphCtx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
                    graphCtx.lineWidth = 1 / graphTransform.scale;
                }
                graphCtx.stroke();

                // Animated pulse on connected edges
                if (isConnectedToHovered) {
                    const pulsePos = (Math.sin(pulsePhase + edge.pulseOffset) + 1) / 2;
                    const px = source.x + (target.x - source.x) * pulsePos;
                    const py = source.y + (target.y - source.y) * pulsePos;

                    graphCtx.beginPath();
                    graphCtx.arc(px, py, 3 / graphTransform.scale, 0, Math.PI * 2);
                    graphCtx.fillStyle = 'rgba(0, 212, 255, 0.8)';
                    graphCtx.fill();
                }
            }

            // Draw nodes with glow
            for (const node of graphNodes) {
                const isHovered = node === hoveredNode;
                const isConnected = hoveredNode && graphEdges.some(e =>
                    (graphNodes[e.source] === hoveredNode && graphNodes[e.target] === node) ||
                    (graphNodes[e.target] === hoveredNode && graphNodes[e.source] === node)
                );

                // Glow effect
                if (isHovered || isConnected) {
                    const glowGradient = graphCtx.createRadialGradient(
                        node.x, node.y, 0,
                        node.x, node.y, (node.radius * 3) / graphTransform.scale
                    );
                    glowGradient.addColorStop(0, node.color + '60');
                    glowGradient.addColorStop(1, 'transparent');
                    graphCtx.fillStyle = glowGradient;
                    graphCtx.fillRect(
                        node.x - 30 / graphTransform.scale,
                        node.y - 30 / graphTransform.scale,
                        60 / graphTransform.scale,
                        60 / graphTransform.scale
                    );
                }

                // Node circle
                graphCtx.beginPath();
                graphCtx.arc(node.x, node.y, node.radius / graphTransform.scale, 0, Math.PI * 2);

                if (isHovered) {
                    graphCtx.fillStyle = '#ffffff';
                    graphCtx.shadowColor = node.color;
                    graphCtx.shadowBlur = 20;
                } else {
                    graphCtx.fillStyle = node.color + (isConnected ? 'ff' : '99');
                    graphCtx.shadowBlur = 0;
                }
                graphCtx.fill();
                graphCtx.shadowBlur = 0;

                // Label for hovered node
                if (isHovered) {
                    const fontSize = Math.max(12, 14 / graphTransform.scale);
                    graphCtx.font = `600 ${fontSize}px Inter, system-ui, sans-serif`;
                    graphCtx.fillStyle = '#ffffff';
                    graphCtx.textAlign = 'center';

                    // Background for label
                    const textMetrics = graphCtx.measureText(node.name);
                    const labelY = node.y - (node.radius + 8) / graphTransform.scale;
                    graphCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    graphCtx.fillRect(
                        node.x - textMetrics.width / 2 - 8,
                        labelY - fontSize,
                        textMetrics.width + 16,
                        fontSize + 8
                    );

                    graphCtx.fillStyle = '#ffffff';
                    graphCtx.fillText(node.name, node.x, labelY);
                }
            }

            graphCtx.restore();

            // Continue animation
            if (graphOverlay.classList.contains('active')) {
                animationId = requestAnimationFrame(drawGraph);
            }
        }

        function getMousePos(e) {
            const rect = graphCanvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left - graphCanvas.width / 2 - graphTransform.x) / graphTransform.scale,
                y: (e.clientY - rect.top - graphCanvas.height / 2 - graphTransform.y) / graphTransform.scale
            };
        }

        function findNodeAt(mouseX, mouseY) {
            for (const node of graphNodes) {
                const dx = mouseX - node.x;
                const dy = mouseY - node.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < (node.radius + 10) / graphTransform.scale) {
                    return node;
                }
            }
            return null;
        }

        function initKnowledgeGraph() {
            if (!graphCanvas) return;

            graphCanvas.width = graphCanvas.parentElement.clientWidth;
            graphCanvas.height = graphCanvas.parentElement.clientHeight;
            graphCtx = graphCanvas.getContext('2d');

            buildGraphData();
            graphTransform = { x: 0, y: 0, scale: 0.7, vx: 0, vy: 0 };
            isSimulating = true;
            lastTime = performance.now();

            // Update stats
            const statsEl = document.querySelector('.graph-stats');
            if (statsEl) {
                statsEl.innerHTML = `<span>${graphNodes.length}</span> nodes  <span>${graphEdges.length}</span> connections`;
            }

            // Start animation
            if (animationId) cancelAnimationFrame(animationId);
            animationId = requestAnimationFrame(drawGraph);

            // Mouse events with momentum
            let lastMousePos = { x: 0, y: 0 };
            let lastMouseTime = 0;

            graphCanvas.addEventListener('mousedown', (e) => {
                const mouse = getMousePos(e);
                const node = findNodeAt(mouse.x, mouse.y);

                if (node) {
                    selectedNode = node;
                } else {
                    isDragging = true;
                    dragStart = { x: e.clientX - graphTransform.x, y: e.clientY - graphTransform.y };
                }
                lastMousePos = { x: e.clientX, y: e.clientY };
                lastMouseTime = performance.now();
                graphTransform.vx = 0;
                graphTransform.vy = 0;
            });

            graphCanvas.addEventListener('mousemove', (e) => {
                const mouse = getMousePos(e);
                const prevHovered = hoveredNode;
                hoveredNode = findNodeAt(mouse.x, mouse.y);
                graphCanvas.style.cursor = hoveredNode ? 'pointer' : (isDragging ? 'grabbing' : 'grab');

                // Show/hide hover popup
                const popup = document.getElementById('graphNodePopup');
                if (hoveredNode && !selectedNode && !isDragging) {
                    // Only update content if hovered node changed
                    if (hoveredNode !== prevHovered) {
                        // Find entry by searching through category objects
                        let entry = null;
                        if (window.encyclopediaData) {
                            for (const cat in window.encyclopediaData) {
                                if (cat === 'metadata' || typeof window.encyclopediaData[cat] !== 'object') continue;
                                if (window.encyclopediaData[cat][hoveredNode.id]) {
                                    entry = { id: hoveredNode.id, ...window.encyclopediaData[cat][hoveredNode.id], category: cat };
                                    break;
                                }
                            }
                        }
                        if (entry) {
                            document.getElementById('popupCategory').textContent = entry.category || 'Research Entry';
                            document.getElementById('popupTitle').textContent = entry.name || hoveredNode.id;
                            document.getElementById('popupDescription').textContent =
                                entry.description || entry.research_notes || entry.mechanism || 'No description available';
                            // Count actual connections from graph edges
                            const connectionCount = graphEdges.filter(e =>
                                graphNodes[e.source]?.id === hoveredNode.id ||
                                graphNodes[e.target]?.id === hoveredNode.id
                            ).length;
                            // Count sources (array of source objects)
                            const sourceCount = Array.isArray(entry.sources) ? entry.sources.length : 0;
                            // Count studies if available
                            const studyCount = Array.isArray(entry.studies) ? entry.studies.length : 0;
                            const totalSources = sourceCount + studyCount;
                            document.getElementById('popupMeta').textContent =
                                `${connectionCount} connections  ${totalSources} sources`;
                        }
                    }
                    // Position popup near cursor
                    const rect = graphCanvas.getBoundingClientRect();
                    let popupX = e.clientX - rect.left + 15;
                    let popupY = e.clientY - rect.top + 15;
                    // Keep popup in bounds
                    if (popupX + 320 > rect.width) popupX = e.clientX - rect.left - 335;
                    if (popupY + 150 > rect.height) popupY = e.clientY - rect.top - 165;
                    popup.style.left = popupX + 'px';
                    popup.style.top = popupY + 'px';
                    popup.classList.add('visible');
                } else {
                    popup.classList.remove('visible');
                }

                if (selectedNode) {
                    selectedNode.x = mouse.x;
                    selectedNode.y = mouse.y;
                    selectedNode.vx = 0;
                    selectedNode.vy = 0;
                } else if (isDragging) {
                    const now = performance.now();
                    const dt = now - lastMouseTime;
                    if (dt > 0) {
                        graphTransform.vx = (e.clientX - lastMousePos.x) / dt * 10;
                        graphTransform.vy = (e.clientY - lastMousePos.y) / dt * 10;
                    }
                    graphTransform.x = e.clientX - dragStart.x;
                    graphTransform.y = e.clientY - dragStart.y;
                    lastMousePos = { x: e.clientX, y: e.clientY };
                    lastMouseTime = now;
                }
            });

            graphCanvas.addEventListener('mouseup', () => {
                selectedNode = null;
                isDragging = false;
            });

            graphCanvas.addEventListener('mouseleave', () => {
                selectedNode = null;
                isDragging = false;
                hoveredNode = null;
                document.getElementById('graphNodePopup').classList.remove('visible');
            });

            graphCanvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomFactor = e.deltaY > 0 ? 0.92 : 1.08;
                const newScale = Math.max(0.2, Math.min(3, graphTransform.scale * zoomFactor));

                // Zoom toward mouse position
                const mouse = getMousePos(e);
                const scaleDiff = newScale - graphTransform.scale;
                graphTransform.x -= mouse.x * scaleDiff;
                graphTransform.y -= mouse.y * scaleDiff;
                graphTransform.scale = newScale;
            }, { passive: false });

            graphCanvas.addEventListener('click', (e) => {
                const mouse = getMousePos(e);
                const node = findNodeAt(mouse.x, mouse.y);
                if (node && !isDragging) {
                    // Keep graph open but open modal on top
                    // The graph remains visible behind the modal
                    openEntryModal(node.id, node.category);
                }
            });

            // Touch support
            let lastTouchDist = 0;
            graphCanvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    isDragging = true;
                    dragStart = { x: touch.clientX - graphTransform.x, y: touch.clientY - graphTransform.y };
                } else if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    lastTouchDist = Math.sqrt(dx * dx + dy * dy);
                }
            }, { passive: true });

            graphCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && isDragging) {
                    const touch = e.touches[0];
                    graphTransform.x = touch.clientX - dragStart.x;
                    graphTransform.y = touch.clientY - dragStart.y;
                } else if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const scale = dist / lastTouchDist;
                    graphTransform.scale = Math.max(0.2, Math.min(3, graphTransform.scale * scale));
                    lastTouchDist = dist;
                }
            }, { passive: false });

            graphCanvas.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        graphToggle?.addEventListener('click', () => {
            graphOverlay.classList.add('active');
            setTimeout(initKnowledgeGraph, 100);
        });

        graphClose?.addEventListener('click', () => {
            graphOverlay.classList.remove('active');
            if (animationId) cancelAnimationFrame(animationId);
        });

        document.getElementById('graphZoomIn')?.addEventListener('click', () => {
            graphTransform.scale = Math.min(3, graphTransform.scale * 1.3);
        });

        document.getElementById('graphZoomOut')?.addEventListener('click', () => {
            graphTransform.scale = Math.max(0.2, graphTransform.scale * 0.7);
        });

        document.getElementById('graphReset')?.addEventListener('click', () => {
            graphTransform = { x: 0, y: 0, scale: 0.7, vx: 0, vy: 0 };
            buildGraphData();
        });

        // ========== FEATURE E: ICEBURG CHAT ASSISTANT ==========
        const chatBubble = document.getElementById('icebergChatBubble');
        const chatPanel = document.getElementById('icebergChatPanel');
        const chatClose = document.getElementById('icebergChatClose');
        const chatMessages = document.getElementById('icebergChatMessages');
        const chatInput = document.getElementById('icebergChatInput');
        const chatSend = document.getElementById('icebergChatSend');
        const chatContext = document.getElementById('icebergChatContext');
        let chatCurrentEntry = null;
        let chatIsLoading = false;

        function updateChatContext(entry, category) {
            chatCurrentEntry = { entry, category };
            if (chatContext) {
                if (entry) {
                    chatContext.textContent = ` Viewing: ${entry.name || entry.id} (${category?.replace(/_/g, ' ') || 'Unknown'})`;
                } else {
                    chatContext.textContent = ' Exploring the Celestial Encyclopedia';
                }
            }
        }

        function addChatMessage(content, isUser = false) {
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            messageEl.textContent = content;
            chatMessages?.appendChild(messageEl);
            chatMessages?.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }

        function showTypingIndicator() {
            const typingEl = document.createElement('div');
            typingEl.className = 'chat-message assistant typing';
            typingEl.id = 'typingIndicator';
            typingEl.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            chatMessages?.appendChild(typingEl);
            chatMessages?.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }

        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }

        async function sendChatMessage() {
            if (!chatInput || chatIsLoading) return;

            const query = chatInput.value.trim();
            if (!query) return;

            chatIsLoading = true;
            chatInput.value = '';
            chatSend.disabled = true;

            addChatMessage(query, true);
            showTypingIndicator();

            // Build context for the query
            let contextParts = [`User query: ${query}`];
            if (chatCurrentEntry?.entry) {
                const entry = chatCurrentEntry.entry;
                contextParts.push(`Current entry: ${entry.name || entry.id}`);
                contextParts.push(`Category: ${chatCurrentEntry.category}`);
                if (entry.description) contextParts.push(`Description: ${entry.description}`);
            }

            const systemPrompt = `You are ICEBURG, an expert research assistant specializing in physiology, field-theory biology, celestial-biological correlations, and evidence-based science. You help users understand encyclopedia entries and how different biological systems connect. Be concise but informative. Use clear, professional language.`;

            const requestBody = {
                query: `${systemPrompt}\n\nContext:\n${contextParts.join('\n')}\n\nRespond helpfully and concisely.`,
                mode: 'chat',
                agent: 'physiology',
                degradation_mode: false,
                settings: {
                    primaryModel: 'llama3:8b',
                    temperature: 0.5,
                    maxTokens: 500
                },
                conversation_id: getOrCreateConversationId(),
                metadata: {
                    source: 'encyclopedia_chat',
                    entry_id: chatCurrentEntry?.entry?.id || null
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                removeTypingIndicator();

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const content = data.result || data.content || data.results?.content || 'I apologize, I was unable to generate a response.';
                addChatMessage(content);
            } catch (error) {
                removeTypingIndicator();
                console.error('Chat error:', error);
                addChatMessage('I encountered an error connecting to the ICEBURG system. Please try again.');
            } finally {
                chatIsLoading = false;
                chatSend.disabled = false;
                chatInput?.focus();
            }
        }

        chatBubble?.addEventListener('click', () => {
            chatBubble.classList.add('hidden');
            chatPanel?.classList.add('active');
            chatInput?.focus();
        });

        chatClose?.addEventListener('click', () => {
            chatPanel?.classList.remove('active');
            setTimeout(() => chatBubble?.classList.remove('hidden'), 300);
        });

        chatSend?.addEventListener('click', sendChatMessage);

        chatInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // Auto-resize input
        chatInput?.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
        });

        // Hook into entry modal to update chat context (chain after research leads wrapper)
        const openEntryModalWithResearchLeads = window.openEntryModal;
        window.openEntryModal = function (itemId, categoryId) {
            if (openEntryModalWithResearchLeads) {
                openEntryModalWithResearchLeads(itemId, categoryId);
            }
            // Update chat context with current entry
            const data = window.encyclopediaData || encyclopediaData;
            if (data?.[categoryId]?.[itemId]) {
                updateChatContext(
                    { id: itemId, ...data[categoryId][itemId] },
                    categoryId
                );
            }
        };

        // ========== RESEARCH TOOLS ==========

        // Learning Progress State (persisted in LocalStorage)
        const learningProgress = {
            entriesViewed: new Set(JSON.parse(localStorage.getItem('iceburg_entriesViewed') || '[]')),
            categoriesExplored: new Set(JSON.parse(localStorage.getItem('iceburg_categoriesExplored') || '[]')),
            startTime: Date.now(),
            totalFocusTime: parseInt(localStorage.getItem('iceburg_focusTime') || '0'),

            recordView(entryId, categoryId) {
                this.entriesViewed.add(entryId);
                this.categoriesExplored.add(categoryId);
                this.save();
                updateProgressDashboard();
            },

            save() {
                localStorage.setItem('iceburg_entriesViewed', JSON.stringify([...this.entriesViewed]));
                localStorage.setItem('iceburg_categoriesExplored', JSON.stringify([...this.categoriesExplored]));
                localStorage.setItem('iceburg_focusTime', this.totalFocusTime.toString());
            }
        };

        // Selected entries for comparison
        let selectedEntries = [];

        // Comparison View
        const compareBtn = document.getElementById('compareBtn');
        const compareCount = document.getElementById('compareCount');
        const comparisonModal = document.getElementById('comparisonModal');
        const comparisonClose = document.getElementById('comparisonClose');
        const comparisonBody = document.getElementById('comparisonBody');

        function toggleEntrySelection(entryId, categoryId, element) {
            const idx = selectedEntries.findIndex(e => e.id === entryId);
            if (idx >= 0) {
                selectedEntries.splice(idx, 1);
                element.classList.remove('selected');
            } else if (selectedEntries.length < 3) {
                selectedEntries.push({ id: entryId, category: categoryId });
                element.classList.add('selected');
            }
            updateCompareButton();
        }

        function updateCompareButton() {
            compareCount.textContent = selectedEntries.length;
            compareBtn.disabled = selectedEntries.length < 2;
            compareBtn.classList.toggle('active', selectedEntries.length >= 2);
        }

        compareBtn?.addEventListener('click', () => {
            if (selectedEntries.length < 2) return;
            openComparisonView();
        });

        function openComparisonView() {
            const data = window.encyclopediaData || encyclopediaData;
            if (!data) return;

            const numCols = selectedEntries.length;
            comparisonBody.style.gridTemplateColumns = `repeat(${numCols}, 1fr)`;
            comparisonBody.innerHTML = '';

            const fields = ['name', 'description', 'mechanism', 'effects', 'related_entries', 'sources'];

            selectedEntries.forEach(({ id, category }) => {
                const entry = data[category]?.[id];
                if (!entry) return;

                const col = document.createElement('div');
                col.className = 'comparison-column';
                col.innerHTML = `
                    <div class="comparison-column-header">
                        <h3>${entry.name || id}</h3>
                        <div class="category">${category.replace(/_/g, ' ')}</div>
                    </div>
                    ${fields.map(field => `
                        <div class="comparison-field">
                            <div class="comparison-field-label">${field.replace(/_/g, ' ')}</div>
                            <div class="comparison-field-value">${formatFieldValue(entry[field])}</div>
                        </div>
                    `).join('')}
                `;
                comparisonBody.appendChild(col);
            });

            comparisonModal.classList.add('active');
        }

        function formatFieldValue(value) {
            if (value === undefined || value === null) return '<span style="opacity:0.4"></span>';
            if (Array.isArray(value)) return value.slice(0, 5).join(', ') + (value.length > 5 ? '...' : '');
            if (typeof value === 'object') return JSON.stringify(value).slice(0, 100);
            return String(value).slice(0, 200);
        }

        comparisonClose?.addEventListener('click', () => {
            comparisonModal.classList.remove('active');
        });

        // Citation Generator
        const citationModal = document.getElementById('citationModal');
        const citationClose = document.getElementById('citationClose');
        const citationTabs = document.querySelectorAll('.citation-tab');
        const citationText = document.getElementById('citationText');
        const citationCopy = document.getElementById('citationCopy');
        let currentCitationEntry = null;
        let currentCitationFormat = 'bibtex';

        function openCitationModal(entry, categoryId) {
            currentCitationEntry = { ...entry, category: categoryId };
            updateCitation();
            citationModal.classList.add('active');
        }

        function updateCitation() {
            if (!currentCitationEntry) return;
            const { name, id, category, sources } = currentCitationEntry;
            const year = new Date().getFullYear();
            const source = sources?.[0] || 'Celestial Encyclopedia';

            if (currentCitationFormat === 'bibtex') {
                citationText.textContent = `@misc{${id.toLowerCase().replace(/[^a-z0-9]/g, '_')},
  title = {${name || id}},
  author = {ICEBURG Research Database},
  year = {${year}},
  howpublished = {Celestial Encyclopedia},
  note = {Category: ${category.replace(/_/g, ' ')}}
}`;
            } else if (currentCitationFormat === 'apa') {
                citationText.textContent = `ICEBURG Research Database. (${year}). ${name || id}. In Celestial Encyclopedia. Retrieved from ${window.location.origin}/encyclopedia`;
            } else if (currentCitationFormat === 'mla') {
                citationText.textContent = `"${name || id}." Celestial Encyclopedia, ICEBURG Research Database, ${year}, ${window.location.origin}/encyclopedia.`;
            }
        }

        citationTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                citationTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCitationFormat = tab.dataset.format;
                updateCitation();
            });
        });

        citationCopy?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(citationText.textContent);
                citationCopy.classList.add('copied');
                citationCopy.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!`;
                setTimeout(() => {
                    citationCopy.classList.remove('copied');
                    citationCopy.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy to Clipboard`;
                }, 2000);
            } catch (e) {
                console.error('Copy failed:', e);
            }
        });

        citationClose?.addEventListener('click', () => citationModal.classList.remove('active'));

        // Data Export
        const exportBtn = document.getElementById('exportBtn');

        exportBtn?.addEventListener('click', () => {
            const data = window.encyclopediaData || encyclopediaData;
            if (!data) return;

            const format = confirm('Click OK for JSON, Cancel for CSV') ? 'json' : 'csv';

            if (format === 'json') {
                downloadFile('encyclopedia_export.json', JSON.stringify(data, null, 2), 'application/json');
            } else {
                const rows = [['ID', 'Name', 'Category', 'Description', 'Sources']];
                Object.entries(data).forEach(([cat, entries]) => {
                    if (cat === 'metadata') return;
                    Object.entries(entries || {}).forEach(([id, entry]) => {
                        rows.push([
                            id,
                            entry.name || '',
                            cat,
                            (entry.description || '').replace(/"/g, '""'),
                            (entry.sources || []).join('; ')
                        ]);
                    });
                });
                const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
                downloadFile('encyclopedia_export.csv', csv, 'text/csv');
            }
        });

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Session Timer (Pomodoro)
        const sessionTimer = document.getElementById('sessionTimer');
        const timerBtn = document.getElementById('timerBtn');
        const timerClose = document.getElementById('timerClose');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerStart = document.getElementById('timerStart');
        const timerReset = document.getElementById('timerReset');
        const timerPresets = document.querySelectorAll('.timer-preset');
        const totalFocusTime = document.getElementById('totalFocusTime');

        let timerInterval = null;
        let timerSeconds = 25 * 60;
        let timerRunning = false;
        let isBreak = false;
        let workMinutes = 25;
        let breakMinutes = 5;

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(timerSeconds);
            timerDisplay.classList.toggle('break', isBreak);
        }

        timerBtn?.addEventListener('click', () => sessionTimer.classList.toggle('active'));
        timerClose?.addEventListener('click', () => sessionTimer.classList.remove('active'));

        timerStart?.addEventListener('click', () => {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerStart.textContent = 'Resume';
                timerRunning = false;
            } else {
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    if (!isBreak) learningProgress.totalFocusTime++;
                    updateTimerDisplay();
                    updateTotalFocusDisplay();

                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        learningProgress.save();
                        if (isBreak) {
                            isBreak = false;
                            timerSeconds = workMinutes * 60;
                            alert('Break over! Time to focus.');
                        } else {
                            isBreak = true;
                            timerSeconds = breakMinutes * 60;
                            alert('Great work! Take a break.');
                        }
                        updateTimerDisplay();
                        timerStart.textContent = 'Start';
                        timerRunning = false;
                    }
                }, 1000);
                timerStart.textContent = 'Pause';
                timerRunning = true;
            }
        });

        timerReset?.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerRunning = false;
            isBreak = false;
            timerSeconds = workMinutes * 60;
            timerStart.textContent = 'Start';
            updateTimerDisplay();
        });

        timerPresets.forEach(preset => {
            preset.addEventListener('click', () => {
                timerPresets.forEach(p => p.classList.remove('active'));
                preset.classList.add('active');
                workMinutes = parseInt(preset.dataset.work);
                breakMinutes = parseInt(preset.dataset.break);
                timerSeconds = workMinutes * 60;
                isBreak = false;
                updateTimerDisplay();
            });
        });

        function updateTotalFocusDisplay() {
            const mins = Math.floor(learningProgress.totalFocusTime / 60);
            totalFocusTime.textContent = mins >= 60 ? `${Math.floor(mins / 60)}h ${mins % 60}m` : `${mins}m`;
        }
        updateTotalFocusDisplay();

        // Progress Dashboard
        const dashboardBtn = document.getElementById('dashboardBtn');
        const progressDashboard = document.getElementById('progressDashboard');
        const dashboardClose = document.getElementById('dashboardClose');

        dashboardBtn?.addEventListener('click', () => {
            progressDashboard.classList.toggle('active');
            updateProgressDashboard();
        });
        dashboardClose?.addEventListener('click', () => progressDashboard.classList.remove('active'));

        function updateProgressDashboard() {
            const entriesViewed = document.getElementById('entriesViewed');
            const categoriesExplored = document.getElementById('categoriesExplored');
            const timeSpent = document.getElementById('timeSpent');
            const categoryProgressList = document.getElementById('categoryProgressList');

            if (entriesViewed) entriesViewed.textContent = learningProgress.entriesViewed.size;
            if (categoriesExplored) categoriesExplored.textContent = learningProgress.categoriesExplored.size;

            const mins = Math.floor((Date.now() - learningProgress.startTime) / 60000);
            if (timeSpent) timeSpent.textContent = mins >= 60 ? `${Math.floor(mins / 60)}h ${mins % 60}m` : `${mins}m`;

            // Category progress bars
            const data = window.encyclopediaData || encyclopediaData;
            if (data && categoryProgressList) {
                categoryProgressList.innerHTML = '';
                const viewedByCategory = {};
                learningProgress.entriesViewed.forEach(id => {
                    Object.keys(data).forEach(cat => {
                        if (cat !== 'metadata' && data[cat]?.[id]) {
                            viewedByCategory[cat] = (viewedByCategory[cat] || 0) + 1;
                        }
                    });
                });

                Object.keys(data).slice(0, 6).forEach(cat => {
                    if (cat === 'metadata') return;
                    const total = Object.keys(data[cat] || {}).length;
                    const viewed = viewedByCategory[cat] || 0;
                    const pct = total > 0 ? Math.round((viewed / total) * 100) : 0;

                    categoryProgressList.innerHTML += `
                        <div class="category-progress">
                            <div class="category-progress-info">
                                <div class="category-progress-name">${cat.replace(/_/g, ' ')}</div>
                                <div class="category-progress-bar">
                                    <div class="category-progress-fill" style="width: ${pct}%"></div>
                                </div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-tertiary);">${viewed}/${total}</span>
                        </div>
                    `;
                });
            }

            // Knowledge gap suggestions
            updateKnowledgeGaps();
        }

        function updateKnowledgeGaps() {
            const knowledgeGapList = document.getElementById('knowledgeGapList');
            if (!knowledgeGapList) return;

            const data = window.encyclopediaData || encyclopediaData;
            if (!data) return;

            const suggestions = [];
            const viewed = learningProgress.entriesViewed;

            // Find related entries that user hasn't viewed
            viewed.forEach(viewedId => {
                Object.keys(data).forEach(cat => {
                    if (cat === 'metadata') return;
                    const entry = data[cat]?.[viewedId];
                    if (entry?.related_entries) {
                        entry.related_entries.forEach(relatedId => {
                            if (!viewed.has(relatedId) && suggestions.length < 3) {
                                // Find the related entry
                                Object.keys(data).forEach(c => {
                                    if (data[c]?.[relatedId]) {
                                        suggestions.push({
                                            id: relatedId,
                                            category: c,
                                            name: data[c][relatedId].name || relatedId,
                                            reason: `Related to ${entry.name || viewedId}`
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            });

            knowledgeGapList.innerHTML = suggestions.slice(0, 3).map(s => `
                <div class="gap-suggestion" onclick="openEntryModal('${s.id}', '${s.category}')">
                    <div class="gap-suggestion-title">${s.name}</div>
                    <div class="gap-suggestion-reason">${s.reason}</div>
                </div>
            `).join('') || '<div style="font-size: 0.8rem; color: var(--text-tertiary);">View some entries to get suggestions</div>';
        }

        // Hook into modal opening to track progress and add cite button
        const openEntryModalWithTracking = window.openEntryModal;
        window.openEntryModal = function (itemId, categoryId) {
            if (openEntryModalWithTracking) {
                openEntryModalWithTracking(itemId, categoryId);
            }
            learningProgress.recordView(itemId, categoryId);

            // Add cite button to modal after render
            setTimeout(() => {
                const modalHeader = document.querySelector('.entry-modal-header');
                if (modalHeader && !document.getElementById('modalCiteBtn')) {
                    const data = window.encyclopediaData || encyclopediaData;
                    const entry = data?.[categoryId]?.[itemId];
                    if (entry) {
                        const citeBtn = document.createElement('button');
                        citeBtn.id = 'modalCiteBtn';
                        citeBtn.className = 'research-btn';
                        citeBtn.innerHTML = ' Cite';
                        citeBtn.style.marginLeft = 'auto';
                        citeBtn.onclick = () => openCitationModal({ ...entry, id: itemId }, categoryId);
                        modalHeader.appendChild(citeBtn);
                    }
                }
            }, 100);
        };

        // Initialize dashboard on load
        updateProgressDashboard();
        updateTimerDisplay();

    </script>
</body>

</html>
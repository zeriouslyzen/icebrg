<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Crawler | ICEBURG</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Matrix Crawler specific styles */
        .matrix-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color, #333);
        }

        .matrix-header h1 {
            font-size: 2rem;
            color: var(--accent-primary, #00d4ff);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .matrix-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface-color, #1a1a24);
            border: 1px solid var(--border-color, #333);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-primary, #00d4ff);
        }

        .stat-card .label {
            color: var(--text-secondary, #888);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .source-card {
            background: var(--surface-color, #1a1a24);
            border: 1px solid var(--border-color, #333);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .source-card:hover {
            border-color: var(--accent-primary, #00d4ff);
            transform: translateY(-2px);
        }

        .source-card .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .source-card .name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .source-card .status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.idle {
            background: #333;
            color: #888;
        }

        .status.running {
            background: #00d4ff22;
            color: #00d4ff;
        }

        .status.completed {
            background: #10b98122;
            color: #10b981;
        }

        .status.failed {
            background: #ef444422;
            color: #ef4444;
        }

        .source-card .description {
            color: var(--text-secondary, #888);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .source-card .progress-bar {
            height: 4px;
            background: var(--border-color, #333);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .source-card .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary, #00d4ff), var(--accent-secondary, #8b5cf6));
            transition: width 0.3s ease;
        }

        .source-card .meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-tertiary, #666);
            margin-bottom: 1rem;
        }

        .source-card .actions {
            display: flex;
            gap: 0.5rem;
        }

        .source-card .actions button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-primary, #00d4ff);
            color: #000;
        }

        .btn-primary:hover {
            background: #00b8e0;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color, #333) !important;
            color: var(--text-secondary, #888);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary, #00d4ff) !important;
            color: var(--accent-primary, #00d4ff);
        }

        .btn-danger {
            background: #ef444422;
            color: #ef4444;
        }

        .btn-danger:hover {
            background: #ef444444;
        }

        /* Jobs section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0 1rem;
        }

        .section-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary, #fff);
        }

        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-color, #1a1a24);
            border-radius: 12px;
            overflow: hidden;
        }

        .jobs-table th,
        .jobs-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #333);
        }

        .jobs-table th {
            background: var(--surface-elevated, #22222c);
            color: var(--text-secondary, #888);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .jobs-table tbody tr:hover {
            background: var(--surface-elevated, #22222c);
        }

        /* Entity search */
        .search-container {
            margin: 2rem 0;
        }

        .search-box {
            display: flex;
            gap: 1rem;
        }

        .search-box input {
            flex: 1;
            padding: 1rem;
            background: var(--surface-color, #1a1a24);
            border: 1px solid var(--border-color, #333);
            border-radius: 8px;
            color: var(--text-primary, #fff);
            font-size: 1rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary, #00d4ff);
        }

        .search-results {
            margin-top: 1rem;
        }

        .entity-card {
            background: var(--surface-color, #1a1a24);
            border: 1px solid var(--border-color, #333);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entity-card .name {
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .entity-card .type {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background: var(--accent-primary, #00d4ff)22;
            color: var(--accent-primary, #00d4ff);
            border-radius: 4px;
        }

        /* Schedule section */
        .schedule-form {
            background: var(--surface-color, #1a1a24);
            border: 1px solid var(--border-color, #333);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary, #888);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--background-color, #0a0a0f);
            border: 1px solid var(--border-color, #333);
            border-radius: 8px;
            color: var(--text-primary, #fff);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--surface-color, #1a1a24);
            border: 1px solid var(--accent-primary, #00d4ff);
            border-radius: 8px;
            color: var(--text-primary, #fff);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="matrix-container">
        <!-- Header -->
        <header class="matrix-header">
            <h1>üï∏Ô∏è Matrix Crawler</h1>
            <div>
                <button class="btn-primary" onclick="crawlAll()" id="crawlAllBtn">
                    ‚ñ∂Ô∏è Run All Crawlers
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="matrix-stats" id="statsContainer">
            <div class="stat-card">
                <div class="value" id="totalEntities">-</div>
                <div class="label">Total Entities</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalRelationships">-</div>
                <div class="label">Relationships</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalDocuments">-</div>
                <div class="label">Documents</div>
            </div>
            <div class="stat-card">
                <div class="value" id="activeCrawlers">-</div>
                <div class="label">Active Crawlers</div>
            </div>
        </div>

        <!-- Data Sources -->
        <div class="section-header">
            <h2>üìä Data Sources</h2>
        </div>
        <div class="sources-grid" id="sourcesGrid">
            <!-- Populated by JavaScript -->
            <div class="source-card">
                <div class="header">
                    <span class="name">Loading...</span>
                    <span class="status idle">Loading</span>
                </div>
                <div class="description">Fetching available data sources...</div>
            </div>
        </div>

        <!-- Search Entities -->
        <div class="section-header">
            <h2>üîç Search Entities</h2>
        </div>
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search for people, companies, organizations..."
                    onkeyup="if(event.key==='Enter') searchEntities()">
                <button class="btn-primary" onclick="searchEntities()">Search</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Recent Jobs -->
        <div class="section-header">
            <h2>üìã Recent Jobs</h2>
            <button class="btn-secondary" onclick="loadJobs()">Refresh</button>
        </div>
        <table class="jobs-table">
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>Source</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Entities</th>
                    <th>Started</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="jobsTable">
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-secondary);">Loading jobs...</td>
                </tr>
            </tbody>
        </table>

        <!-- Schedules -->
        <div class="section-header">
            <h2>‚è∞ Scheduled Crawls</h2>
            <button class="btn-secondary" onclick="toggleScheduleForm()">+ Add Schedule</button>
        </div>
        <div class="schedule-form" id="scheduleForm" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label>Data Source</label>
                    <select id="scheduleSource">
                        <option value="fec">FEC Campaign Finance</option>
                        <option value="icij">ICIJ Offshore Leaks</option>
                        <option value="opensanctions">OpenSanctions</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Schedule Type</label>
                    <select id="scheduleType">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="interval">Interval (minutes)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Run At (Hour)</label>
                    <input type="number" id="scheduleHour" value="0" min="0" max="23">
                </div>
            </div>
            <button class="btn-primary" onclick="createSchedule()">Create Schedule</button>
        </div>
        <div id="schedulesList" style="margin-top: 1rem;"></div>
    </div>

    <script>
        const API_BASE = '/api/matrix';

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadSources();
            loadJobs();
            loadSchedules();

            // Auto-refresh every 30 seconds (was 5s, caused rate limiting)
            setInterval(() => {
                loadStatus();
                loadJobs();
            }, 30000);
        });

        // Load status and stats
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();

                document.getElementById('totalEntities').textContent = formatNumber(data.total_entities || 0);
                document.getElementById('totalRelationships').textContent = formatNumber(data.total_relationships || 0);
                document.getElementById('totalDocuments').textContent = formatNumber(data.total_documents || 0);
                document.getElementById('activeCrawlers').textContent = data.sources_active || 0;
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        // Load available sources
        async function loadSources() {
            try {
                const response = await fetch(`${API_BASE}/sources`);
                const data = await response.json();

                // Also get stats for entity counts
                const statsResponse = await fetch(`${API_BASE}/status`);
                const statsData = await statsResponse.json();
                const byType = statsData.by_type || {};
                const totalEntities = statsData.total_entities || 0;

                const grid = document.getElementById('sourcesGrid');
                grid.innerHTML = data.sources.map(source => {
                    // Calculate entity count for this source
                    let entityCount = 0;
                    if (source.id === 'opensanctions' && totalEntities > 0) {
                        entityCount = totalEntities;
                    }

                    return `
                    <div class="source-card" data-source="${source.id}">
                        <div class="header">
                            <span class="name">${source.name}</span>
                            <span class="status ${source.available ? 'idle' : 'failed'}">
                                ${source.available ? 'Ready' : 'Unavailable'}
                            </span>
                        </div>
                        <div class="description">${source.description}</div>
                        <div class="progress-bar">
                            <div class="fill" style="width: ${entityCount > 0 ? '100' : '0'}%"></div>
                        </div>
                        <div class="meta">
                            <span>Update: ${source.update_frequency}</span>
                            <span class="entities-count">${entityCount > 0 ? formatNumber(entityCount) + ' entities' : 'Not imported'}</span>
                        </div>
                        <div class="actions">
                            <button class="btn-primary" onclick="startCrawl('${source.id}')" ${!source.available ? 'disabled' : ''}>
                                ‚ñ∂Ô∏è Run
                            </button>
                            <button class="btn-secondary" onclick="viewSource('${source.id}')">
                                View Data
                            </button>
                        </div>
                    </div>
                `}).join('');
            } catch (error) {
                console.error('Failed to load sources:', error);
            }
        }

        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch(`${API_BASE}/jobs?limit=10`);
                const data = await response.json();

                const tbody = document.getElementById('jobsTable');

                if (data.jobs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: var(--text-secondary);">
                                No jobs yet. Start a crawler to begin.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.jobs.map(job => `
                    <tr>
                        <td><code>${job.job_id.slice(0, 20)}...</code></td>
                        <td>${job.source}</td>
                        <td><span class="status ${job.status}">${job.status}</span></td>
                        <td>${Math.round(job.progress * 100)}%</td>
                        <td>${job.entities_extracted}</td>
                        <td>${formatTime(job.started_at)}</td>
                        <td>
                            ${job.status === 'running' ?
                        `<button class="btn-danger" onclick="stopJob('${job.job_id}')">Stop</button>` :
                        '‚Äî'
                    }
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }

        // Load schedules
        async function loadSchedules() {
            try {
                const response = await fetch(`${API_BASE}/schedules`);
                const data = await response.json();

                const container = document.getElementById('schedulesList');

                if (data.schedules.length === 0) {
                    container.innerHTML = `
                        <p style="color: var(--text-secondary); text-align: center;">
                            No scheduled crawls. Click "Add Schedule" to create one.
                        </p>
                    `;
                    return;
                }

                container.innerHTML = data.schedules.map(schedule => `
                    <div class="entity-card">
                        <div>
                            <span class="name">${schedule.source}</span>
                            <span style="color: var(--text-secondary); margin-left: 1rem;">
                                ${schedule.schedule_type} @ ${schedule.run_at_hour}:${String(schedule.run_at_minute).padStart(2, '0')}
                            </span>
                        </div>
                        <div>
                            <span class="type">${schedule.enabled ? 'Enabled' : 'Disabled'}</span>
                            <button class="btn-danger" style="margin-left: 0.5rem;" onclick="deleteSchedule('${schedule.schedule_id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load schedules:', error);
            }
        }

        // Start a crawl
        async function startCrawl(source) {
            try {
                showToast(`Starting ${source} crawler...`);

                const response = await fetch(`${API_BASE}/crawl/${source}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ options: {} })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ Crawler started: ${data.job_id}`);
                    loadJobs();
                    loadStatus();
                } else {
                    showToast(`‚ùå Failed: ${data.detail}`);
                }
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        // Crawl all sources
        async function crawlAll() {
            try {
                showToast('Starting all crawlers...');

                const response = await fetch(`${API_BASE}/crawl/all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ options: {} })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ Started ${data.jobs.length} crawlers`);
                    loadJobs();
                    loadStatus();
                } else {
                    showToast(`‚ùå Failed: ${data.detail}`);
                }
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        // Stop a job
        async function stopJob(jobId) {
            try {
                const response = await fetch(`${API_BASE}/crawl/${jobId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('‚úÖ Job stopped');
                    loadJobs();
                }
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        // Search entities
        async function searchEntities() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            try {
                const response = await fetch(`${API_BASE}/entities/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 20 })
                });

                const data = await response.json();

                const container = document.getElementById('searchResults');

                if (data.results.length === 0) {
                    container.innerHTML = `
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            No entities found for "${query}"
                        </p>
                    `;
                    return;
                }

                container.innerHTML = data.results.map(entity => `
                    <div class="entity-card">
                        <div>
                            <span class="name">${entity.name}</span>
                            <span style="color: var(--text-secondary); margin-left: 1rem; font-size: 0.85rem;">
                                ${entity.countries && entity.countries.length > 0 ? entity.countries.map(c => getFlagEmoji(c)).join(' ') : ''} 
                                ${entity.source || 'Unknown'}
                            </span>
                        </div>
                        <span class="type">${entity.entity_type}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        // Toggle schedule form
        function toggleScheduleForm() {
            const form = document.getElementById('scheduleForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // Create schedule
        async function createSchedule() {
            const source = document.getElementById('scheduleSource').value;
            const scheduleType = document.getElementById('scheduleType').value;
            const runAtHour = parseInt(document.getElementById('scheduleHour').value);

            try {
                const response = await fetch(`${API_BASE}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source,
                        schedule_type: scheduleType,
                        run_at_hour: runAtHour,
                        run_at_minute: 0
                    })
                });

                if (response.ok) {
                    showToast('‚úÖ Schedule created');
                    loadSchedules();
                    toggleScheduleForm();
                }
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        // Delete schedule
        async function deleteSchedule(scheduleId) {
            try {
                const response = await fetch(`${API_BASE}/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('‚úÖ Schedule deleted');
                    loadSchedules();
                }
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        // View source data
        function viewSource(source) {
            // TODO: Navigate to detailed view
            showToast(`Viewing ${source} data...`);
        }

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatTime(isoString) {
            if (!isoString) return '‚Äî';
            const date = new Date(isoString);
            return date.toLocaleTimeString();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Convert country code to flag emoji
        function getFlagEmoji(countryCode) {
            if (!countryCode || countryCode.length !== 2) return '';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }
    </script>
</body>

</html>